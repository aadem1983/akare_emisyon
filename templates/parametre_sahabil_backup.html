{% extends "base.html" %}

{% block title %}Parametre Sahabil{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-flask me-2"></i>
                    Parametre Sahabil
                </h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm" onclick="exportSelected()">
                        <i class="fas fa-download me-1"></i>Seçilenleri Dışa Aktar
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="importData()">
                        <i class="fas fa-upload me-1"></i>İçe Aktar
                    </button>
                    <button type="button" class="btn btn-info btn-sm" onclick="exportAll()">
                        <i class="fas fa-download me-1"></i>Tümünü Dışa Aktar
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                        <i class="fas fa-trash me-1"></i>Seçilenleri Sil
                    </button>
                </div>
            </div>

            <!-- Parametre Seçimi -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Parametre Seçimi ve Ölçüm Formu
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="parametreSelect" class="form-label fw-bold">Parametre Seçin:</label>
                                <select class="form-select" id="parametreSelect" onchange="loadParametreForm()">
                                    <option value="">Parametre seçin...</option>
                                    {% for param in parameters %}
                                    <option value="{{ param.id }}">{{ param['Parametre Adı'] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parametre Ölçüm Formu -->
                    <div id="parametreOlcumForm" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-edit me-2"></i>
                                    <span id="selectedParametreName">Seçilen Parametre</span> - Ölçüm Bilgileri
                                </h6>
                            </div>
                            <div class="card-body">
                                <form id="parametreOlcumFormElement">
                                    <div class="row" id="parametreOlcumFields">
                                        <!-- Parametre ölçüm alanları dinamik olarak yüklenecek -->
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-warning" onclick="saveParametreOlcum()">
                                                <i class="fas fa-save me-1"></i>Ölçümü Kaydet
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kayıtlı Ölçümler Tablosu -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Kayıtlı Parametre Ölçümleri
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="parametreOlcumTable">
                            <thead class="table-dark" id="parametreOlcumTableHead">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th width="60">#</th>
                                    <th>Parametre Türü/Adı</th>
                                    <th>Ölçüm Tarihi</th>
                                    <th>Ölçüm Değerleri</th>
                                    <th>Birim</th>
                                    <th>Kaynak</th>
                                    <th width="120">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="parametreOlcumTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        Henüz parametre ölçümü kaydı bulunmuyor
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İçe Aktarma Modalı -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Veri İçe Aktar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importForm">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Excel Dosyası Seçin:</label>
                        <div class="drop-zone" id="dropZone">
                            <div class="drop-zone-content">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-2">Dosyayı buraya sürükleyip bırakın</p>
                                <p class="text-muted small">veya</p>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('importFile').click()">
                                    Dosya Seç
                                </button>
                            </div>
                            <input type="file" class="form-control d-none" id="importFile" accept=".xlsx,.xls" required>
                        </div>
                        <div id="fileInfo" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-file-excel me-2"></i>
                                <span id="fileName"></span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="processImport()" id="importBtn" disabled>İçe Aktar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.drop-zone {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.drop-zone.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
    transform: scale(1.02);
}

.drop-zone-content {
    pointer-events: none;
}

.drop-zone-content button {
    pointer-events: all;
}
</style>

<script>
// Sürükle-bırak işlevselliği
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('importFile');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const importBtn = document.getElementById('importBtn');

    // Sürükle olayları
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || 
                file.type === 'application/vnd.ms-excel' ||
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                
                fileInput.files = files;
                handleFileSelect(file);
            } else {
                alert('Lütfen sadece Excel dosyası (.xlsx veya .xls) seçin!');
            }
        }
    });

    // Dosya seçimi
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        fileName.textContent = file.name;
        fileInfo.style.display = 'block';
        importBtn.disabled = false;
        dropZone.style.borderColor = '#28a745';
        dropZone.style.backgroundColor = '#d4edda';
    }
});

// Parametre formunu yükle
function loadParametreForm() {
    const parametreSelect = document.getElementById('parametreSelect');
    const selectedParametreId = parametreSelect.value;
    const selectedParametreName = parametreSelect.options[parametreSelect.selectedIndex].text;
    
    if (!selectedParametreId) {
        document.getElementById('parametreOlcumForm').style.display = 'none';
        return;
    }
    
    // Seçilen parametre adını güncelle
    document.getElementById('selectedParametreName').textContent = selectedParametreName;
    
    // Formu göster
    document.getElementById('parametreOlcumForm').style.display = 'block';
    
    // Parametre ölçüm alanlarını oluştur
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    parametreOlcumFields.innerHTML = '';
    
    // Tablo başlıklarını güncelle
    updateTableHeaders(selectedParametreName);
    
    // Özel parametreler listesi (yg-voc-toc-pm10-ctoz dışındakiler için özel form)
    const specialParams = ['yg', 'voc', 'toc', 'pm10', 'ctoz'];
    const isSpecialParam = specialParams.some(param => selectedParametreName.toLowerCase().includes(param));
    
    if (isSpecialParam) {
        // Özel parametreler için basit form
        createSimpleForm(parametreOlcumFields);
    } else {
        // Diğer parametreler için detaylı form (görüntüdeki tablo gibi)
        createDetailedForm(parametreOlcumFields, selectedParametreName);
    }
}

// Tablo başlıklarını güncelle
function updateTableHeaders(parametreName) {
    const tableHead = document.getElementById('parametreOlcumTableHead');
    const tableBody = document.getElementById('parametreOlcumTableBody');
    
    if (parametreName.toLowerCase().includes('yg')) {
        // YG parametresi için özel başlıklar
        tableHead.innerHTML = `
            <tr>
                <th width="50">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th width="60">#</th>
                <th>TARİH</th>
                <th>B.SIC</th>
                <th>O2</th>
                <th>CO</th>
                <th>NO</th>
                <th>NOX</th>
                <th>SO2</th>
                <th>KK1-O2</th>
                <th>KK1-CO</th>
                <th>KK1-NO</th>
                <th>KK1-SO2</th>
                <th>KK2-O2</th>
                <th>KK2-CO</th>
                <th>KK2-NO</th>
                <th>KK2-SO2</th>
                <th>T90</th>
                <th width="120">İşlemler</th>
            </tr>
        `;
        
        // Boş mesajı güncelle
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="19" class="text-center text-muted">
                        Henüz parametre ölçümü kaydı bulunmuyor
                    </td>
                </tr>
            `;
        }
    } else {
        // Standart başlıklar
        tableHead.innerHTML = `
            <tr>
                <th width="50">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th width="60">#</th>
                <th>Parametre Türü/Adı</th>
                <th>Ölçüm Tarihi</th>
                <th>Ölçüm Değerleri</th>
                <th>Birim</th>
                <th>Kaynak</th>
                <th width="120">İşlemler</th>
            </tr>
        `;
        
        // Boş mesajı güncelle
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        Henüz parametre ölçümü kaydı bulunmuyor
                    </td>
                </tr>
            `;
        }
    }
}

// Basit form oluştur (yg-voc-toc-pm10-ctoz için)
function createSimpleForm(container) {
    // YG parametresi için özel alanlar
    const selectedParametreName = document.getElementById('selectedParametreName').textContent;
    
    if (selectedParametreName.toLowerCase().includes('yg')) {
        createYGForm(container);
        return;
    }
    
    // Diğer basit parametreler için standart alanlar
    const fields = [
        { name: 'olcum_tarihi', label: 'Ölçüm Tarihi', type: 'date', required: true },
        { name: 'olcum_saati', label: 'Ölçüm Saati', type: 'time', required: true },
        { name: 'olcum_degeri', label: 'Ölçüm Değeri', type: 'number', step: '0.01', required: true },
        { name: 'birim', label: 'Birim', type: 'select', options: ['mg/m³', 'μg/m³', 'ppm', 'ppb', '%'], required: true },
        { name: 'notlar', label: 'Notlar', type: 'textarea', required: false }
    ];
    
    fields.forEach((field, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 mb-3';
        
        let inputHtml = '';
        if (field.type === 'textarea') {
            inputHtml = `<textarea class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} rows="3" placeholder="${field.label}"></textarea>`;
        } else if (field.type === 'select') {
            inputHtml = `<select class="form-select" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''}>
                <option value="">Seçin...</option>`;
            field.options.forEach(option => {
                inputHtml += `<option value="${option}">${option}</option>`;
            });
            inputHtml += '</select>';
        } else {
            inputHtml = `<input type="${field.type}" class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">`;
        }
        
        col.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}:</label>
            ${inputHtml}
        `;
        
        container.appendChild(col);
    });
}

// YG parametresi için özel form alanları
function createYGForm(container) {
    // Başlık
    const headerCol = document.createElement('div');
    headerCol.className = 'col-12 mb-3';
    headerCol.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-flask me-2"></i>
            <strong>YG Parametresi</strong> için özel ölçüm formu
        </div>
    `;
    container.appendChild(headerCol);
    
    // YG parametresi için özel alanlar
    const ygFields = [
        { name: 'tarih', label: 'TARİH', type: 'date', required: true },
        { name: 'b_sic', label: 'B.SIC', type: 'number', step: '0.1', required: false },
        { name: 'o2', label: 'O2', type: 'number', step: '0.01', required: false },
        { name: 'co', label: 'CO', type: 'number', step: '0.01', required: false },
        { name: 'no', label: 'NO', type: 'number', step: '0.01', required: false },
        { name: 'nox', label: 'NOX', type: 'number', step: '0.01', required: false },
        { name: 'so2', label: 'SO2', type: 'number', step: '0.01', required: false },
        { name: 'kk1_o2', label: 'KK1-O2', type: 'number', step: '0.01', required: false },
        { name: 'kk1_co', label: 'KK1-CO', type: 'number', step: '0.01', required: false },
        { name: 'kk1_no', label: 'KK1-NO', type: 'number', step: '0.01', required: false },
        { name: 'kk1_so2', label: 'KK1-SO2', type: 'number', step: '0.01', required: false },
        { name: 'kk2_o2', label: 'KK2-O2', type: 'number', step: '0.01', required: false },
        { name: 'kk2_co', label: 'KK2-CO', type: 'number', step: '0.01', required: false },
        { name: 'kk2_no', label: 'KK2-NO', type: 'number', step: '0.01', required: false },
        { name: 'kk2_so2', label: 'KK2-SO2', type: 'number', step: '0.01', required: false },
        { name: 't90', label: 'T90', type: 'number', step: '0.01', required: false }
    ];
    
    ygFields.forEach((field, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 mb-3';
        
        col.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}:</label>
            <input type="${field.type}" class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">
        `;
        
        container.appendChild(col);
    });
}

// Detaylı form oluştur (diğer parametreler için)
function createDetailedForm(container, parametreName) {
    // Başlık
    const headerCol = document.createElement('div');
    headerCol.className = 'col-12 mb-3';
    headerCol.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>${parametreName}</strong> parametresi için detaylı ölçüm formu
        </div>
    `;
    container.appendChild(headerCol);
    
    // 3 ölçüm için tablo benzeri form
    const measurements = ['1.ÖLÇ.', '2.ÖLÇ.', '3.ÖLÇ.'];
    
    measurements.forEach((measurement, index) => {
        const measurementCol = document.createElement('div');
        measurementCol.className = 'col-12 col-lg-4 mb-4';
        
        const measurementFields = [
            { name: `metot_${index + 1}`, label: 'METOT', type: 'select', options: ['EPA5', 'EPA17', 'TS 9096', 'TS EN13284'], required: false },
            { name: `nozzle_cap_${index + 1}`, label: 'NOZZLE ÇAP', type: 'text', required: false },
            { name: `travers_${index + 1}`, label: 'TRAVERS', type: 'text', required: false },
            { name: `b_hiz_${index + 1}`, label: 'B.HIZ', type: 'number', step: '0.01', required: false },
            { name: `b_sic_${index + 1}`, label: 'B.SIC', type: 'number', step: '0.1', required: false },
            { name: `b_bas_${index + 1}`, label: 'B.BAS(KPA)', type: 'number', step: '0.01', required: false },
            { name: `b_nem_gm3_${index + 1}`, label: 'B.NEM (G/M3)', type: 'number', step: '0.01', required: false },
            { name: `b_nem_yuzde_${index + 1}`, label: 'B.NEM (%)', type: 'number', step: '0.1', required: false },
            { name: `syc_hac_${index + 1}`, label: 'SYC.HAC.', type: 'number', step: '0.01', required: false },
            { name: `syc_ilk_${index + 1}`, label: 'SYC.İLK', type: 'number', step: '0.01', required: false },
            { name: `syc_son_${index + 1}`, label: 'SYC.SON', type: 'number', step: '0.01', required: false },
            { name: `syc_sic_${index + 1}`, label: 'SYC.SIC', type: 'number', step: '0.1', required: false },
            { name: `debi_${index + 1}`, label: 'DEBİ', type: 'number', step: '0.01', required: false },
            { name: `isdl_${index + 1}`, label: 'ISDL', type: 'text', required: false }
        ];
        
        let measurementHtml = `
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">${measurement}</h6>
                </div>
                <div class="card-body">
        `;
        
        measurementFields.forEach(field => {
            let inputHtml = '';
            if (field.type === 'select') {
                inputHtml = `<select class="form-select form-select-sm" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''}>
                    <option value="">Seçin...</option>`;
                field.options.forEach(option => {
                    inputHtml += `<option value="${option}">${option}</option>`;
                });
                inputHtml += '</select>';
            } else {
                inputHtml = `<input type="${field.type}" class="form-control form-control-sm" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">`;
            }
            
            measurementHtml += `
                <div class="mb-2">
                    <label for="${field.name}" class="form-label form-label-sm">${field.label}:</label>
                    ${inputHtml}
                </div>
            `;
        });
        
        measurementHtml += `
                </div>
            </div>
        `;
        
        measurementCol.innerHTML = measurementHtml;
        container.appendChild(measurementCol);
    });
    
    // Tarih alanı
    const dateCol = document.createElement('div');
    dateCol.className = 'col-12 mb-3';
    dateCol.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <label for="olcum_tarihi" class="form-label">TARİH:</label>
                <input type="date" class="form-control" name="olcum_tarihi" id="olcum_tarihi" required>
            </div>
            <div class="col-md-6">
                <label for="notlar" class="form-label">NOTLAR:</label>
                <textarea class="form-control" name="notlar" id="notlar" rows="3" placeholder="Ölçüm notları..."></textarea>
            </div>
        </div>
    `;
    container.appendChild(dateCol);
}

// Parametre ölçümünü kaydet
function saveParametreOlcum() {
    const parametreSelect = document.getElementById('parametreSelect');
    const selectedParametreId = parametreSelect.value;
    const selectedParametreName = parametreSelect.options[parametreSelect.selectedIndex].text;
    
    if (!selectedParametreId) {
        alert('Lütfen bir parametre seçin!');
        return;
    }
    
    // Form verilerini topla
    const formData = new FormData();
    formData.append('parametre_id', selectedParametreId);
    formData.append('parametre_adi', selectedParametreName);
    
    // Form alanlarını topla
    const formFields = document.querySelectorAll('#parametreOlcumFormElement input, #parametreOlcumFormElement textarea, #parametreOlcumFormElement select');
    formFields.forEach(field => {
        formData.append(field.name, field.value);
    });
    
    // Backend'e gönder
    fetch('/save_parametre_sahabil', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Parametre ölçümü başarıyla kaydedildi!');
            
            // Formu temizle
            document.getElementById('parametreOlcumFormElement').reset();
            parametreSelect.value = '';
            document.getElementById('parametreOlcumForm').style.display = 'none';
            
            // Tabloyu yenile
            loadParametreOlcumTable();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu! Lütfen tekrar deneyin.');
    });
}

// Parametre ölçüm tablosunu yükle
function loadParametreOlcumTable() {
    fetch('/api/parametre_sahabil_list')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('parametreOlcumTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            Henüz parametre ölçümü kaydı bulunmuyor
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach((record, index) => {
                // Ölçüm verilerini formatla
                let olcumBilgisi = '';
                if (record.imported_from_excel) {
                    // Excel'den import edilen veriler için
                    const olcumVerileri = record.olcum_verileri || {};
                    const olcumList = [];
                    if (olcumVerileri.olcum_1) olcumList.push(`1.ÖLÇ: ${olcumVerileri.olcum_1}`);
                    if (olcumVerileri.olcum_2) olcumList.push(`2.ÖLÇ: ${olcumVerileri.olcum_2}`);
                    if (olcumVerileri.olcum_3) olcumList.push(`3.ÖLÇ: ${olcumVerileri.olcum_3}`);
                    olcumBilgisi = olcumList.join(', ');
                } else {
                    // Manuel girilen veriler için
                    olcumBilgisi = record.olcum_degeri || '-';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" value="${record.id}">
                    </td>
                    <td>${index + 1}</td>
                    <td>
                        <strong>${record.parametre_turu || record.parametre_adi}</strong>
                        ${record.parametre_turu && record.parametre_adi ? '<br><small class="text-muted">' + record.parametre_adi + '</small>' : ''}
                    </td>
                    <td>${record.olcum_tarihi || '-'}</td>
                    <td>${olcumBilgisi}</td>
                    <td>${record.birim || '-'}</td>
                    <td>
                        ${record.imported_from_excel ? 
                            '<span class="badge bg-info">Excel</span>' : 
                            '<span class="badge bg-success">Manuel</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewParametreOlcum('${record.id}')" title="Görüntüle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="editParametreOlcum('${record.id}')" title="Düzenle">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteParametreOlcum('${record.id}')" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Parametre ölçüm tablosu yüklenirken hata:', error);
        });
}

// Tümünü seç/kaldır
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.getElementsByClassName('row-checkbox');
    
    for (let checkbox of checkboxes) {
        checkbox.checked = selectAll.checked;
    }
}

// İçe aktarma modalını aç
function importData() {
    const importModal = new bootstrap.Modal(document.getElementById('importModal'));
    importModal.show();
}

// İçe aktarma işlemini gerçekleştir
function processImport() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Lütfen bir dosya seçin!');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/import_parametre_sahabil', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Veriler başarıyla içe aktarıldı!');
            loadParametreOlcumTable();
        } else {
            alert('Hata: ' + (data.error || 'İçe aktarma başarısız'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('İçe aktarma sırasında bir hata oluştu!');
    });
    
    // Modalı kapat
    const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
    importModal.hide();
}

// Seçilenleri dışa aktar
function exportSelected() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Lütfen dışa aktarılacak kayıtları seçin!');
        return;
    }
    
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    window.open(`/export_selected_parametre_sahabil?ids=${selectedIds.join(',')}`, '_blank');
}

// Tümünü dışa aktar
function exportAll() {
    window.open('/export_all_parametre_sahabil', '_blank');
}

// Seçilenleri sil
function deleteSelected() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Lütfen silinecek kayıtları seçin!');
        return;
    }
    
    if (confirm(`${selectedCheckboxes.length} adet kayıt silinecek. Emin misiniz?`)) {
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        fetch('/delete_selected_parametre_sahabil', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ids: selectedIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Seçilen kayıtlar başarıyla silindi!');
                loadParametreOlcumTable();
            } else {
                alert('Hata: ' + (data.error || 'Silme işlemi başarısız'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Silme işlemi sırasında bir hata oluştu!');
        });
    }
}

// Parametre formunu yükle
function loadParametreForm() {
    const parametreSelect = document.getElementById('parametreSelect');
    const selectedParametreId = parametreSelect.value;
    const selectedParametreName = parametreSelect.options[parametreSelect.selectedIndex].text;
    
    if (!selectedParametreId) {
        document.getElementById('parametreOlcumForm').style.display = 'none';
        return;
    }
    
    // Seçilen parametre adını güncelle
    document.getElementById('selectedParametreName').textContent = selectedParametreName;
    
    // Formu göster
    document.getElementById('parametreOlcumForm').style.display = 'block';
    
    // Parametre ölçüm alanlarını oluştur
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    parametreOlcumFields.innerHTML = '';
    
    // Tablo başlıklarını güncelle
    updateTableHeaders(selectedParametreName);
    
    // Özel parametreler listesi (yg-voc-toc-pm10-ctoz dışındakiler için özel form)
    const specialParams = ['yg', 'voc', 'toc', 'pm10', 'ctoz'];
    const isSpecialParam = specialParams.some(param => selectedParametreName.toLowerCase().includes(param));
    
    if (isSpecialParam) {
        // Özel parametreler için basit form
        createSimpleForm(parametreOlcumFields);
    } else {
        // Diğer parametreler için detaylı form (görüntüdeki tablo gibi)
        createDetailedForm(parametreOlcumFields, selectedParametreName);
    }
}

// Tablo başlıklarını güncelle
function updateTableHeaders(parametreName) {
    const tableHead = document.getElementById('parametreOlcumTableHead');
    const tableBody = document.getElementById('parametreOlcumTableBody');
    
    if (parametreName.toLowerCase().includes('yg')) {
        // YG parametresi için özel başlıklar
        tableHead.innerHTML = `
            <tr>
                <th width="50">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th width="60">#</th>
                <th>TARİH</th>
                <th>B.SIC</th>
                <th>O2</th>
                <th>CO</th>
                <th>NO</th>
                <th>NOX</th>
                <th>SO2</th>
                <th>KK1-O2</th>
                <th>KK1-CO</th>
                <th>KK1-NO</th>
                <th>KK1-SO2</th>
                <th>KK2-O2</th>
                <th>KK2-CO</th>
                <th>KK2-NO</th>
                <th>KK2-SO2</th>
                <th>T90</th>
                <th width="120">İşlemler</th>
            </tr>
        `;
        
        // Boş mesajı güncelle
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="19" class="text-center text-muted">
                        Henüz parametre ölçümü kaydı bulunmuyor
                    </td>
                </tr>
            `;
        }
    } else {
        // Standart başlıklar
        tableHead.innerHTML = `
            <tr>
                <th width="50">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th width="60">#</th>
                <th>Parametre Türü/Adı</th>
                <th>Ölçüm Tarihi</th>
                <th>Ölçüm Değerleri</th>
                <th>Birim</th>
                <th>Kaynak</th>
                <th width="120">İşlemler</th>
            </tr>
        `;
        
        // Boş mesajı güncelle
        if (tableBody.children.length === 1 && tableBody.children[0].children.length === 1) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        Henüz parametre ölçümü kaydı bulunmuyor
                    </td>
                </tr>
            `;
        }
    }
}

// Basit form oluştur (yg-voc-toc-pm10-ctoz için)
function createSimpleForm(container) {
    // YG parametresi için özel alanlar
    const selectedParametreName = document.getElementById('selectedParametreName').textContent;
    
    if (selectedParametreName.toLowerCase().includes('yg')) {
        createYGForm(container);
        return;
    }
    
    // Diğer basit parametreler için standart alanlar
    const fields = [
        { name: 'olcum_tarihi', label: 'Ölçüm Tarihi', type: 'date', required: true },
        { name: 'olcum_saati', label: 'Ölçüm Saati', type: 'time', required: true },
        { name: 'olcum_degeri', label: 'Ölçüm Değeri', type: 'number', step: '0.01', required: true },
        { name: 'birim', label: 'Birim', type: 'select', options: ['mg/m³', 'μg/m³', 'ppm', 'ppb', '%'], required: true },
        { name: 'notlar', label: 'Notlar', type: 'textarea', required: false }
    ];
    
    fields.forEach((field, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 mb-3';
        
        let inputHtml = '';
        if (field.type === 'textarea') {
            inputHtml = `<textarea class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} rows="3" placeholder="${field.label}"></textarea>`;
        } else if (field.type === 'select') {
            inputHtml = `<select class="form-select" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''}>
                <option value="">Seçin...</option>`;
            field.options.forEach(option => {
                inputHtml += `<option value="${option}">${option}</option>`;
            });
            inputHtml += '</select>';
        } else {
            inputHtml = `<input type="${field.type}" class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">`;
        }
        
        col.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}:</label>
            ${inputHtml}
        `;
        
        container.appendChild(col);
    });
}

// YG parametresi için özel form alanları
function createYGForm(container) {
    // Başlık
    const headerCol = document.createElement('div');
    headerCol.className = 'col-12 mb-3';
    headerCol.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-flask me-2"></i>
            <strong>YG Parametresi</strong> için özel ölçüm formu
        </div>
    `;
    container.appendChild(headerCol);
    
    // YG parametresi için özel alanlar
    const ygFields = [
        { name: 'tarih', label: 'TARİH', type: 'date', required: true },
        { name: 'b_sic', label: 'B.SIC', type: 'number', step: '0.1', required: false },
        { name: 'o2', label: 'O2', type: 'number', step: '0.01', required: false },
        { name: 'co', label: 'CO', type: 'number', step: '0.01', required: false },
        { name: 'no', label: 'NO', type: 'number', step: '0.01', required: false },
        { name: 'nox', label: 'NOX', type: 'number', step: '0.01', required: false },
        { name: 'so2', label: 'SO2', type: 'number', step: '0.01', required: false },
        { name: 'kk1_o2', label: 'KK1-O2', type: 'number', step: '0.01', required: false },
        { name: 'kk1_co', label: 'KK1-CO', type: 'number', step: '0.01', required: false },
        { name: 'kk1_no', label: 'KK1-NO', type: 'number', step: '0.01', required: false },
        { name: 'kk1_so2', label: 'KK1-SO2', type: 'number', step: '0.01', required: false },
        { name: 'kk2_o2', label: 'KK2-O2', type: 'number', step: '0.01', required: false },
        { name: 'kk2_co', label: 'KK2-CO', type: 'number', step: '0.01', required: false },
        { name: 'kk2_no', label: 'KK2-NO', type: 'number', step: '0.01', required: false },
        { name: 'kk2_so2', label: 'KK2-SO2', type: 'number', step: '0.01', required: false },
        { name: 't90', label: 'T90', type: 'number', step: '0.01', required: false }
    ];
    
    ygFields.forEach((field, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 mb-3';
        
        col.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}:</label>
            <input type="${field.type}" class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">
        `;
        
        container.appendChild(col);
    });
}

// Detaylı form oluştur (diğer parametreler için)
function createDetailedForm(container, parametreName) {
    // Standart alanlar
    const fields = [
        { name: 'olcum_tarihi', label: 'Ölçüm Tarihi', type: 'date', required: true },
        { name: 'olcum_saati', label: 'Ölçüm Saati', type: 'time', required: true },
        { name: 'olcum_degeri', label: 'Ölçüm Değeri', type: 'number', step: '0.01', required: true },
        { name: 'birim', label: 'Birim', type: 'select', options: ['mg/m³', 'μg/m³', 'ppm', 'ppb', '%'], required: true },
        { name: 'notlar', label: 'Notlar', type: 'textarea', required: false }
    ];
    
    fields.forEach((field, index) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4 mb-3';
        
        let inputHtml = '';
        if (field.type === 'textarea') {
            inputHtml = `<textarea class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} rows="3" placeholder="${field.label}"></textarea>`;
        } else if (field.type === 'select') {
            inputHtml = `<select class="form-select" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''}>
                <option value="">Seçin...</option>`;
            field.options.forEach(option => {
                inputHtml += `<option value="${option}">${option}</option>`;
            });
            inputHtml += '</select>';
        } else {
            inputHtml = `<input type="${field.type}" class="form-control" name="${field.name}" id="${field.name}" ${field.required ? 'required' : ''} ${field.step ? `step="${field.step}"` : ''} placeholder="${field.label}">`;
        }
        
        col.innerHTML = `
            <label for="${field.name}" class="form-label">${field.label}:</label>
            ${inputHtml}
        `;
        
        container.appendChild(col);
    });
}

// Sayfa yüklendiğinde tabloyu yükle
document.addEventListener('DOMContentLoaded', function() {
    loadParametreOlcumTable();
    
    // Parametre seçimi değiştiğinde formu yükle
    const parametreSelect = document.getElementById('parametreSelect');
    if (parametreSelect) {
        parametreSelect.addEventListener('change', function() {
            loadParametreForm();
        });
        
        // Sayfa yüklendiğinde seçili parametre varsa formu yükle
        if (parametreSelect.value) {
            loadParametreForm();
        }
    }
});

// Görüntüle, düzenle, sil fonksiyonları (placeholder)
function viewParametreOlcum(id) {
    alert('Görüntüleme özelliği yakında eklenecek!');
}

function editParametreOlcum(id) {
    alert('Düzenleme özelliği yakında eklenecek!');
}

function deleteParametreOlcum(id) {
    if (confirm('Bu kaydı silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_parametre_sahabil/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Kayıt başarıyla silindi!');
                loadParametreOlcumTable();
            } else {
                alert('Hata: ' + (data.error || 'Silme işlemi başarısız'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Silme işlemi sırasında bir hata oluştu!');
        });
    }
}
</script>
{% endblock %} 