{% extends "base.html" %}

{% block title %}Saha Ölçüm{% endblock %}

{% block content %}
<style>
/* Tablo başlıklarının yazı boyutunu küçült */
#bacaBilgileriTable thead th {
    font-size: 0.75rem !important;
    padding: 0.5rem 0.25rem !important;
    white-space: normal;
    vertical-align: middle;
    word-wrap: break-word;
    max-width: 80px;
    line-height: 1.2;
}

/* Tablo hücrelerinin yazı boyutunu da küçült */
#bacaBilgileriTable tbody td {
    font-size: 0.75rem !important;
    padding: 0.5rem 0.25rem !important;
    vertical-align: middle;
    max-width: 80px;
    word-wrap: break-word;
    white-space: normal;
}

/* Tablo başlık satırının yüksekliğini azalt */
#bacaBilgileriTable thead tr {
    height: 40px;
}

/* Tablo satırlarının yüksekliğini azalt */
#bacaBilgileriTable tbody tr {
    height: 35px;
}

/* Parametre ölçümleri tablosu için baca bilgi tablosu ile aynı yazı boyutu */
#parametreOlcumTable thead th {
    font-size: 0.75rem !important;
    padding: 0.5rem 0.25rem !important;
    white-space: normal;
    vertical-align: middle;
    word-wrap: break-word;
    max-width: 80px;
    line-height: 1.2;
}

#parametreOlcumTable tbody td {
    font-size: 0.75rem !important;
    padding: 0.5rem 0.25rem !important;
    vertical-align: middle;
    max-width: 80px;
    word-wrap: break-word;
    white-space: normal;
}

#parametreOlcumTable thead tr {
    height: 40px;
}

#parametreOlcumTable tbody tr {
    height: 35px;
}

/* Parametre tablosu filtreleme kutuları için daha küçük boyut */
#parametreOlcumTable input.form-control-sm {
    font-size: 0.6rem !important;
    padding: 0.2rem 0.3rem !important;
    height: 25px;
}

/* Parametre tablosu özel sütun genişlikleri */
#parametreOlcumTable th:nth-child(4), /* Ölçüm Kodu sütunu */
#parametreOlcumTable td:nth-child(4) {
    min-width: 120px !important;
    max-width: 150px !important;
    width: 120px !important;
}

/* Tarih sütunu genişletme */
#parametreOlcumTable th:nth-child(8), /* TARİH sütunu */
#parametreOlcumTable td:nth-child(8) {
    min-width: 100px !important;
    max-width: 120px !important;
    width: 100px !important;
    text-align: right !important;
}

/* B.HIZ sütunu genişletme */
#parametreOlcumTable th:nth-child(12), /* B.HIZ sütunu */
#parametreOlcumTable td:nth-child(12) {
    min-width: 80px !important;
    max-width: 100px !important;
    width: 80px !important;
}

/* Kayıt Tarihi sütunu genişletme */
#parametreOlcumTable th:last-child, /* Kayıt Tarihi sütunu */
#parametreOlcumTable td:last-child {
    min-width: 120px !important;
    max-width: 150px !important;
    width: 120px !important;
    text-align: right !important;
}

/* Baca seçimi stilleri */
.baca-row {
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.baca-row:hover {
    background-color: rgba(0, 123, 255, 0.15) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.baca-row.table-active {
    background-color: rgba(0, 123, 255, 0.25) !important;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

/* Buton alanlarında cursor'ı normal yap */
.baca-row .btn-group {
    cursor: default;
}

.baca-row input[type="checkbox"] {
    cursor: pointer;
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <!-- Header boş bırakıldı -->
                </div>
                <div class="card-body">
                    
                    <!-- Filtreleme Dropdown'ları -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="firmaSelect" class="form-label">Firma Seçin</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="firmaSelect" placeholder="Firma seçin veya yazın..." list="firmaList" onchange="checkBacaBilgileri()">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="firmaDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectFromDropdown('firmaSelect', '')">Tüm Firmalar</a></li>
                                </ul>
                            </div>
                            <datalist id="firmaList">
                                <option value="">Tüm Firmalar</option>
                            </datalist>
                        </div>
                        <div class="col-md-2">
                            <label for="olcumKoduSelect" class="form-label">Ölçüm Kodu Seçin</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="olcumKoduSelect" placeholder="Ölçüm kodu seçin veya yazın..." list="olcumKoduList" onchange="checkBacaBilgileri()">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="olcumKoduDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectFromDropdown('olcumKoduSelect', '')">Tüm Ölçüm Kodları</a></li>
                                </ul>
                            </div>
                            <datalist id="olcumKoduList">
                                <option value="">Tüm Ölçüm Kodları</option>
                            </datalist>
                        </div>
                        <div class="col-md-2">
                            <label for="bacaSelect" class="form-label">Baca Seçin</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="bacaSelect" placeholder="Baca seçin veya yazın..." list="bacaList" onchange="checkBacaBilgileri()">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="bacaDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectFromDropdown('bacaSelect', '')">Tüm Bacalar</a></li>
                                </ul>
                            </div>
                            <datalist id="bacaList">
                                <option value="">Tüm Bacalar</option>
                            </datalist>
                        </div>
                        <div class="col-md-2">
                            <label for="parametreSelect" class="form-label">Parametre Seçin</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="parametreSelect" placeholder="Parametre seçin veya yazın..." list="parametreList">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="parametreDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectFromDropdown('parametreSelect', '')">Tüm Parametreler</a></li>
                                </ul>
                            </div>
                            <datalist id="parametreList">
                                <option value="">Tüm Parametreler</option>
                            </datalist>
                        </div>
                        <div class="col-md-2">
                            <label for="personelSelect" class="form-label">Personel Seçin</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="personelSelect" placeholder="Personel seçin veya yazın..." list="personelList">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu" id="personelDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="selectFromDropdown('personelSelect', '')">Tüm Personel</a></li>
                                </ul>
                            </div>
                            <datalist id="personelList">
                                <option value="">Tüm Personel</option>
                            </datalist>
                        </div>
                    </div>

                    <!-- Tab Yapısı -->
                    <ul class="nav nav-tabs mb-3" id="sahaOlcTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ana-tab" data-bs-toggle="tab" data-bs-target="#ana-content" type="button" role="tab" aria-controls="ana-content" aria-selected="true">
                                <i class="fas fa-home me-2"></i>Ana Sayfa
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kk-egri-tab" data-bs-toggle="tab" data-bs-target="#kk-egri-content" type="button" role="tab" aria-controls="kk-egri-content" aria-selected="false">
                                <i class="fas fa-chart-line me-2"></i>KK_EGRI
                            </button>
                        </li>
                    </ul>

                    <!-- Tab İçerikleri -->
                    <div class="tab-content" id="sahaOlcTabContent">
                        <!-- Ana Sayfa Tab İçeriği -->
                        <div class="tab-pane fade show active" id="ana-content" role="tabpanel" aria-labelledby="ana-tab">
                            <!-- Baca Bilgileri Giriş Formu -->
                    <div id="bacaBilgileriForm" style="display: none;" class="card mb-3">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-chimney me-2"></i>
                                Baca Bilgileri Girişi
                            </h6>
                            <button type="button" class="btn btn-light btn-sm" onclick="testFormDisplay()">
                                <i class="fas fa-test me-1"></i>Test Form
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="bacaBilgileriFormElement">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="row" id="bacaBilgileriFields">
                                            <!-- Baca bilgileri alanları dinamik olarak yüklenecek -->
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <label class="form-label fw-bold me-2 mb-0" style="min-width: 100px;">Kayıt Tarihi:</label>
                                            <input type="date" class="form-control form-control-sm" id="bacaKayitTarihi" name="kayit_tarihi" style="width: 150px;" onchange="formatBacaKayitTarihi(this)">
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" id="saveBacaBilgileriBtn" class="btn btn-success btn-sm" onclick="saveBacaBilgileri()" tabindex="999">
                                            <i class="fas fa-save me-1"></i>Baca Bilgilerini Kaydet
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Parametre Ölçüm Formu -->
                    <div id="parametreOlcumForm" style="display: none;" class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-flask me-2"></i>
                                Parametre Ölçüm Girişi - <span id="selectedParametreName"></span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="parametreOlcumFormElement">
                                <div class="row" id="parametreOlcumFields">
                                    <!-- Parametre ölçüm alanları dinamik olarak yüklenecek -->
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12 text-end">
                                        <button type="button" class="btn btn-warning" onclick="saveParametreOlcum()">
                                            <i class="fas fa-save me-1"></i>Parametre Ölçümünü Kaydet
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    </div>



                    <!-- Baca Bilgileri Kayıtları Tablosu -->
                    <div class="card mt-4">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>
                                Baca Bilgileri Kayıtları
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-light btn-sm" onclick="importBacaData()">
                                    <i class="fas fa-upload me-1"></i>İçe Aktar
                                </button>
                                <button type="button" class="btn btn-light btn-sm" onclick="exportBacaData()">
                                    <i class="fas fa-download me-1"></i>Dışa Aktar
                                </button>
                                <button type="button" class="btn btn-light btn-sm" onclick="deleteSelectedBaca()">
                                    <i class="fas fa-trash me-1"></i>Seçilenleri Sil
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="printDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-print me-1"></i>Yazdır
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="printDropdown">
                                        <li><a class="dropdown-item" href="#" onclick="printBacaData('pdf')"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="printBacaToWord()"><i class="fas fa-file-word me-2"></i>Word</a></li>
                
                                        <li><a class="dropdown-item" href="#" onclick="printBacaData('excel')"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportFirmaRaporu(true)"><i class="fas fa-file-alt me-2"></i>Firma Raporu (Şablon)</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="exportFirmaRaporuPDF()"><i class="fas fa-file-pdf me-2"></i>PDF Firma Raporu Şablon</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover" id="bacaBilgileriTable">
                                    <thead class="table-dark sticky-top" style="z-index: 1000;">
                                        <tr>
                                            <th width="46">
                                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                            </th>
                                            <th width="40">#</th>
                                            <th width="92">
                                                Firma
                                                <br>
                                                <input type="text" class="form-control form-control-sm mt-1" id="bacaFirmaDropdown" placeholder="Firma seçin veya yazın..." list="bacaFirmaList" onkeyup="filterBacaTable()" onchange="filterBacaTable()" style="font-size: 0.7rem;">
                                                <datalist id="bacaFirmaList">
                                                    <option value="">Tüm Firmalar</option>
                                                </datalist>
                                            </th>
                                            <th width="115">
                                                Ölçüm Kodu
                                                <br>
                                                <input type="text" class="form-control form-control-sm mt-1" id="bacaOlcumKoduDropdown" placeholder="Ölçüm kodu seçin veya yazın..." list="bacaOlcumKoduList" onkeyup="filterBacaTable()" onchange="filterBacaTable()" style="font-size: 0.7rem;">
                                                <datalist id="bacaOlcumKoduList">
                                                    <option value="">Tüm Ölçüm Kodları</option>
                                                </datalist>
                                            </th>
                                            <th width="92">
                                                Baca
                                                <br>
                                                <input type="text" class="form-control form-control-sm mt-1" id="bacaBacaDropdown" placeholder="Baca seçin veya yazın..." list="bacaBacaList" onkeyup="filterBacaTable()" onchange="filterBacaTable()" style="font-size: 0.7rem;">
                                                <datalist id="bacaBacaList">
                                                    <option value="">Tüm Bacalar</option>
                                                </datalist>
                                            </th>
                                            <th width="125">İşlemler</th>
                                            <th width="85" style="text-align: center;">BACA<br>NO</th>
                                            <th width="92">KAYNAK<br>TÜRÜ</th>
                                            <th width="81">ISIL<br>GÜÇ<br>(MW)</th>
                                            <th width="92">BACA<br>ÖLÇÜSÜ</th>
                                            <th width="69">ÇATI<br>YÜK</th>
                                            <th width="92">YAKIT<br>TÜRÜ</th>
                                            <th width="81">ÇATI<br>ŞEKLİ</th>
                                            <th width="81">BACA<br>ŞEKLİ</th>
                                            <th width="81">YERDEN<br>YÜK.</th>
                                            <th width="92">RÜZGAR<br>HIZ<br>(M/S)</th>
                                            <th width="69">ORT.<br>SIC.</th>
                                            <th width="69">ORT.<br>NEM</th>
                                            <th width="69">ORT.<br>BAS.</th>
                                            <th width="58">A<br>BACA</th>
                                            <th width="58">B<br>BACA</th>
                                            <th width="58">C<br>DELİK</th>
                                            <th width="69">Fotoğraf</th>
                                            <th width="92">PER.</th>
                                            <th width="92">Kayıt Tarihi</th>
                                        </tr>

                                    </thead>
                                    <tbody id="bacaBilgileriTableBody">
                                        <!-- Kayıtlar dinamik olarak eklenecek -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Sayfalama -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted">
                                    <small>Toplam <span id="totalBacaRecords">0</span> kayıt, <span id="currentBacaPage">1</span>. sayfa</small>
                                </div>
                                <nav aria-label="Baca bilgileri sayfalama">
                                    <ul class="pagination pagination-sm mb-0" id="bacaPagination">
                                        <!-- Sayfa numaraları dinamik olarak eklenecek -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Boş durum mesajı -->
                            <div id="emptyMessage" class="text-center py-5" style="display: none;">
                                <i class="fas fa-chimney fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Henüz baca bilgileri kaydı bulunmuyor</h5>
                                <p class="text-muted">Baca bilgilerini doldurup "Baca Bilgilerini Kaydet" butonuna tıklayarak ilk kaydınızı oluşturun.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Parametre Ölçümleri Kayıtları Tablosu -->
                    <div class="card mt-4">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-flask me-2"></i>
                                    Parametre Ölçümleri Kayıtları
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Baca satırlarına tıklayarak filtreleme yapabilirsiniz
                                    </small>
                                </h6>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-danger btn-sm" id="secilenleriSilParametre" disabled>
                                        <i class="fas fa-trash me-2"></i>Seçilenleri Sil
                                    </button>
                                    <div class="dropdown" style="position: relative;">
                                        <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="exportParametreDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-file-download me-2"></i>Dışa Aktar
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="exportParametreDropdown" style="z-index: 9999; position: absolute;">
                                            <li><a class="dropdown-item" href="#" onclick="exportParametreOlcumleri('excel')">
                                                <i class="fas fa-file-excel me-2"></i>Excel (.xlsx)
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportParametreOlcumleri('word')">
                                                <i class="fas fa-file-word me-2"></i>Word (.docx)
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportParametreOlcumleri('pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>PDF (.pdf)
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filtre bilgisi alanı -->
                            <div id="filterInfo"></div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover" id="parametreOlcumTable">
                                    <thead class="table-dark sticky-top" id="parametreOlcumTableHead" style="z-index: 1000;">
                                        <!-- Başlıklar dinamik olarak oluşturulacak -->
                                    </thead>
                                    <tbody id="parametreOlcumTableBody">
                                        <!-- Kayıtlar dinamik olarak eklenecek -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Sayfalama -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted">
                                    <small>Toplam <span id="totalParametreRecords">0</span> kayıt, <span id="currentParametrePage">1</span>. sayfa</small>
                                </div>
                                <nav aria-label="Parametre ölçümleri sayfalama">
                                    <ul class="pagination pagination-sm mb-0" id="parametrePagination">
                                        <!-- Sayfa numaraları dinamik olarak eklenecek -->
                                    </ul>
                                </nav>
                            </div>

                            <!-- Boş durum mesajı -->
                            <div id="emptyParametreMessage" class="text-center py-5" style="display: none;">
                                <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Henüz parametre ölçümü kaydı bulunmuyor</h5>
                                <p class="text-muted">Parametre seçip ölçüm değerlerini girerek ilk kaydınızı oluşturun.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                        </div>
                        
                        <!-- KK_EGRI Tab İçeriği -->
                        <div class="tab-pane fade" id="kk-egri-content" role="tabpanel" aria-labelledby="kk-egri-tab">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        Kalite Kontrol Eğrisi
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>KK_EGRI</strong> sekmesi - Kalite kontrol eğrileri ve grafikleri burada görüntülenecek.
                                            </div>
                                            <div class="text-center py-5">
                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">Kalite Kontrol Eğrisi</h5>
                                                <p class="text-muted">Bu bölümde kalite kontrol grafikleri ve eğrileri görüntülenecek.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İçe Aktarma Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Saha Ölçüm Verilerini İçe Aktar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Excel Dosyası Seçin</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".xlsx,.xls" required>
                        <div class="form-text">Sadece Excel dosyaları (.xlsx, .xls) kabul edilir.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="submitImport()">İçe Aktar</button>
            </div>
        </div>
    </div>
</div>

<!-- Gizli form -->
<form id="exportForm" method="post" style="display: none;">
    <input type="hidden" name="selected_ids" id="selectedIds">
</form>

<script>
// Filtreleme fonksiyonları
function filterBacaTable() {
    const filters = {
        firma: document.getElementById('bacaFirmaDropdown').value.toLowerCase(),
        olcumKodu: document.getElementById('bacaOlcumKoduDropdown').value.toLowerCase(),
        baca: document.getElementById('bacaBacaDropdown').value.toLowerCase()
    };
    
    const rows = document.querySelectorAll('#bacaBilgileriTableBody tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let show = true;
        
        // Firma filtresi
        if (filters.firma && cells[2] && !cells[2].textContent.toLowerCase().includes(filters.firma)) show = false;
        
        // Ölçüm Kodu filtresi
        if (filters.olcumKodu && cells[3] && !cells[3].textContent.toLowerCase().includes(filters.olcumKodu)) show = false;
        
        // Baca filtresi
        if (filters.baca && cells[4] && !cells[4].textContent.toLowerCase().includes(filters.baca)) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

function filterParametreTable() {
    const filters = {
        firma: document.getElementById('parametreFirmaFilter').value.toLowerCase(),
        firmaDropdown: document.getElementById('parametreFirmaDropdown').value.toLowerCase(),
        olcumKodu: document.getElementById('parametreOlcumKoduFilter').value.toLowerCase(),
        olcumKoduDropdown: document.getElementById('parametreOlcumKoduDropdown').value.toLowerCase(),
        baca: document.getElementById('parametreBacaFilter').value.toLowerCase(),
        bacaDropdown: document.getElementById('parametreBacaDropdown').value.toLowerCase()
    };
    
    const rows = document.querySelectorAll('#parametreOlcumTableBody tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let show = true;
        
        // Firma filtresi - hem süzme hem dropdown
        if (filters.firma && cells[2] && !cells[2].textContent.toLowerCase().includes(filters.firma)) show = false;
        if (filters.firmaDropdown && cells[2] && cells[2].textContent.toLowerCase() !== filters.firmaDropdown) show = false;
        
        // Ölçüm Kodu filtresi - hem süzme hem dropdown
        if (filters.olcumKodu && cells[3] && !cells[3].textContent.toLowerCase().includes(filters.olcumKodu)) show = false;
        if (filters.olcumKoduDropdown && cells[3] && cells[3].textContent.toLowerCase() !== filters.olcumKoduDropdown) show = false;
        
        // Baca filtresi - hem süzme hem dropdown
        if (filters.baca && cells[4] && !cells[4].textContent.toLowerCase().includes(filters.baca)) show = false;
        if (filters.bacaDropdown && cells[4] && cells[4].textContent.toLowerCase() !== filters.bacaDropdown) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// Eski filtreleme fonksiyonları (geriye uyumluluk için)
function filterBacaBilgileri() {
    console.log('checkBacaBilgileri çağrıldı');
    
    const firma = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const baca = document.getElementById('bacaSelect').value;
    
    console.log('Seçilen değerler:', { firma, olcumKodu, baca });
    
    // Tüm alanlar dolu mu kontrol et
    if (firma && olcumKodu && baca) {
        console.log('Tüm alanlar dolu, baca bilgileri kontrol ediliyor...');
        
        // Mevcut baca bilgilerini kontrol et
        fetch('/api/baca_bilgileri')
            .then(response => response.json())
            .then(data => {
                console.log('Baca bilgileri API yanıtı:', data);
                
                const existingRecord = data.find(item => 
                    item.firma_adi === firma && 
                    item.olcum_kodu === olcumKodu && 
                    item.baca_adi === baca
                );
                
                console.log('Mevcut kayıt bulundu mu:', existingRecord);
                
                if (existingRecord) {
                    // Zaten baca bilgileri var - uyarı ver
                    if (confirm(`Bu firma, ölçüm kodu ve baca için zaten baca bilgileri mevcut. Güncellemek istiyor musunuz?`)) {
                        console.log('Mevcut veri güncellenecek');
                        // Mevcut veriyi forma yükle
                        loadExistingBacaBilgileri(existingRecord);
                    } else {
                        console.log('Form temizlenecek');
                        // Formu temizle
                        clearBacaBilgileriForm();
                    }
                } else {
                    // Yeni baca bilgileri - formu aç
                    console.log('Yeni baca bilgileri, form açılıyor...');
                    loadBacaBilgileriForm();
                }
            })
            .catch(error => {
                console.error('Baca bilgileri kontrol edilirken hata:', error);
                // Hata durumunda formu aç
                loadBacaBilgileriForm();
            });
    } else {
        console.log('Eksik alanlar var, form gizleniyor');
        // Eksik alanlar varsa formu gizle
        document.getElementById('bacaBilgileriForm').style.display = 'none';
    }
}

function filterParametreOlcumleri() {
    const searchTerm = document.getElementById('parametreSearchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#parametreOlcumTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function clearBacaFilters() {
    document.getElementById('bacaSearchInput').value = '';
    const rows = document.querySelectorAll('#bacaBilgileriTableBody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

function clearParametreFilters() {
    document.getElementById('parametreSearchInput').value = '';
    const rows = document.querySelectorAll('#parametreOlcumTableBody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

// Sayfa yüklendiğinde kaydedilen baca bilgilerini yükle
document.addEventListener('DOMContentLoaded', function() {
    // Önce baca parametrelerini yükle
    fetch('/api/baca_parametreleri')
        .then(response => response.json())
        .then(data => {
            window.bacaParametreleri = data;
            // Sonra kaydedilen baca bilgilerini yükle
            loadSavedBacaBilgileri();
        })
        .catch(error => {
            console.error('Baca parametreleri yüklenirken hata:', error);
            // Hata olsa bile baca bilgilerini yüklemeye çalış
            loadSavedBacaBilgileri();
        });
    
    // Personel listesini yükle
    loadPersonelListesi();
});

// Personel listesini yükle
function loadPersonelListesi() {
    fetch('/api/personel_listesi')
        .then(response => response.json())
        .then(data => {
            const personelSelect = document.getElementById('personelSelect');
            personelSelect.innerHTML = '<option value="">Personel seçin...</option>';
            
            if (Array.isArray(data)) {
                data.forEach(personel => {
                    const option = document.createElement('option');
                    option.value = personel.id || personel.personel_adi;
                    option.textContent = personel.personel_adi || personel.ad_soyad || personel.id;
                    personelSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Personel listesi yüklenirken hata:', error);
            // Hata durumunda örnek personel listesi ekle
            const personelSelect = document.getElementById('personelSelect');
            personelSelect.innerHTML = `
                <option value="">Personel seçin...</option>
                <option value="1">Ahmet Yılmaz</option>
                <option value="2">Mehmet Demir</option>
                <option value="3">Ayşe Kaya</option>
                <option value="4">Fatma Özkan</option>
                <option value="5">Ali Çelik</option>
            `;
        });
}

// Kaydedilen baca bilgilerini yükle ve tabloya ekle
function loadSavedBacaBilgileri() {
    fetch('/api/baca_bilgileri')
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                const bacaBilgileriTableBody = document.getElementById('bacaBilgileriTableBody');
                bacaBilgileriTableBody.innerHTML = ''; // Mevcut verileri temizle
                
                data.forEach(record => {
                    addSavedBacaBilgileriToTable(record);
                });
                
                // Dropdown'ları doldur
                populateBacaDropdowns(data);
                
                console.log(`${data.length} adet kaydedilmiş baca bilgisi yüklendi.`);
            }
        })
        .catch(error => {
            console.error('Kaydedilen baca bilgileri yüklenirken hata:', error);
        });
}

// Baca bilgileri dropdown'larını doldur
function populateBacaDropdowns(data) {
    const firmalar = [...new Set(data.map(item => item.firma_adi).filter(Boolean))].sort();
    const olcumKodlari = [...new Set(data.map(item => item.olcum_kodu).filter(Boolean))].sort();
    const bacalar = [...new Set(data.map(item => item.baca_adi).filter(Boolean))].sort();
    
    const firmaList = document.getElementById('bacaFirmaList');
    if (firmaList) {
        firmaList.innerHTML = '<option value="">Tüm Firmalar</option>';
        firmalar.forEach(firma => {
            firmaList.innerHTML += `<option value="${firma}">${firma}</option>`;
        });
    }
    
    const olcumKoduList = document.getElementById('bacaOlcumKoduList');
    if (olcumKoduList) {
        olcumKoduList.innerHTML = '<option value="">Tüm Ölçüm Kodları</option>';
        olcumKodlari.forEach(olcumKodu => {
            olcumKoduList.innerHTML += `<option value="${olcumKodu}">${olcumKodu}</option>`;
        });
    }
    
    const bacaList = document.getElementById('bacaBacaList');
    if (bacaList) {
        bacaList.innerHTML = '<option value="">Tüm Bacalar</option>';
        bacalar.forEach(baca => {
            bacaList.innerHTML += `<option value="${baca}">${baca}</option>`;
        });
    }
}

// Kaydedilen baca bilgisini tabloya ekle
function addSavedBacaBilgileriToTable(record) {
    const bacaBilgileriTableBody = document.getElementById('bacaBilgileriTableBody');
    const newRow = document.createElement('tr');
    
    // Satır ID'sini ata
    newRow.id = `row_${record.id}`;
    
    // Baca seçimi için data attribute'ları ekle
    newRow.className = 'baca-row';
    newRow.setAttribute('data-firma', record.firma_adi || '');
    newRow.setAttribute('data-olcum', record.olcum_kodu || '');
    newRow.setAttribute('data-baca', record.baca_adi || '');
    newRow.style.cursor = 'pointer';
    
    const bacaBilgileri = record.baca_bilgileri || {};
    const bacaParametreleri = window.bacaParametreleri || [];
    
    // Satır sayısını hesapla
    const rowNumber = bacaBilgileriTableBody.children.length + 1;
    
    newRow.innerHTML = `
        <td>
            <input type="checkbox" class="row-checkbox" value="${record.id}">
        </td>
        <td>${rowNumber}</td>
        <td>${record.firma_adi || '-'}</td>
        <td>${record.olcum_kodu || '-'}</td>
        <td>${record.baca_adi || '-'}</td>
        <td data-baca-bilgileri='${JSON.stringify(bacaBilgileri)}'>
            <div class="btn-group btn-group-sm" role="group" style="font-size: 0.75rem;">
                <button type="button" class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewBacaBilgileri('${record.id}')" title="Görüntüle">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editBacaBilgileri('${record.id}')" title="Düzenle">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteBacaBilgileri('${record.id}')" title="Sil">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
        <td style="text-align: center;">${bacaBilgileri['597fad80-d28f-40ea-bd28-a76c61c5203d'] || '*'}</td>
        <td>${bacaBilgileri['98399625-5bbc-465e-8e09-de454f231ae4'] || '*'}</td>
        <td>${bacaBilgileri['22867c9a-ca3c-4d80-b017-b73dafdd7fef'] || '*'}</td>
        <td>${bacaBilgileri['b1b6fc38-98c0-4048-8b8e-795cf7d44c48'] || '*'}</td>
        <td>${bacaBilgileri['8ec9ecc9-ecda-4bf2-9802-02fa2e3fda4c'] || '*'}</td>
        <td>${bacaBilgileri['ddca398d-0e55-4662-b661-3731e0975bd2'] || '*'}</td>
        <td>${bacaBilgileri['6b3546e0-184c-49de-82e4-e2835e81923b'] || '*'}</td>
        <td>${bacaBilgileri['d9958774-43f7-4bc3-8e12-436614a6193a'] || '*'}</td>
        <td>${bacaBilgileri['6a301d72-f21b-485b-b8fb-116ad5cb223f'] || '*'}</td>
        <td>${bacaBilgileri['ab2b67dd-16a5-4bee-9b6e-b60b8cfc2d0c'] || '*'}</td>
        <td>${bacaBilgileri['eca60e54-ec39-4412-8884-caa17faed0be'] || '*'}</td>
        <td>${bacaBilgileri['64238e0a-6387-4c31-9bf4-d7f800ef17e1'] || '*'}</td>
        <td>${bacaBilgileri['b09ad69a-e4d4-4219-b055-2cf923ffd499'] || '*'}</td>
        <td>${bacaBilgileri['9c8c8bcf-c98e-4109-8b10-63b08b26460e'] || '*'}</td>
        <td>${bacaBilgileri['af55c55f-f83b-4b90-a655-ee76bf6bb2ac'] || '*'}</td>
        <td>${bacaBilgileri['20881447-f7c8-4a6b-8583-76c7246082ef'] || '*'}</td>
        <td>${record.photo_path ? `<img src="/static/${record.photo_path}" class="img-thumbnail" style="max-width: 50px; max-height: 50px;" onclick="showPhotoModal('${record.photo_path}')" title="Fotoğrafı büyüt">` : '*'}</td>
        <td>${record.personel_adi || '*'}</td>
        <td>${record.created_at ? new Date(record.created_at).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'}) : '*'}</td>
    `;
    
    bacaBilgileriTableBody.appendChild(newRow);
    
    // Boş mesajı gizle
    const emptyMessage = document.getElementById('emptyMessage');
    if (emptyMessage) {
        emptyMessage.style.display = 'none';
    }
    
    // Baca satırına tıklama event listener'ı ekle
    newRow.addEventListener('click', function(e) {
        // Butonlara tıklanmadıysa baca seç
        if (!e.target.closest('.btn-group') && !e.target.closest('input[type="checkbox"]')) {
            selectBaca(record.firma_adi, record.olcum_kodu, record.baca_adi);
        }
    });
}

// Tümünü seç/kaldır
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.getElementsByClassName('row-checkbox');
    
    for (let checkbox of checkboxes) {
        checkbox.checked = selectAll.checked;
    }
}

// İçe aktarma modalını aç
function importData() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

// İçe aktarma işlemi
function submitImport() {
    const fileInput = document.getElementById('importFile');
    if (!fileInput.files[0]) {
        alert('Lütfen bir dosya seçin!');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    // Bu fonksiyon daha sonra implement edilecek
    alert('İçe aktarma özelliği yakında eklenecek!');
}

// Baca seçimi fonksiyonu
function selectBaca(firma, olcumKodu, baca) {
    // Seçili baca satırını vurgula
    document.querySelectorAll('.baca-row').forEach(row => {
        row.classList.remove('table-active');
    });
    
    const selectedRow = document.querySelector(`[data-firma="${firma}"][data-olcum="${olcumKodu}"][data-baca="${baca}"]`);
    if (selectedRow) {
        selectedRow.classList.add('table-active');
        
        // Seçili satırı görünür alana kaydır
        selectedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Parametre ölçüm tablosunu filtrele
    filterParametreTableByBaca(firma, olcumKodu, baca);
    
    // Seçili baca bilgisini göster
    console.log(`Seçili baca: ${firma} - ${olcumKodu} - ${baca}`);
    
    // Kullanıcıya görsel geri bildirim
    showBacaSelectionFeedback(baca);
}


                
                // Baca seçimi geri bildirimi
                function showBacaSelectionFeedback(baca) {
                    // Geçici bir bildirim göster
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    notification.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>${baca}</strong> bacası seçildi
                        <small class="d-block mt-1 text-muted">Yazdır butonundan Word seçeneğini kullanabilirsiniz</small>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // 5 saniye sonra otomatik kaldır
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 5000);
                }

// Parametre tablosunu baca seçimine göre filtrele
function filterParametreTableByBaca(firma, olcumKodu, baca) {
    const parametreTableBody = document.getElementById('parametreOlcumTableBody');
    const rows = parametreTableBody.querySelectorAll('tr');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const rowFirma = row.getAttribute('data-firma');
        const rowOlcum = row.getAttribute('data-olcum');
        const rowBaca = row.getAttribute('data-baca');
        
        if (rowFirma === firma && rowOlcum === olcumKodu && rowBaca === baca) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Filtreleme sonucunu göster
    const filterInfo = document.getElementById('filterInfo');
    if (filterInfo) {
        if (visibleCount > 0) {
            filterInfo.innerHTML = `<div class="alert alert-info alert-sm mb-2">
                <i class="fas fa-filter me-1"></i>
                <strong>${baca}</strong> bacasına ait <strong>${visibleCount}</strong> parametre ölçümü gösteriliyor
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearBacaFilter()">
                    <i class="fas fa-times me-1"></i>Filtreyi Temizle
                </button>
            </div>`;
        } else {
            filterInfo.innerHTML = `<div class="alert alert-warning alert-sm mb-2">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>${baca}</strong> bacasına ait parametre ölçümü bulunamadı
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearBacaFilter()">
                    <i class="fas fa-times me-1"></i>Filtreyi Temizle
                </button>
            </div>`;
        }
    }
}

// Baca filtresini temizle
function clearBacaFilter() {
    // Tüm satırları göster
    const parametreTableBody = document.getElementById('parametreOlcumTableBody');
    const rows = parametreTableBody.querySelectorAll('tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    // Seçili baca vurgusunu kaldır
    document.querySelectorAll('.baca-row').forEach(row => {
        row.classList.remove('table-active');
    });
    
    // Filtre bilgisini temizle
    const filterInfo = document.getElementById('filterInfo');
    if (filterInfo) {
        filterInfo.innerHTML = '';
    }
}

// Seçilenleri dışa aktar
function exportSelected() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Lütfen dışa aktarılacak kayıtları seçin!');
        return;
    }
    
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    document.getElementById('selectedIds').value = selectedIds.join(',');
    
    // Bu fonksiyon daha sonra implement edilecek
    alert('Seçilenleri dışa aktarma özelliği yakında eklenecek!');
}

// Tümünü dışa aktar
function exportAll() {
    // Bu fonksiyon daha sonra implement edilecek
    alert('Tümünü dışa aktarma özelliği yakında eklenecek!');
}

// Sayfa yüklendiğinde firma listesini yükle
document.addEventListener('DOMContentLoaded', function() {
    loadFirmaListesi();
    
    // Boş mesajı göster (eğer tablo boşsa)
    const tableBody = document.getElementById('bacaBilgileriTableBody');
    if (tableBody && tableBody.children.length === 0) {
        document.getElementById('emptyMessage').style.display = 'block';
    }
});

// Firma listesini yükle
function loadFirmaListesi() {
    fetch('/api/firmalar')
        .then(response => response.json())
        .then(data => {
            const firmaSelect = document.getElementById('firmaSelect');
            firmaSelect.innerHTML = '<option value="">Firma seçin...</option>';
            
            data.forEach(firma => {
                const option = document.createElement('option');
                option.value = firma.firma_adi;
                option.textContent = firma.firma_adi;
                firmaSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Firma listesi yüklenirken hata:', error);
        });
}

// Firma seçildiğinde ölçüm kodlarını yükle
function loadOlcumKodlari() {
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKoduSelect = document.getElementById('olcumKoduSelect');
    const bacaSelect = document.getElementById('bacaSelect');
    const parametreSelect = document.getElementById('parametreSelect');
    
    if (!firmaAdi) {
        olcumKoduSelect.innerHTML = '<option value="">Önce firma seçin...</option>';
        olcumKoduSelect.disabled = true;
        bacaSelect.innerHTML = '<option value="">Önce ölçüm kodu seçin...</option>';
        bacaSelect.disabled = true;
        parametreSelect.innerHTML = '<option value="">Önce baca seçin...</option>';
        parametreSelect.disabled = true;
        return;
    }
    
    fetch(`/api/olcum_kodlari/${encodeURIComponent(firmaAdi)}`)
        .then(response => response.json())
        .then(data => {
            olcumKoduSelect.innerHTML = '<option value="">Ölçüm kodu seçin...</option>';
            
            data.forEach(olcum => {
                const option = document.createElement('option');
                option.value = olcum.olcum_kodu;
                option.textContent = olcum.olcum_kodu;
                olcumKoduSelect.appendChild(option);
            });
            
            olcumKoduSelect.disabled = false;
            bacaSelect.innerHTML = '<option value="">Önce ölçüm kodu seçin...</option>';
            bacaSelect.disabled = true;
            parametreSelect.innerHTML = '<option value="">Önce baca seçin...</option>';
            parametreSelect.disabled = true;
        })
        .catch(error => {
            console.error('Ölçüm kodları yüklenirken hata:', error);
        });
}

// Ölçüm kodu seçildiğinde baca listesini yükle
function loadBacaListesi() {
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const bacaSelect = document.getElementById('bacaSelect');
    const parametreSelect = document.getElementById('parametreSelect');
    
    if (!olcumKodu) {
        bacaSelect.innerHTML = '<option value="">Önce ölçüm kodu seçin...</option>';
        bacaSelect.disabled = true;
        parametreSelect.innerHTML = '<option value="">Önce baca seçin...</option>';
        parametreSelect.disabled = true;
        return;
    }
    
    fetch(`/api/baca_listesi/${encodeURIComponent(firmaAdi)}/${encodeURIComponent(olcumKodu)}`)
        .then(response => response.json())
        .then(data => {
            bacaSelect.innerHTML = '<option value="">Baca seçin...</option>';
            
            data.forEach(baca => {
                const option = document.createElement('option');
                option.value = baca.baca_adi;
                option.textContent = baca.baca_adi;
                bacaSelect.appendChild(option);
            });
            
            bacaSelect.disabled = false;
            // Parametre seçimi baca seçildiğinde aktif olacak
        })
        .catch(error => {
            console.error('Baca listesi yüklenirken hata:', error);
        });
}

// Baca seçildiğinde hem baca bilgileri hem parametre seçimini aktif et
function loadParametreListesi() {
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const bacaAdi = document.getElementById('bacaSelect').value;
    const parametreSelect = document.getElementById('parametreSelect');
    
    if (!bacaAdi) {
        parametreSelect.innerHTML = '<option value="">Önce baca seçin...</option>';
        parametreSelect.disabled = true;
        // Baca bilgileri formunu gizle
        document.getElementById('bacaBilgileriForm').style.display = 'none';
        document.getElementById('parametreOlcumForm').style.display = 'none';
        return;
    }
    
    // Baca bilgileri formunu yükle (mevcut bilgi olsun veya olmasın)
    loadBacaBilgileriForm();
    
    // Parametre listesini yükle
    loadParametreListesiForBaca(firmaAdi, olcumKodu, bacaAdi);
    
    // Önce bu baca için mevcut bilgilerin olup olmadığını kontrol et (arka planda)
    setTimeout(() => {
        checkExistingBacaBilgileri(firmaAdi, olcumKodu, bacaAdi);
    }, 500);
}

// Mevcut baca bilgilerini kontrol et
function checkExistingBacaBilgileri(firmaAdi, olcumKodu, bacaAdi) {
    // Tabloda bu baca için kayıt var mı kontrol et
    const tableBody = document.getElementById('bacaBilgileriTableBody');
    const existingRow = Array.from(tableBody.children).find(row => {
        const firmaCell = row.children[2]?.textContent.trim(); // Firma sütunu (checkbox ve sıra numarasından sonra)
        const olcumCell = row.children[3]?.textContent.trim(); // Ölçüm kodu sütunu  
        const bacaCell = row.children[4]?.textContent.trim(); // Baca sütunu
        return firmaCell === firmaAdi && olcumCell === olcumKodu && bacaCell === bacaAdi;
    });
    
    if (existingRow) {
        // Bu baca için bilgiler zaten mevcut
        const confirmEdit = confirm(
            `"${firmaAdi} - ${olcumKodu} - ${bacaAdi}" için baca bilgileri zaten girilmiş.\n\n` +
            `Mevcut bilgileri düzenlemek ister misiniz?\n\n` +
            `"Tamam" = Mevcut bilgileri düzenle\n` +
            `"İptal" = Yeni kayıt oluştur`
        );
        
        if (confirmEdit) {
            // Önce formu yükle, sonra mevcut bilgileri doldur
            loadBacaBilgileriForm(() => {
                loadExistingBacaBilgileri(firmaAdi, olcumKodu, bacaAdi);
            });
        }
        // İptal durumunda form zaten yüklenecek, bir şey yapmaya gerek yok
    }
    
    // Parametre listesi zaten yüklenmiş olmalı, tekrar yükleme
}

// Mevcut baca bilgilerini yükle ve düzenleme moduna geç
function loadExistingBacaBilgileri(firmaAdi, olcumKodu, bacaAdi) {
    // Tabloda bu baca için mevcut veriyi bul
    const tableBody = document.getElementById('bacaBilgileriTableBody');
    const existingRow = Array.from(tableBody.children).find(row => {
        const firmaCell = row.children[2]?.textContent.trim(); // Firma sütunu (checkbox ve sıra numarasından sonra)
        const olcumCell = row.children[3]?.textContent.trim(); // Ölçüm kodu sütunu
        const bacaCell = row.children[4]?.textContent.trim(); // Baca sütunu
        return firmaCell === firmaAdi && olcumCell === olcumKodu && bacaCell === bacaAdi;
    });
    
    if (existingRow) {
        // Mevcut veriyi al (JSON formatında) - İşlemler sütunundan (6. sütun)
        const dataCell = existingRow.children[5]; // İşlemler sütunu
        const bacaData = dataCell.getAttribute('data-baca-bilgileri');
        
        if (bacaData) {
            try {
                const parsedData = JSON.parse(bacaData);
                
                // Form alanlarını doldur
                setTimeout(() => {
                    Object.keys(parsedData).forEach(key => {
                        const input = document.getElementById(`baca_bilgi_${key}`);
                        if (input) {
                            input.value = parsedData[key];
                        }
                    });
                    
                    // Düzenleme modu olduğunu belirt
                    const saveBtn = document.getElementById('saveBacaBilgileriBtn');
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Güncelle';
                    saveBtn.className = 'btn btn-warning btn-sm';
                    
                    // Düzenleme modunu aktif et
                    window.editingRowId = existingRow.id.replace('row_', '');
                    
                    // Kullanıcıya bilgi ver
                    alert('Mevcut baca bilgileri yüklendi. Değişiklikleri yapıp "Güncelle" butonuna tıklayın.');
                }, 500); // Form yüklendikten sonra doldur
                
            } catch (error) {
                console.error('Baca bilgileri parse edilemedi:', error);
                alert('Mevcut bilgiler yüklenirken hata oluştu.');
            }
        } else {
            console.error('Baca bilgileri bulunamadı');
            alert('Mevcut baca bilgileri bulunamadı.');
        }
    } else {
        console.error('Baca satırı bulunamadı');
        alert('Baca satırı bulunamadı.');
    }
}

// Baca bilgileri formunu yükle
function loadBacaBilgileriForm(callback) {
    console.log('loadBacaBilgileriForm çağrıldı');
    
    const bacaBilgileriForm = document.getElementById('bacaBilgileriForm');
    const bacaBilgileriFields = document.getElementById('bacaBilgileriFields');
    
    console.log('Form elementi:', bacaBilgileriForm);
    console.log('Fields elementi:', bacaBilgileriFields);
    
    if (!bacaBilgileriForm) {
        console.error('Baca bilgileri formu bulunamadı!');
        alert('Baca bilgileri formu bulunamadı!');
        return;
    }
    
    if (!bacaBilgileriFields) {
        console.error('Baca bilgileri fields elementi bulunamadı!');
        alert('Baca bilgileri fields elementi bulunamadı!');
        return;
    }
    
    // Formu göster
    bacaBilgileriForm.style.display = 'block';
    console.log('Form gösterildi');
    
    // Yeni kayıt modunda olduğunu belirt
    window.editingRowId = null;
    
    // Buton metnini yeni kayıt için ayarla
    const saveBtn = document.getElementById('saveBacaBilgileriBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Kaydet';
        saveBtn.className = 'btn btn-success btn-sm';
    }
    
    console.log('Baca parametreleri API çağrısı yapılıyor...');
    
    // Baca parametrelerini API'den al
    fetch('/api/baca_parametreleri')
        .then(response => {
            console.log('API yanıtı alındı:', response);
            return response.json();
        })
        .then(data => {
            console.log('Baca parametreleri yüklendi:', data);
            
            // Baca parametrelerini global değişkende sakla
            window.bacaParametreleri = data;
            
            bacaBilgileriFields.innerHTML = '';
            
            // Basit form alanları oluştur
            data.forEach((parametre, index) => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-md-3 mb-2';
                
                let inputHtml = '';
                if (parametre.liste_icerigi && parametre.liste_icerigi.trim()) {
                    const options = parametre.liste_icerigi.split(',').map(item => item.trim()).filter(item => item);
                    inputHtml = `<select class="form-select" name="baca_bilgi_${parametre.id}" id="baca_bilgi_${parametre.id}">
                        <option value="">Seçin...</option>`;
                    options.forEach(option => {
                        inputHtml += `<option value="${option}">${option}</option>`;
                    });
                    inputHtml += '</select>';
                } else {
                    inputHtml = `<input type="text" class="form-control" name="baca_bilgi_${parametre.id}" id="baca_bilgi_${parametre.id}" placeholder="${parametre.baca_par_adi}">`;
                }
                
                col.innerHTML = `
                    <div class="d-flex align-items-center">
                        <label class="form-label me-2 mb-0" style="min-width: 100px;">${parametre.baca_par_adi}:</label>
                        ${inputHtml}
                    </div>
                `;
                
                bacaBilgileriFields.appendChild(col);
            });
            
            console.log('Form alanları oluşturuldu');
            
            // Sayfayı formun olduğu kısma kaydır
            bacaBilgileriForm.scrollIntoView({ behavior: 'smooth' });
            
            // Callback varsa çağır
            if (callback && typeof callback === 'function') {
                console.log('Callback çağrılıyor...');
                callback();
            }
            
            console.log('Form başarıyla yüklendi');
        })
        .catch(error => {
            console.error('Baca parametreleri yüklenirken hata:', error);
            alert('Baca parametreleri yüklenirken hata oluştu: ' + error.message);
        });
}

// Baca bilgilerini kaydet
function saveBacaBilgileri() {
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const bacaAdi = document.getElementById('bacaSelect').value;
    
    if (!firmaAdi || !olcumKodu || !bacaAdi) {
        alert('Lütfen firma, ölçüm kodu ve baca seçin!');
        return;
    }
    
    // Düzenleme modunda mı kontrol et
    const isEditMode = window.editingRowId !== null;
    
    // Form verilerini topla
    const formData = new FormData();
    formData.append('firma_adi', firmaAdi);
    formData.append('olcum_kodu', olcumKodu);
    formData.append('baca_adi', bacaAdi);
    formData.append('is_edit', isEditMode);
    
    // Düzenleme modunda ise kayıt ID'sini ekle
    if (isEditMode) {
        formData.append('record_id', window.editingRowId);
    }
    
    // Baca bilgilerini topla
    const bacaBilgileri = {};
    document.querySelectorAll('[id^="baca_bilgi_"]').forEach(input => {
        const bilgiId = input.id.replace('baca_bilgi_', '');
        // Boş değerleri de kabul et (zorunlu değil)
        bacaBilgileri[bilgiId] = input.value || '';
    });
    
    // Personel bilgisini al
    const personelSelect = document.getElementById('personelSelect');
    const personelAdi = personelSelect.value || '';
    
    // Kayıt tarihini al
    const kayitTarihiInput = document.getElementById('bacaKayitTarihi');
    let kayitTarihi = '';
    if (kayitTarihiInput.value) {
        const formattedDate = kayitTarihiInput.getAttribute('data-formatted-date');
        kayitTarihi = formattedDate || kayitTarihiInput.value;
    } else {
        // Tarih girilmemişse bugünün tarihini kullan
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = String(today.getFullYear()).slice(-2);
        kayitTarihi = `${day}.${month}.${year}`;
    }
    
    formData.append('baca_bilgileri', JSON.stringify(bacaBilgileri));
    formData.append('kayit_tarihi', kayitTarihi);
    formData.append('personel_adi', personelAdi);
    
    // Fotoğraf varsa ekle
    if (window.selectedPhoto) {
        formData.append('photo', window.selectedPhoto);
    }
    
    // Backend'e gönder
    fetch('/save_baca_bilgileri_saha', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (isEditMode) {
                alert('Baca bilgileri başarıyla güncellendi!');
                
                // Mevcut satırı güncelle
                updateExistingBacaBilgileriRow(firmaAdi, olcumKodu, bacaAdi, bacaBilgileri, data.photo_path, personelAdi);
            } else {
                alert('Baca bilgileri başarıyla kaydedildi!');
                
                // Tabloya yeni kaydı ekle
                const kayitTarihiInput = document.getElementById('bacaKayitTarihi');
                const kayitTarihi = kayitTarihiInput.getAttribute('data-formatted-date') || 
                                   (kayitTarihiInput.value ? new Date(kayitTarihiInput.value).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'}) : 
                                   new Date().toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'}));
                addBacaBilgileriToTable(firmaAdi, olcumKodu, bacaAdi, bacaBilgileri, data.photo_path, kayitTarihi, personelAdi);
            }
            
            // Formu temizle ve normal moda dön
            clearBacaBilgileriForm();
            resetSaveButton();
            
            // Baca bilgileri tablosunu yeniden yükle
            loadBacaBilgileri();
            
            // Parametre seçimini aktif et
            loadParametreListesiForBaca(firmaAdi, olcumKodu, bacaAdi);
            
            // Parametre ölçümlerini yeniden yükle
            loadParametreOlcumleri();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu! Lütfen tekrar deneyin.');
    });
}

// Save butonunu normal moda döndür
function resetSaveButton() {
    const saveBtn = document.getElementById('saveBacaBilgileriBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Kaydet';
        saveBtn.className = 'btn btn-success btn-sm';
    }
    window.editingRowId = null;
}

// Baca bilgileri kaydedildikten sonra parametre listesini yükle
function loadParametreListesiForBaca(firmaAdi, olcumKodu, bacaAdi) {
    const parametreSelect = document.getElementById('parametreSelect');
    
    fetch(`/api/parametre_listesi/${encodeURIComponent(firmaAdi)}/${encodeURIComponent(olcumKodu)}/${encodeURIComponent(bacaAdi)}`)
        .then(response => response.json())
        .then(data => {
            parametreSelect.innerHTML = '<option value="">Parametre seçin...</option>';
            
            data.forEach(parametre => {
                const option = document.createElement('option');
                option.value = parametre.parametre_adi;
                option.textContent = parametre.parametre_adi;
                parametreSelect.appendChild(option);
            });
            
            // Parametre seçimini aktif et
            parametreSelect.disabled = false;
        })
        .catch(error => {
            console.error('Parametre listesi yüklenirken hata:', error);
        });
}

// Parametre seçildiğinde ölçüm formunu yükle
function loadOlcumFormu() {
    const bacaAdi = document.getElementById('bacaSelect').value;
    const parametreAdi = document.getElementById('parametreSelect').value;
    
    if (!parametreAdi) {
        return;
    }
    
    // Seçilen parametre adını göster
    document.getElementById('selectedParametreName').textContent = parametreAdi;
    
    // Parametre ölçüm formunu göster
    loadParametreOlcumForm(parametreAdi);
}

// Parametre ölçüm formunu yükle
function loadParametreOlcumForm(parametreAdi) {
    const parametreOlcumForm = document.getElementById('parametreOlcumForm');
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    
    // Formu göster
    parametreOlcumForm.style.display = 'block';
    
    // PAR_SAHA'daki parametre alanlarını yükle
    parametreOlcumFields.innerHTML = createParametreOlcumFormFromPARSAHA(parametreAdi);
}

// PAR_SAHA'daki parametre alanlarını kullanarak form oluştur
function createParametreOlcumFormFromPARSAHA(parametreAdi) {
    return new Promise((resolve, reject) => {
        // Parametre tipini belirle - büyük/küçük harf duyarsız
        let parametreTipi = '';
        const parametreAdiUpper = parametreAdi.toUpperCase();
        
        if (['TOZ', 'A.MET', 'AMET', 'SÜLF.A', 'HF', 'HCL', 'AMON.', 'FORM.', 'CR6', 'FOSF.A.', 'HCN'].includes(parametreAdiUpper)) {
            parametreTipi = 'genel';
        } else if (parametreAdiUpper === 'NEM') {
            parametreTipi = 'nem';
        } else if (parametreAdiUpper === 'YG') {
            parametreTipi = 'yg';
        } else if (parametreAdiUpper === 'TOC') {
            parametreTipi = 'toc';
        } else if (parametreAdiUpper === 'VOC') {
            parametreTipi = 'voc';
        } else if (parametreAdiUpper === 'PM10') {
            parametreTipi = 'pm10';
        } else if (parametreAdiUpper === 'ÇT') {
            parametreTipi = 'ct';
        }
        
        // API'den parametre metodlarını al ve form oluştur
        fetch('/api/parametre_metodlari')
            .then(response => response.json())
            .then(parametreMetotlari => {
                // Parametre metodunu al
                const parametreMetodu = parametreMetotlari[parametreAdiUpper] || '';
                
                // Form oluştur
                createFormWithMetod(parametreTipi, parametreAdi, parametreAdiUpper, parametreMetodu);
                resolve(); // Form oluşturuldu, Promise'i çöz
            })
            .catch(error => {
                console.error('Parametre metodları yüklenirken hata:', error);
                // Hata durumunda boş metod ile form oluştur
                createFormWithMetod(parametreTipi, parametreAdi, parametreAdiUpper, '');
                resolve(); // Hata olsa da form oluşturuldu, Promise'i çöz
            });
    });
}

// Metod bilgisi ile form oluştur
function createFormWithMetod(parametreTipi, parametreAdi, parametreAdiUpper, parametreMetodu) {
    
    // Parametre alanlarını tanımla - PAR_SAHA tablosundaki gerçek alanlar
    const parametreAlanlari = {
        'genel': [ // TOZ, A.MET, SÜLF.A, HF, HCL, AMON., FORM., CR6, FOSF.A., HCN için
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'METOT', type: 'dynamic', parametreAdi: parametreAdiUpper }, // Dinamik metot seçimi
            { name: 'NOZZLE ÇAP', type: 'single', placeholder: '3,2' },
            { name: 'TRAVERS', type: 'single', placeholder: '16' },
            { name: 'B.HIZ', type: 'triple', placeholder: '6,2-6,7-6,8' },
            { name: 'B.SIC', type: 'triple', placeholder: '44-46-48' },
            { name: 'B.BAS(KPA)', type: 'triple', placeholder: '101,3-101,5-101,2' },
            { name: 'B.NEM(G/M3)', type: 'triple', placeholder: '12,5-13,2-12,8' },
            { name: 'B.NEM(%)', type: 'triple', placeholder: '45-48-46' },
            { name: 'SYC.HAC.', type: 'triple', placeholder: '0,5-0,6-0,5' },
            { name: 'SYC.İLK', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'SYC.SON', type: 'triple', placeholder: '0,4-0,5-0,4' },
            { name: 'SYC.SIC', type: 'triple', placeholder: '25-26-25' },
            { name: 'DEBİ', type: 'triple', placeholder: '100-105-102' },
            { name: 'ISDL', type: 'triple', placeholder: '0,1-0,2-0,1' }
        ],
        'nem': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: '1İMP-İ', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: '1-İMP-S', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: '2-İMP-İ', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: '2-İMP-S', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: '3-İMP-İ', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: '3-İMP-S', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'HAC.', type: 'triple', placeholder: '0,5-0,6-0,5' }
        ],
        'yg': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'B.SIC', type: 'triple', placeholder: '44-46-48' },
            { name: 'O2', type: 'triple', placeholder: '5,2-5,5-5,3' },
            { name: 'CO', type: 'triple', placeholder: '50-55-52' },
            { name: 'NO', type: 'triple', placeholder: '100-110-105' },
            { name: 'NOX', type: 'triple', placeholder: '150-160-155' },
            { name: 'SO2', type: 'triple', placeholder: '200-220-210' },
            { name: 'KK1-O2', type: 'triple', placeholder: '5,2-5,5-5,3' },
            { name: 'KK1-CO', type: 'triple', placeholder: '50-55-52' },
            { name: 'KK1-NO', type: 'triple', placeholder: '100-110-105' },
            { name: 'KK1-SO2', type: 'triple', placeholder: '200-220-210' },
            { name: 'KK2-O2', type: 'triple', placeholder: '5,2-5,5-5,3' },
            { name: 'KK2-CO', type: 'triple', placeholder: '50-55-52' },
            { name: 'KK2-NO', type: 'triple', placeholder: '100-110-105' },
            { name: 'KK2-SO2', type: 'triple', placeholder: '200-220-210' },
            { name: 'T90', type: 'triple', placeholder: '180-185-182' }
        ],
        'toc': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'B.NEM', type: 'triple', placeholder: '12,5-13,2-12,8' },
            { name: 'B.SIC', type: 'triple', placeholder: '44-46-48' },
            { name: 'TOC(PPM)', type: 'triple', placeholder: '10-12-11' },
            { name: 'KK1-O', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'KK1-SPAN', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'KK2-O', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'KK2-SPAN', type: 'triple', placeholder: '0,1-0,2-0,1' }
        ],
        'voc': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'GAZ HAC.', type: 'triple', placeholder: '100-105-102' },
            { name: 'GAZ.SIC.', type: 'triple', placeholder: '25-26-25' },
            { name: 'SEY.GAZ.HAC', type: 'triple', placeholder: '0,5-0,6-0,5' },
            { name: 'SEY.GAZ.SIC', type: 'triple', placeholder: '25-26-25' }
        ],
        'pm10': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'METOT', type: 'single', placeholder: 'TS 9096' },
            { name: 'ORT.SIC', type: 'triple', placeholder: '25-26-25' },
            { name: 'ORT.NEM', type: 'triple', placeholder: '45-48-46' },
            { name: 'ORT.RUZ.HIZ', type: 'triple', placeholder: '2,5-3,0-2,8' },
            { name: 'ÇEK.HACİM', type: 'triple', placeholder: '100-105-102' },
            { name: 'SYC.İLK', type: 'triple', placeholder: '0,1-0,2-0,1' },
            { name: 'SYC.SON', type: 'triple', placeholder: '0,4-0,5-0,4' },
            { name: 'ISDL', type: 'triple', placeholder: '0,1-0,2-0,1' }
        ],
        'ct': [
            { name: 'TARİH', type: 'date', placeholder: 'GG.AA.YY' },
            { name: 'T.İÇİ-1', type: 'triple', placeholder: '25-26-25' },
            { name: 'T.İÇİ-2', type: 'triple', placeholder: '25-26-25' },
            { name: 'T.İÇİ-3', type: 'triple', placeholder: '25-26-25' },
            { name: 'T.İÇİ-4', type: 'triple', placeholder: '25-26-25' },
            { name: 'T-DIŞ-1', type: 'triple', placeholder: '20-21-20' },
            { name: 'T.DIŞ-2', type: 'triple', placeholder: '20-21-20' },
            { name: 'T.DIŞ-3', type: 'triple', placeholder: '20-21-20' },
            { name: 'TDİS-4', type: 'triple', placeholder: '20-21-20' },
            { name: 'İLK KURULUM', type: 'triple', placeholder: '25-26-25' },
            { name: '2. KURULUM', type: 'triple', placeholder: '25-26-25' },
            { name: 'TOPLAMA', type: 'triple', placeholder: '25-26-25' }
        ]
    };
    
    const alanlar = parametreAlanlari[parametreTipi] || [];
    
    let formHTML = `
        <div class="col-12">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>${parametreAdi}</strong> parametresi için ölçüm değerlerini girin.
                <br><small class="text-muted">Tek değer olanlar: TARİH, METOT, NOZZLE ÇAP, TRAVERS | Diğerleri: 3 ölçüm (araya "-" koyarak)</small>
            </div>
        </div>
    `;
    
    // İlk 4 alanı yan yana düzenle (TARİH, METOT, NOZZLE ÇAP, TRAVERS)
    const ilk4Alan = alanlar.slice(0, 4);
    formHTML += `<div class="row mb-3">`;
    
    ilk4Alan.forEach((alan, index) => {
        if (alan.type === 'select') {
            let optionsHTML = '<option value="">Seçin...</option>';
            alan.options.forEach(option => {
                optionsHTML += `<option value="${option}">${option}</option>`;
            });
            
            formHTML += `
                <div class="col-md-3 mb-2">
                    <div class="d-flex align-items-center">
                        <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                        <select class="form-select form-select-sm" id="parametre_${parametreTipi}_${index}" 
                                name="${alan.name}" data-parametre="${parametreAdi}" data-alan="${alan.name}">
                            ${optionsHTML}
                        </select>
                    </div>
                </div>
            `;
        } else if (alan.type === 'dynamic' && alan.name === 'METOT') {
            // Dinamik metot seçimi
            let metotHTML = '';
            
            // Toz parametresi için özel kontrol
            if (parametreAdiUpper === 'TOZ') {
                // Toz için sabit metod seçenekleri
                const tozMetotlari = ['EPA 5', 'EPA 17', 'TS 9096', 'TS EN 13284-1'];
                metotHTML = '<option value="">Seçin...</option>';
                tozMetotlari.forEach(metot => {
                    metotHTML += `<option value="${metot}">${metot}</option>`;
                });
                
                formHTML += `
                    <div class="col-md-3 mb-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                            <select class="form-select form-select-sm" id="parametre_${parametreTipi}_${index}" 
                                    name="${alan.name}" data-parametre="${parametreAdi}" data-alan="${alan.name}">
                                ${metotHTML}
                            </select>
                        </div>
                    </div>
                `;
            } else if (parametreMetodu && parametreMetodu.includes(',')) {
                // Virgülle ayrılmış çoklu seçenek varsa dropdown
                const metotlar = parametreMetodu.split(',').map(m => m.trim());
                metotHTML = '<option value="">Seçin...</option>';
                metotlar.forEach(metot => {
                    metotHTML += `<option value="${metot}">${metot}</option>`;
                });
                
                formHTML += `
                    <div class="col-md-3 mb-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                            <select class="form-select form-select-sm" id="parametre_${parametreTipi}_${index}" 
                                    name="${alan.name}" data-parametre="${parametreAdi}" data-alan="${alan.name}">
                                ${metotHTML}
                            </select>
                        </div>
                    </div>
                `;
            } else if (parametreMetodu) {
                // Tek seçenek varsa otomatik doldur
                formHTML += `
                    <div class="col-md-3 mb-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                            <input type="text" class="form-control form-control-sm" id="parametre_${parametreTipi}_${index}" 
                                   name="${alan.name}" value="${parametreMetodu}" readonly
                                   data-parametre="${parametreAdi}" data-alan="${alan.name}">
                        </div>
                    </div>
                `;
            } else {
                // Metod tanımlanmamışsa boş input
                formHTML += `
                    <div class="col-md-3 mb-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                            <input type="text" class="form-control form-control-sm" id="parametre_${parametreTipi}_${index}" 
                                   name="${alan.name}" placeholder="Metod girin"
                                   data-parametre="${parametreAdi}" data-alan="${alan.name}">
                        </div>
                    </div>
                `;
            }
        } else if (alan.type === 'date') {
            formHTML += `
                <div class="col-md-3 mb-2">
                    <div class="d-flex align-items-center">
                        <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                        <input type="date" class="form-control form-control-sm" id="parametre_${parametreTipi}_${index}" 
                               name="${alan.name}" placeholder="${alan.placeholder}" 
                               data-parametre="${parametreAdi}" data-alan="${alan.name}"
                               onchange="formatDate(this)">
                    </div>
                </div>
            `;
        } else {
            formHTML += `
                <div class="col-md-3 mb-2">
                    <div class="d-flex align-items-center">
                        <label class="form-label fw-bold me-2 mb-0" style="min-width: 80px;">${alan.name}:</label>
                        <input type="text" class="form-control form-control-sm" id="parametre_${parametreTipi}_${index}" 
                               name="${alan.name}" placeholder="${alan.placeholder}" 
                               data-parametre="${parametreAdi}" data-alan="${alan.name}">
                    </div>
                </div>
            `;
        }
    });
    
    formHTML += `</div>`;
    
    // Kalan alanları 5'erli gruplar halinde düzenle
    const kalanAlanlar = alanlar.slice(4);
    for (let i = 0; i < kalanAlanlar.length; i += 5) {
        const grup = kalanAlanlar.slice(i, i + 5);
        
        formHTML += `<div class="row mb-3">`;
        
        grup.forEach((alan, grupIndex) => {
            const index = i + grupIndex + 4; // +4 çünkü ilk 4 alanı atladık
            
            formHTML += `
                <div class="col-md-2 mb-2">
                    <div class="d-flex align-items-center">
                        <label class="form-label fw-bold small me-2 mb-0" style="min-width: 60px;">${alan.name}:</label>
                        <input type="text" class="form-control form-control-sm" id="parametre_${parametreTipi}_${index}" 
                               name="${alan.name}" placeholder="${alan.placeholder}" 
                               data-parametre="${parametreAdi}" data-alan="${alan.name}"
                               title="3 ölçüm değeri girin (örn: 6,2-6,7-6,8)">
                    </div>
                </div>
            `;
        });
        
        formHTML += `</div>`;
    }
    
    // Formu DOM'a ekle
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    if (parametreOlcumFields) {
        parametreOlcumFields.innerHTML = formHTML;
        console.log('Parametre formu oluşturuldu');
    }
}

// Parametre ölçüm formunu oluştur (eski fonksiyon - artık kullanılmıyor)
function createParametreOlcumForm(parametre, parametreAdi) {
    return `
        <div class="col-12">
            <div class="alert alert-success mb-3">
                <i class="fas fa-flask me-2"></i>
                <strong>${parametreAdi}</strong> parametresi için ölçüm formu
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <label class="form-label">Metot:</label>
            <input type="text" class="form-control" value="${parametre['Metot'] || ''}" readonly>
        </div>
        
        <div class="col-md-6 mb-3">
            <label class="form-label">İzo Oran:</label>
            <input type="text" class="form-control" value="${parametre['İzo Oran'] || ''}" readonly>
        </div>
        
        <div class="col-md-4 mb-3">
            <label class="form-label">Nozzle:</label>
            <input type="text" class="form-control" value="${parametre['Nozzle'] || ''}" readonly>
        </div>
        
        <div class="col-md-4 mb-3">
            <label class="form-label">L/DAK:</label>
            <input type="text" class="form-control" value="${parametre['L/DAK'] || ''}" readonly>
        </div>
        
        <div class="col-md-4 mb-3">
            <label class="form-label">T.HAC:</label>
            <input type="text" class="form-control" value="${parametre['T.HAC'] || ''}" readonly>
        </div>
        
        <div class="col-md-3 mb-3">
            <label class="form-label">1. İmp:</label>
            <input type="text" class="form-control" value="${parametre['1. İmp'] || ''}" readonly>
        </div>
        
        <div class="col-md-3 mb-3">
            <label class="form-label">2. İmp:</label>
            <input type="text" class="form-control" value="${parametre['2. İmp'] || ''}" readonly>
        </div>
        
        <div class="col-md-3 mb-3">
            <label class="form-label">3. İmp:</label>
            <input type="text" class="form-control" value="${parametre['3. İmp'] || ''}" readonly>
        </div>
        
        <div class="col-md-3 mb-3">
            <label class="form-label">4. İmp:</label>
            <input type="text" class="form-control" value="${parametre['4. İmp'] || ''}" readonly>
        </div>
        
        <div class="col-12">
            <hr class="my-4">
            <h6 class="text-primary mb-3">Ölçüm Sonuçları</h6>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_sonucu" class="form-label">Ölçüm Sonucu:</label>
            <input type="number" step="0.01" class="form-control" id="olcum_sonucu" name="olcum_sonucu" placeholder="Ölçüm sonucunu girin">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_birimi" class="form-label">Birim:</label>
            <select class="form-select" id="olcum_birimi" name="olcum_birimi">
                <option value="">Birim seçin...</option>
                <option value="mg/m³">mg/m³</option>
                <option value="μg/m³">μg/m³</option>
                <option value="ppm">ppm</option>
                <option value="ppb">ppb</option>
                <option value="%">%</option>
                <option value="°C">°C</option>
                <option value="m/s">m/s</option>
            </select>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_tarihi" class="form-label">Ölçüm Tarihi:</label>
            <input type="datetime-local" class="form-control" id="olcum_tarihi" name="olcum_tarihi" value="${new Date().toISOString().slice(0, 16)}">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_saati" class="form-label">Ölçüm Saati:</label>
            <input type="time" class="form-control" id="olcum_saati" name="olcum_saati" value="${new Date().toTimeString().slice(0, 5)}">
        </div>
        
        <div class="col-12 mb-3">
            <label for="olcum_notlari" class="form-label">Ölçüm Notları:</label>
            <textarea class="form-control" id="olcum_notlari" name="olcum_notlari" rows="3" placeholder="Ölçüm ile ilgili notlar..."></textarea>
        </div>
    `;
}

// Genel parametre formu oluştur
function createGeneralParametreForm(parametreAdi) {
    return `
        <div class="col-12">
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>${parametreAdi}</strong> parametresi için detaylı bilgi bulunamadı.
            </div>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_sonucu" class="form-label">Ölçüm Sonucu:</label>
            <input type="number" step="0.01" class="form-control" id="olcum_sonucu" name="olcum_sonucu" placeholder="Ölçüm sonucunu girin">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_birimi" class="form-label">Birim:</label>
            <select class="form-select" id="olcum_birimi" name="olcum_birimi">
                <option value="">Birim seçin...</option>
                <option value="mg/m³">mg/m³</option>
                <option value="μg/m³">μg/m³</option>
                <option value="ppm">ppm</option>
                <option value="ppb">ppb</option>
                <option value="%">%</option>
                <option value="°C">°C</option>
                <option value="m/s">m/s</option>
            </select>
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_tarihi" class="form-label">Ölçüm Tarihi:</label>
            <input type="datetime-local" class="form-control" id="olcum_tarihi" name="olcum_tarihi" value="${new Date().toISOString().slice(0, 16)}">
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="olcum_saati" class="form-label">Ölçüm Saati:</label>
            <input type="time" class="form-control" id="olcum_saati" name="olcum_saati" value="${new Date().toTimeString().slice(0, 5)}">
        </div>
        
        <div class="col-12 mb-3">
            <label for="olcum_notlari" class="form-label">Ölçüm Notları:</label>
            <textarea class="form-control" id="olcum_notlari" name="olcum_notlari" rows="3" placeholder="Ölçüm ile ilgili notlar..."></textarea>
        </div>
    `;
}

// Parametre ölçümünü kaydet
function saveParametreOlcum() {
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const bacaAdi = document.getElementById('bacaSelect').value;
    const parametreAdi = document.getElementById('parametreSelect').value;
    
    if (!firmaAdi || !olcumKodu || !bacaAdi || !parametreAdi) {
        alert('Lütfen tüm gerekli alanları doldurun!');
        return;
    }
    
    // Form verilerini topla
    const formData = new FormData();
    formData.append('firma_adi', firmaAdi);
    formData.append('olcum_kodu', olcumKodu);
    formData.append('baca_adi', bacaAdi);
    formData.append('parametre_adi', parametreAdi);
    
    // Parametre alanlarını topla
    const parametreVerileri = {};
    const inputs = document.querySelectorAll('#parametreOlcumForm input[data-parametre]');
    const selects = document.querySelectorAll('#parametreOlcumForm select[data-parametre]');
    
    // Input değerlerini topla
    inputs.forEach(input => {
        const alanAdi = input.getAttribute('data-alan');
        let deger = input.value.trim();
        
        // Eğer tarih alanıysa ve formatlanmış tarih varsa onu kullan
        if (input.type === 'date' && input.getAttribute('data-formatted-date')) {
            deger = input.getAttribute('data-formatted-date');
        }
        
        if (deger) {
            parametreVerileri[alanAdi] = deger;
        }
    });
    
    // Select değerlerini topla
    selects.forEach(select => {
        const alanAdi = select.getAttribute('data-alan');
        const deger = select.value.trim();
        
        if (deger) {
            parametreVerileri[alanAdi] = deger;
        }
    });
    
    // Parametre verilerini JSON olarak ekle
    formData.append('parametre_verileri', JSON.stringify(parametreVerileri));
    
    // Backend'e gönder
    fetch('/save_parametre_olcum_saha', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Parametre ölçümü başarıyla kaydedildi!');
            
            // Formu temizle
            clearParametreOlcumForm();
            
            // Parametre ölçüm formunu gizle
            document.getElementById('parametreOlcumForm').style.display = 'none';
            
            // Parametre ölçümleri tablosunu yenile
            loadParametreOlcumleri();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu! Lütfen tekrar deneyin.');
    });
}

// Parametre ölçüm formunu temizle
function clearParametreOlcumForm() {
    const inputs = document.querySelectorAll('#parametreOlcumForm input[data-parametre]');
    const selects = document.querySelectorAll('#parametreOlcumForm select[data-parametre]');
    
    inputs.forEach(input => {
        input.value = '';
    });
    
    selects.forEach(select => {
        select.value = '';
    });
}

// ===== FOTOĞRAF İŞLEME FONKSİYONLARI =====

// Kamera ile fotoğraf çek
function openCamera() {
    const photoInput = document.getElementById('photoInput');
    photoInput.setAttribute('capture', 'environment'); // Arka kamera
    photoInput.click();
}

// Galeriden fotoğraf seç
function selectFromGallery() {
    const photoInput = document.getElementById('photoInput');
    photoInput.removeAttribute('capture'); // Kamera zorlaması kaldır
    photoInput.click();
}

// Fotoğraf seçildiğinde
function handlePhotoSelect(event) {
    const file = event.target.files[0];
    if (file) {
        // Dosya boyutu kontrolü (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Fotoğraf boyutu 5MB\'dan küçük olmalıdır!');
            return;
        }
        
        // Dosya tipi kontrolü
        if (!file.type.startsWith('image/')) {
            alert('Lütfen geçerli bir fotoğraf dosyası seçin!');
            return;
        }
        
        // Önizleme göster
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImage = document.getElementById('previewImage');
            const photoPreview = document.getElementById('photoPreview');
            
            previewImage.src = e.target.result;
            photoPreview.style.display = 'block';
            
            // Fotoğrafı global değişkende sakla
            window.selectedPhoto = file;
        };
        reader.readAsDataURL(file);
    }
}

// Fotoğrafı kaldır
function removePhoto() {
    const photoPreview = document.getElementById('photoPreview');
    const photoInput = document.getElementById('photoInput');
    
    photoPreview.style.display = 'none';
    photoInput.value = '';
    window.selectedPhoto = null;
    
    // Önizleme resmini temizle
    const previewImage = document.getElementById('previewImage');
    previewImage.src = '';
}

// ===== TABLO İŞLEME FONKSİYONLARI =====

// Baca bilgilerini tabloya ekle
function addBacaBilgileriToTable(firmaAdi, olcumKodu, bacaAdi, bacaBilgileri, photoPath, kayitTarihi, personelAdi) {
    const tableBody = document.getElementById('bacaBilgileriTableBody');
    const emptyMessage = document.getElementById('emptyMessage');
    
    // Boş mesajı gizle
    emptyMessage.style.display = 'none';
    
    // Yeni satır oluştur
    const newRow = document.createElement('tr');
    const rowId = Date.now(); // Benzersiz ID
    newRow.id = `row_${rowId}`;
    
    // Baca parametrelerini al
    const bacaParametreleri = window.bacaParametreleri || [];
    
    // Baca bilgilerini JSON formatında sakla
    const bacaBilgileriJSON = JSON.stringify(bacaBilgileri);
    
    // Satır içeriğini oluştur
    newRow.innerHTML = `
        <td>
            <input type="checkbox" class="row-checkbox" value="${rowId}">
        </td>
        <td>${tableBody.children.length + 1}</td>
        <td>${firmaAdi}</td>
        <td>${olcumKodu}</td>
        <td>${bacaAdi}</td>
        <td data-baca-bilgileri="${bacaBilgileriJSON}">
            <div class="btn-group btn-group-sm" role="group" style="font-size: 0.75rem;">
                <button type="button" class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewBacaBilgileri('${rowId}')" title="Görüntüle">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editBacaBilgileri('${rowId}')" title="Düzenle">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteBacaBilgileri('${rowId}')" title="Sil">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
        <td style="text-align: center;">${bacaBilgileri['7425ab86-4cfb-4796-bd2c-a84c3f1c61a4'] || '*'}</td>
        <td>${bacaBilgileri['7647078a-4f69-4908-99f7-3fff5651cc9b'] || '*'}</td>
        <td>${bacaBilgileri['2360aa46-81dd-41db-a6b6-5c23e62900fe'] || '*'}</td>
        <td>${bacaBilgileri['6774fc7e-c124-4272-b826-482d064f3215'] || '*'}</td>
        <td>${bacaBilgileri['3f622008-8178-460c-a6a1-c5f4eb357231'] || '*'}</td>
        <td>${bacaBilgileri['2517064c-c286-4210-8f60-fa0a6b9e22a9'] || '*'}</td>
        <td>${bacaBilgileri['f1e7b875-ddf4-4628-87a3-eda6afa775b7'] || '*'}</td>
        <td>${bacaBilgileri['394272bc-a8dc-46c4-a1a8-15ed4c0dbf29'] || '*'}</td>
        <td>${bacaBilgileri['943f1111-1be7-4dd3-b62d-b734963c768e'] || '*'}</td>
        <td>${bacaBilgileri['eba873d9-1398-4fde-9ef0-851359037990'] || '*'}</td>
        <td>${bacaBilgileri['5ab155d9-a52d-4359-abbf-bd3083e216da'] || '*'}</td>
        <td>${bacaBilgileri['dea8eb12-71c2-4af4-a280-acd5eac4660b'] || '*'}</td>
        <td>${bacaBilgileri['922ab008-e6ec-442c-a2ee-4159b6ce948e'] || '*'}</td>
        <td>${bacaBilgileri['0c47bc1d-afdf-477a-94b8-abb2c1d6f92c'] || '*'}</td>
        <td>${bacaBilgileri['f59ec1f6-f93e-49a7-ac11-c33ce327987a'] || '*'}</td>
        <td>${bacaBilgileri['0e9de9b8-d7a4-4125-b299-747e47c71b4b'] || '*'}</td>
        <td>
            ${photoPath ? `<img src="/static/${photoPath}" class="img-thumbnail" style="max-width: 50px; max-height: 50px;" onclick="showPhotoModal('${photoPath}')" title="Fotoğrafı büyüt">` : '*'}
        </td>
        <td>${personelAdi || '*'}</td>
        <td>${kayitTarihi || new Date().toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'})}</td>
    `;
    
    // Satırı tabloya ekle
    tableBody.appendChild(newRow);
    
    // Satır numaralarını güncelle
    updateRowNumbers();
}

// Baca parametrelerini al (sıralı)
function getBacaParametreleri() {
    // Global değişkenden baca parametrelerini al
    if (window.bacaParametreleri && Array.isArray(window.bacaParametreleri)) {
        return window.bacaParametreleri;
    }
    
    // Eğer henüz yüklenmemişse, API'den yükle
    return fetch('/api/baca_parametreleri')
        .then(response => response.json())
        .then(data => {
            window.bacaParametreleri = data;
            return data;
        })
        .catch(error => {
            console.error('Baca parametreleri yüklenirken hata:', error);
            return [];
        });
}

// Satır numaralarını güncelle
function updateRowNumbers() {
    const rows = document.querySelectorAll('#bacaBilgileriTableBody tr');
    rows.forEach((row, index) => {
        const numberCell = row.querySelector('td:nth-child(2)');
        if (numberCell) {
            numberCell.textContent = index + 1;
        }
    });
}

// Baca bilgileri formunu temizle
function clearBacaBilgileriForm() {
    // Form alanlarını temizle
    document.querySelectorAll('[id^="baca_bilgi_"]').forEach(input => {
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
    
    // Kayıt tarihi alanını temizle
    const kayitTarihiInput = document.getElementById('bacaKayitTarihi');
    if (kayitTarihiInput) {
        kayitTarihiInput.value = '';
        kayitTarihiInput.removeAttribute('data-formatted-date');
    }
    
    // Fotoğrafı temizle
    removePhoto();
}

// Fotoğraf modalını göster
function showPhotoModal(photoPath) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'photoModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fotoğraf</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="/static/${photoPath}" class="img-fluid">
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Modal kapandığında elementi kaldır
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

// Baca bilgileri görüntüle
function viewBacaBilgileri(rowId) {
    alert('Baca bilgileri görüntüleme özelliği yakında eklenecek!');
}

// Baca bilgileri düzenle
function editBacaBilgileri(rowId) {
    console.log('editBacaBilgileri çağrıldı, rowId:', rowId);
    
    // Satırı bul
    const row = document.getElementById(`row_${rowId}`);
    if (!row) {
        alert('Satır bulunamadı!');
        return;
    }
    
    // Baca bilgilerini al (5. sütun - index 5)
    const bacaBilgileriJSON = row.children[5].getAttribute('data-baca-bilgileri');
    const bacaBilgileri = bacaBilgileriJSON ? JSON.parse(bacaBilgileriJSON) : {};
    console.log('Baca bilgileri:', bacaBilgileri);
    
    // Formu manuel olarak göster
    const form = document.getElementById('bacaBilgileriForm');
    if (!form) {
        alert('Baca bilgileri formu bulunamadı!');
        return;
    }
    
    form.style.display = 'block';
    
    // Baca parametrelerini yükle ve sonra verileri doldur
    fetch('/api/baca_parametreleri')
        .then(response => response.json())
        .then(data => {
            console.log('Baca parametreleri yüklendi:', data);
            window.bacaParametreleri = data;
            
            // Form alanlarını oluştur
            const bacaBilgileriFields = document.getElementById('bacaBilgileriFields');
            bacaBilgileriFields.innerHTML = '';
            
            // Basit form alanları oluştur
            data.forEach((parametre, index) => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-md-3 mb-2';
                
                let inputHtml = '';
                if (parametre.liste_icerigi && parametre.liste_icerigi.trim()) {
                    const options = parametre.liste_icerigi.split(',').map(item => item.trim()).filter(item => item);
                    inputHtml = `<select class="form-select" name="baca_bilgi_${parametre.id}" id="baca_bilgi_${parametre.id}">
                        <option value="">Seçin...</option>`;
                    options.forEach(option => {
                        inputHtml += `<option value="${option}">${option}</option>`;
                    });
                    inputHtml += '</select>';
                } else {
                    inputHtml = `<input type="text" class="form-control" name="baca_bilgi_${parametre.id}" id="baca_bilgi_${parametre.id}" placeholder="${parametre.baca_par_adi}">`;
                }
                
                col.innerHTML = `
                    <div class="d-flex align-items-center">
                        <label class="form-label me-2 mb-0" style="min-width: 100px;">${parametre.baca_par_adi}:</label>
                        ${inputHtml}
                    </div>
                `;
                
                bacaBilgileriFields.appendChild(col);
            });
            
            // Verileri doldur
            data.forEach(parametre => {
                const input = document.getElementById(`baca_bilgi_${parametre.id}`);
                if (input) {
                    const value = bacaBilgileri[parametre.id];
                    if (value && value.trim() !== '') {
                        input.value = value;
                    } else {
                        input.value = '*';
                    }
                }
            });
            
            // Düzenleme modunda olduğunu belirt
            window.editingRowId = rowId;
            
            // Buton metnini değiştir
            const saveBtn = document.getElementById('saveBacaBilgileriBtn');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Güncelle';
                saveBtn.className = 'btn btn-warning btn-sm';
            }
            
            // Sayfayı formun olduğu kısma kaydır
            form.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Form başarıyla yüklendi ve dolduruldu');
        })
        .catch(error => {
            console.error('Baca parametreleri yüklenirken hata:', error);
            alert('Baca parametreleri yüklenirken hata oluştu!');
        });
}

// Baca bilgileri görüntüle
function viewBacaBilgileri(rowId) {
    console.log('viewBacaBilgileri çağrıldı, rowId:', rowId);
    
    // Satırı bul
    const row = document.getElementById(`row_${rowId}`);
    if (!row) {
        alert('Satır bulunamadı!');
        return;
    }
    
    // Baca bilgilerini al
    const bacaBilgileriJSON = row.children[5].getAttribute('data-baca-bilgileri');
    const bacaBilgileri = bacaBilgileriJSON ? JSON.parse(bacaBilgileriJSON) : {};
    console.log('Baca bilgileri:', bacaBilgileri);
    
    // Modal oluştur veya mevcut modalı kullan
    let modal = document.getElementById('bacaBilgileriViewModal');
    if (!modal) {
        // Modal yoksa oluştur
        const modalHTML = `
            <div class="modal fade" id="bacaBilgileriViewModal" tabindex="-1" aria-labelledby="bacaBilgileriViewModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="bacaBilgileriViewModalLabel">
                                <i class="fas fa-chimney me-2"></i>Baca Bilgileri Detayları
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="bacaBilgileriViewContent">
                                <!-- Baca bilgileri buraya yüklenecek -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('bacaBilgileriViewModal');
    }
    
    // Firma, ölçüm kodu ve baca adı bilgileri
    const firmaAdi = row.children[2].textContent;
    const olcumKodu = row.children[3].textContent;
    const bacaAdi = row.children[4].textContent;
    
    // Baca parametrelerini ve ölçüm verilerini paralel olarak yükle
    Promise.all([
        fetch('/api/baca_parametreleri').then(response => response.json()),
        fetch('/api/parametre_olcumleri').then(response => response.json())
    ])
    .then(([bacaParametreleri, parametreOlcumleri]) => {
        console.log('Baca parametreleri yüklendi:', bacaParametreleri);
        console.log('Parametre ölçümleri yüklendi:', parametreOlcumleri);
        
        // Bu bacaya ait ölçümleri filtrele
        const bacaOlcumleri = parametreOlcumleri.filter(olcum => 
            olcum.firma_adi === firmaAdi && 
            olcum.olcum_kodu === olcumKodu && 
            olcum.baca_adi === bacaAdi
        );
        
        // Modal içeriğini oluştur
        let contentHTML = '<div class="row">';
        
        // Genel bilgiler
        contentHTML += `
            <div class="col-12 mb-3">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-info-circle me-2"></i>Genel Bilgiler</h6>
                        <div class="row">
                            <div class="col-md-4"><strong>Firma:</strong> ${firmaAdi}</div>
                            <div class="col-md-4"><strong>Ölçüm Kodu:</strong> ${olcumKodu}</div>
                            <div class="col-md-4"><strong>Baca Adı:</strong> ${bacaAdi}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Baca parametreleri
        contentHTML += '<div class="col-12 mb-3"><h6 class="mb-3"><i class="fas fa-chimney me-2"></i>Baca Parametreleri</h6></div>';
        
        bacaParametreleri.forEach((parametre, index) => {
            const value = bacaBilgileri[parametre.id];
            const displayValue = (value && value.trim() !== '') ? value : '*';
            contentHTML += `
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">${parametre.baca_par_adi}:</span>
                        <span>${displayValue}</span>
                    </div>
                </div>
            `;
        });
        
        // Ölçülen parametreler
        if (bacaOlcumleri.length > 0) {
            contentHTML += '<div class="col-12 mt-4"><h6 class="mb-3"><i class="fas fa-flask me-2"></i>Ölçülen Parametreler</h6></div>';
            
            bacaOlcumleri.forEach((olcum, index) => {
                contentHTML += `
                    <div class="col-12 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>${olcum.parametre_adi}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3"><strong>Metot:</strong> ${olcum.metot || '-'}</div>
                                    <div class="col-md-3"><strong>Sonuç:</strong> ${olcum.sonuc || '-'}</div>
                                    <div class="col-md-3"><strong>Birim:</strong> ${olcum.birim || '-'}</div>
                                    <div class="col-md-3"><strong>Tarih:</strong> ${olcum.olcum_tarihi || '-'}</div>
                                </div>
                                ${olcum.aciklama ? `<div class="mt-2"><strong>Açıklama:</strong> ${olcum.aciklama}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            contentHTML += `
                <div class="col-12 mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Bu bacada henüz parametre ölçümü yapılmamış.
                    </div>
                </div>
            `;
        }
        
        contentHTML += '</div>';
        
        // Modal içeriğini güncelle
        document.getElementById('bacaBilgileriViewContent').innerHTML = contentHTML;
        
        // Modalı göster
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
    })
    .catch(error => {
        console.error('Veriler yüklenirken hata:', error);
        alert('Veriler yüklenirken hata oluştu!');
    });
}

// Baca bilgileri sil
function deleteBacaBilgileri(rowId) {
    console.log('Silme isteği gönderiliyor, ID:', rowId);
    
    if (confirm('Bu baca bilgileri kaydını silmek istediğinizden emin misiniz?')) {
        // Backend'e silme isteği gönder
        fetch(`/api/baca_bilgileri/${rowId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            console.log('Backend yanıtı:', data);
            
            if (data.success) {
                // Başarılı silme - satırı tablodan kaldır
                const row = document.getElementById(`row_${rowId}`);
                console.log('Bulunan satır:', row);
                
                if (row) {
                    row.remove();
                    updateRowNumbers();
                    
                    // Eğer tablo boşsa boş mesajı göster
                    const tableBody = document.getElementById('bacaBilgileriTableBody');
                    if (tableBody.children.length === 0) {
                        document.getElementById('emptyMessage').style.display = 'block';
                    }
                    
                    // Başarı mesajı göster
                    alert('Baca bilgileri başarıyla silindi!');
                } else {
                    console.error('Satır bulunamadı, ID:', rowId);
                    // Satır bulunamadıysa tabloyu yenile
                    console.log('Tabloyu yeniliyor...');
                    loadSavedBacaBilgileri();
                    alert('Baca bilgileri silindi ve tablo yenilendi!');
                }
            } else {
                alert('Hata: ' + (data.error || 'Silme işlemi başarısız'));
            }
        })
        .catch(error => {
            console.error('Silme hatası:', error);
            alert('Silme işlemi sırasında bir hata oluştu!');
        });
    }
}

// Mevcut baca bilgileri satırını güncelle
function updateExistingBacaBilgileriRow(firmaAdi, olcumKodu, bacaAdi, bacaBilgileri, photoPath, personelAdi) {
    const tableBody = document.getElementById('bacaBilgileriTableBody');
    const existingRow = Array.from(tableBody.children).find(row => {
        const firmaCell = row.children[2]?.textContent.trim();
        const olcumCell = row.children[3]?.textContent.trim();
        const bacaCell = row.children[4]?.textContent.trim();
        return firmaCell === firmaAdi && olcumCell === olcumKodu && bacaCell === bacaAdi;
    });
    
    if (existingRow) {
        // Baca parametrelerini al
        const bacaParametreleri = window.bacaParametreleri || [];
        
        // Baca bilgilerini JSON formatında sakla
        const bacaBilgileriJSON = JSON.stringify(bacaBilgileri);
        
        // Satır içeriğini güncelle (BACA NO sütunu 7. sırada)
        existingRow.children[6].textContent = bacaBilgileri[bacaParametreleri[0]?.id] || '-';
        existingRow.children[6].style.textAlign = 'center';
        existingRow.children[7].textContent = bacaBilgileri[bacaParametreleri[1]?.id] || '-';
        existingRow.children[8].textContent = bacaBilgileri[bacaParametreleri[2]?.id] || '-';
        existingRow.children[9].textContent = bacaBilgileri[bacaParametreleri[3]?.id] || '-';
        existingRow.children[10].textContent = bacaBilgileri[bacaParametreleri[4]?.id] || '-';
        existingRow.children[11].textContent = bacaBilgileri[bacaParametreleri[5]?.id] || '-';
        existingRow.children[12].textContent = bacaBilgileri[bacaParametreleri[6]?.id] || '-';
        existingRow.children[13].textContent = bacaBilgileri[bacaParametreleri[7]?.id] || '-';
        existingRow.children[14].textContent = bacaBilgileri[bacaParametreleri[8]?.id] || '-';
        existingRow.children[15].textContent = bacaBilgileri[bacaParametreleri[9]?.id] || '-';
        existingRow.children[16].textContent = bacaBilgileri[bacaParametreleri[10]?.id] || '-';
        existingRow.children[17].textContent = bacaBilgileri[bacaParametreleri[11]?.id] || '-';
        existingRow.children[18].textContent = bacaBilgileri[bacaParametreleri[12]?.id] || '-';
        existingRow.children[19].textContent = bacaBilgileri[bacaParametreleri[13]?.id] || '-';
        existingRow.children[20].textContent = bacaBilgileri[bacaParametreleri[14]?.id] || '-';
        existingRow.children[21].textContent = bacaBilgileri[bacaParametreleri[15]?.id] || '-';
        existingRow.children[22].textContent = bacaBilgileri[bacaParametreleri[16]?.id] || '-';
        
        // Fotoğrafı güncelle (23. sütun)
        if (photoPath) {
            existingRow.children[23].innerHTML = `<img src="/static/${photoPath}" class="img-thumbnail" style="max-width: 50px; max-height: 50px;" onclick="showPhotoModal('${photoPath}')" title="Fotoğrafı büyüt">`;
        }
        
        // Personel bilgisini güncelle (24. sütun)
        existingRow.children[24].textContent = personelAdi || '-';
        
        // Tarihi güncelle (25. sütun)
        existingRow.children[25].textContent = new Date().toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'});
        
        // İşlem butonlarını güncelle (6. sütun)
        const buttonsCell = existingRow.children[5];
        const rowId = existingRow.id.replace('row_', '');
        buttonsCell.innerHTML = `
            <div class="btn-group btn-group-sm" role="group" style="font-size: 0.75rem;">
                <button type="button" class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewBacaBilgileri('${rowId}')" title="Görüntüle">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-warning btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editBacaBilgileri('${rowId}')" title="Düzenle">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteBacaBilgileri('${rowId}')" title="Sil">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // JSON verisini güncelle
        buttonsCell.setAttribute('data-baca-bilgileri', bacaBilgileriJSON);
    }
}

// Kaydet butonunu normal moda döndür
function resetSaveButton() {
    const saveBtn = document.getElementById('saveBacaBilgileriBtn');
    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Kaydet';
    saveBtn.className = 'btn btn-success btn-sm';
    
    // Düzenleme modunu temizle
    window.editingRowId = null;
}

// Tarih formatını GG.AA.YY'ye çevir
function formatDate(input) {
    if (input.value) {
        const date = new Date(input.value);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        
        // Input'un value'sunu GG.AA.YY formatında güncelle
        input.setAttribute('data-formatted-date', `${day}.${month}.${year}`);
        
        // Görüntü için placeholder'ı güncelle
        input.placeholder = `${day}.${month}.${year}`;
    }
}

// Baca kayıt tarihi formatını GG.AA.YY'ye çevir
function formatBacaKayitTarihi(input) {
    if (input.value) {
        const date = new Date(input.value);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        
        // Input'un value'sunu GG.AA.YY formatında güncelle
        input.setAttribute('data-formatted-date', `${day}.${month}.${year}`);
    }
}

// Parametre ölçümleri tablosu için dinamik başlık oluştur
function createParametreOlcumTableHeaders() {
    const tableHead = document.getElementById('parametreOlcumTableHead');
    
    // Tüm parametre alanlarını tanımla (resimdeki sırayla)
    const allParametreFields = {
        'TOZ, A.MET, SÜLF.A, HF, HCL, AMON., FORM., CR6, FOSF.A., HCN': [
            'TARİH', 'METOT', 'NOZZLE ÇAP', 'TRAVERS', 'B.HIZ', 'B.SIC', 'B.BAS(KPA)', 
            'B.NEM(G/M3)', 'B.NEM(%)', 'SYC.HAC.', 'SYC.İLK', 'SYC.SON', 'SYC.SIC', 'DEBİ', 'ISDL'
        ],
        'NEM': [
            'TARİH', '1İMP-İ', '1-İMP-S', '2-İMP-İ', '2-İMP-S', '3-İMP-İ', '3-İMP-S', 'HAC.'
        ],
        'YG': [
            'TARİH', 'B.SIC', 'O2', 'CO', 'NO', 'NOX', 'SO2', 'KK1-O2', 'KK1-CO', 'KK1-NO', 
            'KK1-SO2', 'KK2-O2', 'KK2-CO', 'KK2-NO', 'KK2-SO2', 'T90'
        ],
        'TOC': [
            'TARİH', 'B.NEM', 'B.SIC', 'TOC(PPM)', 'KK1-O', 'KK1-SPAN', 'KK2-O', 'KK2-SPAN'
        ],
        'VOC': [
            'TARİH', 'GAZ HAC.', 'GAZ.SIC.', 'SEY.GAZ.HAC', 'SEY.GAZ.SIC'
        ],
        'PM10': [
            'TARİH', 'METOT', 'ORT.SIC', 'ORT.NEM', 'ORT.RUZ.HIZ', 'ÇEK.HACİM', 
            'SYC.İLK', 'SYC.SON', 'ISDL'
        ],
        'ÇT': [
            'TARİH', 'T.İÇİ-1', 'T.İÇİ-2', 'T.İÇİ-3', 'T.İÇİ-4', 'T-DIŞ-1', 'T.DIŞ-2', 
            'T.DIŞ-3', 'T.DIŞ-4', 'İLK KURULUM', '2. KURULUM'
        ]
    };
    
    // Sabit başlıklar
    const sabitBasliklar = [
        { text: '', width: '50', checkbox: true },
        { text: '#', width: '60' },
        { text: 'Firma', width: 'auto' },
        { text: 'Ölçüm Kodu', width: 'auto' },
        { text: 'Baca', width: 'auto' },
        { text: 'Parametre', width: 'auto' },
        { text: 'İşlemler', width: '120' }
    ];
    
    // Tüm alanları sabit sırayla tanımla (loadParametreOlcumleri ile aynı sırada)
    const tumAlanlar = [
        'TARİH', 'METOT', 'NOZZLE ÇAP', 'TRAVERS', 'B.HIZ', 'B.SIC', 'B.BAS(KPA)', 
        'B.NEM(G/M3)', 'B.NEM(%)', 'SYC.HAC.', 'SYC.İLK', 'SYC.SON', 'SYC.SIC', 'DEBİ', 'ISDL',
        '1İMP-İ', '1-İMP-S', '2-İMP-İ', '2-İMP-S', '3-İMP-İ', '3-İMP-S', 'HAC.',
        'O2', 'CO', 'NO', 'NOX', 'SO2', 'KK1-O2', 'KK1-CO', 'KK1-NO', 'KK1-SO2', 
        'KK2-O2', 'KK2-CO', 'KK2-NO', 'KK2-SO2', 'T90',
        'TOC(PPM)', 'KK1-O', 'KK1-SPAN', 'KK2-O', 'KK2-SPAN',
        'GAZ HAC.', 'GAZ.SIC.', 'SEY.GAZ.HAC', 'SEY.GAZ.SIC',
        'ORT.SIC', 'ORT.NEM', 'ORT.RUZ.HIZ', 'ÇEK.HACİM',
        'T.İÇİ-1', 'T.İÇİ-2', 'T.İÇİ-3', 'T.İÇİ-4', 'T-DIŞ-1', 'T.DIŞ-2', 
        'T.DIŞ-3', 'T.DIŞ-4', 'İLK KURULUM', '2. KURULUM'
    ];
    
    // Başlık HTML'ini oluştur
    let headerHTML = '<tr>';
    
    // Sabit başlıklar
    sabitBasliklar.forEach(baslik => {
        if (baslik.checkbox) {
            headerHTML += `<th width="${baslik.width}">
                <input type="checkbox" id="selectAllParametre" onchange="toggleSelectAllParametre()">
            </th>`;
        } else {
            headerHTML += `<th width="${baslik.width}">${baslik.text}</th>`;
        }
    });
    
    // Parametre alanları
    tumAlanlar.forEach(alan => {
        headerHTML += `<th>${alan}</th>`;
    });
    
    // Son başlıklar
    headerHTML += `
        <th>Kayıt Tarihi</th>
    </tr>`;
    
    // Filtreleme satırı ekle
    headerHTML += '<tr class="table-light">';
    
    // Sabit başlıklar için filtreleme kutuları
    headerHTML += '<th></th>'; // Checkbox
    headerHTML += '<th></th>'; // #
    
    // Firma sütunu - hem süzme hem dropdown
    headerHTML += `<th>
        <input type="text" class="form-control form-control-sm mb-1" id="parametreFirmaFilter" placeholder="Firma filtrele..." onkeyup="filterParametreTable()">
        <select class="form-control form-control-sm" id="parametreFirmaDropdown" onchange="filterParametreTable()">
            <option value="">Tüm Firmalar</option>
        </select>
    </th>`;
    
    // Ölçüm Kodu sütunu - hem süzme hem dropdown
    headerHTML += `<th>
        <input type="text" class="form-control form-control-sm mb-1" id="parametreOlcumKoduFilter" placeholder="Ölçüm kodu filtrele..." onkeyup="filterParametreTable()">
        <select class="form-control form-control-sm" id="parametreOlcumKoduDropdown" onchange="filterParametreTable()">
            <option value="">Tüm Ölçüm Kodları</option>
        </select>
    </th>`;
    
    // Baca sütunu - hem süzme hem dropdown
    headerHTML += `<th>
        <input type="text" class="form-control form-control-sm mb-1" id="parametreBacaFilter" placeholder="Baca filtrele..." onkeyup="filterParametreTable()">
        <select class="form-control form-control-sm" id="parametreBacaDropdown" onchange="filterParametreTable()">
            <option value="">Tüm Bacalar</option>
        </select>
    </th>`;
    
    // Parametre sütunu - boş
    headerHTML += '<th></th>';
    
    headerHTML += '<th></th>'; // İşlemler
    
    // Parametre alanları için süzme kutuları (sadece Baca No için dropdown da ekle)
    tumAlanlar.forEach((alan, index) => {
        if (alan === 'BACA NO') {
            // Baca No için hem süzme hem dropdown
            headerHTML += `<th>
                <input type="text" class="form-control form-control-sm mb-1" id="parametre${alan.replace(/[^a-zA-Z0-9]/g, '')}Filter" placeholder="${alan} filtrele..." onkeyup="filterParametreTable()">
                <select class="form-control form-control-sm" id="parametre${alan.replace(/[^a-zA-Z0-9]/g, '')}Dropdown" onchange="filterParametreTable()">
                    <option value="">Tüm Baca Numaraları</option>
                </select>
            </th>`;
        } else {
            // Diğer parametreler için süzme kutusu yok
            headerHTML += '<th></th>';
        }
    });
    
    // Kayıt Tarihi sütunu - boş
    headerHTML += '<th></th>';
    
    headerHTML += '</tr>';
    
    tableHead.innerHTML = headerHTML;
}

// Parametre dropdown'larını doldur
function populateParametreDropdowns() {
    fetch('/api/parametre_olcumleri')
        .then(response => response.json())
        .then(data => {
            const firmalar = [...new Set(data.map(item => item.firma).filter(Boolean))].sort();
            const olcumKodlari = [...new Set(data.map(item => item.olcum_kodu).filter(Boolean))].sort();
            const bacalar = [...new Set(data.map(item => item.baca).filter(Boolean))].sort();
            
            // Firma dropdown'ını doldur
            const firmaDropdown = document.getElementById('parametreFirmaDropdown');
            if (firmaDropdown) {
                firmaDropdown.innerHTML = '<option value="">Tüm Firmalar</option>';
                firmalar.forEach(firma => {
                    firmaDropdown.innerHTML += `<option value="${firma.toLowerCase()}">${firma}</option>`;
                });
            }
            
            // Ölçüm Kodu dropdown'ını doldur
            const olcumKoduDropdown = document.getElementById('parametreOlcumKoduDropdown');
            if (olcumKoduDropdown) {
                olcumKoduDropdown.innerHTML = '<option value="">Tüm Ölçüm Kodları</option>';
                olcumKodlari.forEach(olcumKodu => {
                    olcumKoduDropdown.innerHTML += `<option value="${olcumKodu.toLowerCase()}">${olcumKodu}</option>`;
                });
            }
            
            // Baca dropdown'ını doldur
            const bacaDropdown = document.getElementById('parametreBacaDropdown');
            if (bacaDropdown) {
                bacaDropdown.innerHTML = '<option value="">Tüm Bacalar</option>';
                bacalar.forEach(baca => {
                    bacaDropdown.innerHTML += `<option value="${baca.toLowerCase()}">${baca}</option>`;
                });
            }
        })
        .catch(error => {
            console.error('Parametre dropdown\'ları doldurulurken hata:', error);
        });
}

// Parametre ölçümlerini yükle
function loadParametreOlcumleri() {
    // Önce başlıkları oluştur
    createParametreOlcumTableHeaders();
    
    // Dropdown'ları doldur
    populateParametreDropdowns();
    
    fetch('/api/parametre_olcumleri')
        .then(response => response.json())
        .then(data => {
            const tableBody = document.getElementById('parametreOlcumTableBody');
            const emptyMessage = document.getElementById('emptyParametreMessage');
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            
            // Sayfalama hesaplamaları
            const totalRecords = data.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startIndex = (currentParametrePage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageData = data.slice(startIndex, endIndex);
            
            // Tüm parametre alanlarını tanımla (başlıklarla aynı sırada)
            const allParametreFields = [
                'TARİH', 'METOT', 'NOZZLE ÇAP', 'TRAVERS', 'B.HIZ', 'B.SIC', 'B.BAS(KPA)', 
                'B.NEM(G/M3)', 'B.NEM(%)', 'SYC.HAC.', 'SYC.İLK', 'SYC.SON', 'SYC.SIC', 'DEBİ', 'ISDL',
                '1İMP-İ', '1-İMP-S', '2-İMP-İ', '2-İMP-S', '3-İMP-İ', '3-İMP-S', 'HAC.',
                'O2', 'CO', 'NO', 'NOX', 'SO2', 'KK1-O2', 'KK1-CO', 'KK1-NO', 'KK1-SO2', 
                'KK2-O2', 'KK2-CO', 'KK2-NO', 'KK2-SO2', 'T90',
                'TOC(PPM)', 'KK1-O', 'KK1-SPAN', 'KK2-O', 'KK2-SPAN',
                'GAZ HAC.', 'GAZ.SIC.', 'SEY.GAZ.HAC', 'SEY.GAZ.SIC',
                'ORT.SIC', 'ORT.NEM', 'ORT.RUZ.HIZ', 'ÇEK.HACİM',
                'T.İÇİ-1', 'T.İÇİ-2', 'T.İÇİ-3', 'T.İÇİ-4', 'T-DIŞ-1', 'T.DIŞ-2', 
                'T.DIŞ-3', 'T.DIŞ-4', 'İLK KURULUM', '2. KURULUM'
            ];
            
            pageData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `parametre_row_${record.id}`;
                
                // Baca filtreleme için data attribute'ları ekle
                row.setAttribute('data-firma', record.firma_adi || '');
                row.setAttribute('data-olcum', record.olcum_kodu || '');
                row.setAttribute('data-baca', record.baca_adi || '');
                
                const parametreVerileri = record.parametre_verileri || {};
                
                // Checkbox durumunu kontrol et
                const isChecked = allParametreSelected || selectedParametreIds.has(record.id);
                
                // Sabit sütunlar
                let rowHTML = `
                    <td>
                        <input type="checkbox" class="parametre-checkbox" value="${record.id}" ${isChecked ? 'checked' : ''}>
                    </td>
                    <td>${startIndex + index + 1}</td>
                    <td>${record.firma_adi}</td>
                    <td>${record.olcum_kodu}</td>
                    <td>${record.baca_adi}</td>
                    <td>${record.parametre_adi}</td>
                    <td class="text-nowrap">
                        <div class="btn-group btn-group-sm" role="group" style="font-size: 0.75rem;">
                            <button class="btn btn-outline-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewParametreOlcum('${record.id}')" title="Görüntüle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editParametreOlcum('${record.id}')" title="Düzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteParametreOlcum('${record.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Parametre alanları - her alan için sütun oluştur
                allParametreFields.forEach(alan => {
                    const deger = parametreVerileri[alan] || '*';
                    rowHTML += `<td>${deger}</td>`;
                });
                
                // Son sütunlar
                rowHTML += `
                    <td>${new Date(record.created_at).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'})}</td>
                `;
                
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
            
            // Sayfalama bilgilerini güncelle
            document.getElementById('totalParametreRecords').textContent = totalRecords;
            document.getElementById('currentParametrePage').textContent = currentParametrePage;
            
            // Sayfalama butonlarını oluştur
            createPagination(totalRecords, currentParametrePage, 'parametrePagination', 'changeParametrePage');
            
            // "Hepsini Seç" checkbox durumunu güncelle
            const selectAllCheckbox = document.getElementById('selectAllParametre');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allParametreSelected;
            }
            
            console.log(`${pageData.length} adet parametre ölçümü yüklendi (Sayfa ${currentParametrePage}/${totalPages}).`);
        })
        .catch(error => {
            console.error('Parametre ölçümleri yüklenirken hata:', error);
        });
}

// Parametre ölçümlerini tümünü seç/kaldır
function toggleSelectAllParametre() {
    const selectAllCheckbox = document.getElementById('selectAllParametre');
    const checkboxes = document.querySelectorAll('.parametre-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// Baca bilgileri kontrolü ve form açma
function checkBacaBilgileri() {
    console.log('checkBacaBilgileri çağrıldı');
    
    const firma = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const baca = document.getElementById('bacaSelect').value;
    
    console.log('Seçilen değerler:', { firma, olcumKodu, baca });
    
    // Tüm alanlar dolu mu kontrol et
    if (firma && olcumKodu && baca) {
        console.log('Tüm alanlar dolu, baca bilgileri kontrol ediliyor...');
        
        // Mevcut baca bilgilerini kontrol et
        fetch('/api/baca_bilgileri')
            .then(response => response.json())
            .then(data => {
                console.log('Baca bilgileri API yanıtı:', data);
                
                const existingRecord = data.find(item => 
                    item.firma_adi === firma && 
                    item.olcum_kodu === olcumKodu && 
                    item.baca_adi === baca
                );
                
                console.log('Mevcut kayıt bulundu mu:', existingRecord);
                
                if (existingRecord) {
                    // Zaten baca bilgileri var - uyarı ver
                    if (confirm(`Bu firma, ölçüm kodu ve baca için zaten baca bilgileri mevcut. Güncellemek istiyor musunuz?`)) {
                        console.log('Mevcut veri güncellenecek');
                        // Mevcut veriyi forma yükle
                        loadExistingBacaBilgileri(existingRecord);
                    } else {
                        console.log('Form temizlenecek');
                        // Formu temizle
                        clearBacaBilgileriForm();
                    }
                } else {
                    // Yeni baca bilgileri - formu aç
                    console.log('Yeni baca bilgileri, form açılıyor...');
                    loadBacaBilgileriForm();
                }
            })
            .catch(error => {
                console.error('Baca bilgileri kontrol edilirken hata:', error);
                // Hata durumunda formu aç
                loadBacaBilgileriForm();
            });
    } else {
        console.log('Eksik alanlar var, form gizleniyor');
        // Eksik alanlar varsa formu gizle
        document.getElementById('bacaBilgileriForm').style.display = 'none';
    }
}

// Mevcut baca bilgilerini forma yükle
function loadExistingBacaBilgileri(record) {
    // Baca parametrelerini al
    const bacaParametreleri = window.bacaParametreleri || [];
    
    // Her parametre için form alanını doldur
    bacaParametreleri.forEach(parametre => {
        const inputId = `baca_bilgi_${parametre.id}`;
        const input = document.getElementById(inputId);
        if (input && record.baca_bilgileri && record.baca_bilgileri[parametre.id]) {
            input.value = record.baca_bilgileri[parametre.id];
        }
    });
    
    // Formu göster
    document.getElementById('bacaBilgileriForm').style.display = 'block';
    document.getElementById('bacaBilgileriForm').scrollIntoView({ behavior: 'smooth' });
    
    // Düzenleme modunda olduğunu belirt
    window.editingRowId = record.id;
    
    // Buton metnini değiştir
    const saveBtn = document.getElementById('saveBacaBilgileriBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Baca Bilgilerini Güncelle';
        saveBtn.className = 'btn btn-warning btn-sm';
    }
}

// Baca Bilgileri Tablosu İşlemleri
function importBacaData() {
    // Dosya seçme input'u oluştur
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xlsx';
    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            // FormData oluştur
            const formData = new FormData();
            formData.append('file', file);
            
            // Excel dosyasını yükle
            fetch('/api/baca_bilgileri/import_excel', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadBacaBilgileri(); // Tabloyu yenile
                } else {
                    alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
                }
            })
            .catch(error => {
                console.error('İçe aktarma hatası:', error);
                alert('İçe aktarma sırasında hata oluştu!');
            });
        }
    };
    fileInput.click();
}

function exportBacaData() {
    // Seçili kayıtları al
    const selectedCheckboxes = document.querySelectorAll('#bacaBilgileriTableBody input[type="checkbox"]:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Dışa aktarmak için en az bir kayıt seçin!');
        return;
    }
    
    // Excel dosyasını indir
    fetch('/api/baca_bilgileri/export_excel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            selected_ids: selectedIds
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Dışa aktarma hatası');
        }
    })
    .then(blob => {
        // Dosyayı indir
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `baca_bilgileri_${new Date().toISOString().split('T')[0]}.xlsx`;
        link.click();
        URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Dışa aktarma hatası:', error);
        alert('Dışa aktarma sırasında hata oluştu!');
    });
}

function deleteSelectedBaca() {
    const selectedCheckboxes = document.querySelectorAll('#bacaBilgileriTableBody input[type="checkbox"]:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Silmek için en az bir kayıt seçin!');
        return;
    }
    
    if (confirm(`Seçili ${selectedIds.length} kaydı silmek istediğinizden emin misiniz?`)) {
        // Toplu silme API'sini kullan
        fetch('/api/baca_bilgileri/bulk_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ids: selectedIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadBacaBilgileri(); // Tabloyu yenile
            } else {
                alert('Silme sırasında hata oluştu: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Silme hatası:', error);
            alert('Silme sırasında hata oluştu!');
        });
    }
}

function printBacaData(format) {
    // Seçili kayıtları al (eğer hiç seçili yoksa tümünü al)
    const selectedCheckboxes = document.querySelectorAll('#bacaBilgileriTableBody input[type="checkbox"]:checked');
    let selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        // Hiç seçili yoksa tümünü al
        const allCheckboxes = document.querySelectorAll('#bacaBilgileriTableBody input[type="checkbox"]');
        selectedIds = Array.from(allCheckboxes).map(cb => cb.value);
    }
    
    if (selectedIds.length === 0) {
        alert('Yazdırmak için kayıt bulunamadı!');
        return;
    }
    
    // Yazdırma formatına göre işlem yap
    switch(format) {
        case 'pdf':
            printBacaToPDF(selectedIds);
            break;
        case 'word':
            printBacaToWord(true); // Varsayılan olarak şablon kullan
            break;
        case 'excel':
            printBacaToExcel(selectedIds);
            break;
        default:
            alert('Geçersiz format!');
    }
}

function printBacaToPDF(selectedIds) {
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Word dosyası hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // PDF export API'sini çağır
    fetch('/api/baca_bilgileri/export_pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            selected_ids: selectedIds
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Word export hatası');
        }
    })
    .then(blob => {
        // Word dosyasını indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        // Seçili kayıtlardan firma, baca ve ölçüm kodu bilgilerini al
        let fileName = 'baca_bilgileri';
        if (selectedIds.length > 0) {
            const firstRow = document.querySelector(`input[value="${selectedIds[0]}"]`).closest('.baca-row');
            if (firstRow) {
                const firma = firstRow.getAttribute('data-firma') || '';
                const baca = firstRow.getAttribute('data-baca') || '';
                const olcum = firstRow.getAttribute('data-olcum') || '';
                fileName = `${firma}-${baca}-${olcum}`;
            }
        }
        
        a.download = `${fileName}_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('PDF dosyası başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('PDF export hatası:', error);
        alert('Word dosyası oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

function printBacaToWord() {
    // Seçili baca bilgilerini al
    const selectedBaca = document.querySelector('.baca-row.table-active');
    if (!selectedBaca) {
        // Alternatif olarak seçili checkbox'ları kontrol et
        const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('Lütfen önce bir baca seçin!');
            return;
        }
        // İlk seçili satırı al
        const firstCheckedRow = checkedBoxes[0].closest('.baca-row');
        if (!firstCheckedRow) {
            alert('Lütfen önce bir baca seçin!');
            return;
        }
        selectedBaca = firstCheckedRow;
    }
    
    const firma = selectedBaca.getAttribute('data-firma');
    const olcumKodu = selectedBaca.getAttribute('data-olcum');
    const baca = selectedBaca.getAttribute('data-baca');
    
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Word dosyası hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // Word export API'sini çağır
    fetch('/api/baca_word_export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            firma: firma,
            olcum_kodu: olcumKodu,
            baca_adi: baca
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Word export hatası');
        }
    })
    .then(blob => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        a.download = `${firma}-${baca}-${olcumKodu}.docx`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('Word dosyası başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('Word export hatası:', error);
        alert('Word dosyası oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

function exportFirmaRaporu(useTemplate = true) {
    // Seçili firma ve ölçüm kodunu al
    const selectedFirma = document.getElementById('firmaSelect').value;
    const selectedOlcum = document.getElementById('olcumKoduSelect').value;
    
    if (!selectedFirma || !selectedOlcum) {
        alert('Lütfen önce firma ve ölçüm kodu seçin!');
        return;
    }
    
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Firma raporu hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // Firma raporu API'sini çağır
    fetch('/api/firma_rapor_export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            firma_adi: selectedFirma,
            olcum_kodu: selectedOlcum,
            use_template: useTemplate
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Firma raporu export hatası');
        }
    })
    .then(blob => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        a.download = `Firma_Raporu_${selectedFirma}_${selectedOlcum}_${timestamp}.docx`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('Firma raporu başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('Firma raporu export hatası:', error);
        alert('Firma raporu oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

function exportFirmaRaporuPDF() {
    // Seçili firma ve ölçüm kodunu al
    const selectedFirma = document.getElementById('firmaSelect').value;
    const selectedOlcum = document.getElementById('olcumKoduSelect').value;
    
    if (!selectedFirma || !selectedOlcum) {
        alert('Lütfen önce firma ve ölçüm kodu seçin!');
        return;
    }
    
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        PDF Firma raporu hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // PDF Firma raporu API'sini çağır
    fetch('/api/firma_rapor_pdf_export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            firma_adi: selectedFirma,
            olcum_kodu: selectedOlcum
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('PDF Firma raporu export hatası');
        }
    })
    .then(blob => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        a.download = `Firma_Raporu_${selectedFirma}_${selectedOlcum}_${timestamp}.pdf`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('PDF Firma raporu başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('PDF Firma raporu export hatası:', error);
        alert('PDF Firma raporu oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

function printBacaToExcel(selectedIds) {
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        Excel dosyası hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // Excel export API'sini çağır
    fetch('/api/baca_bilgileri/export_excel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            selected_ids: selectedIds
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Excel export hatası');
        }
    })
    .then(blob => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        a.download = `baca_bilgileri_${timestamp}.xlsx`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('Excel dosyası başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('Excel export hatası:', error);
        alert('Excel dosyası oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

// Üst dropdown'ları doldur
function populateTopDropdowns() {
    // Firmaları doldur
    fetch('/api/firmalar')
        .then(response => response.json())
        .then(data => {
            const firmalar = [...new Set(data.map(item => item.firma_adi).filter(Boolean))].sort();
            const firmaList = document.getElementById('firmaList');
            const firmaDropdown = document.getElementById('firmaDropdown');
            
            if (firmaList) {
                firmaList.innerHTML = '<option value="">Tüm Firmalar</option>';
                firmalar.forEach(firma => {
                    firmaList.innerHTML += `<option value="${firma}">${firma}</option>`;
                });
            }
            
            // Firma dropdown menüsünü doldur
            if (firmaDropdown) {
                firmaDropdown.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectFromDropdown(\'firmaSelect\', \'\')">Tüm Firmalar</a></li>';
                firmalar.forEach(firma => {
                    firmaDropdown.innerHTML += `<li><a class="dropdown-item" href="#" onclick="selectFromDropdown('firmaSelect', '${firma}')">${firma}</a></li>`;
                });
            }
        })
        .catch(error => console.error('Firma listesi yüklenirken hata:', error));

    // Ölçüm kodlarını doldur
    fetch('/api/baca_bilgileri')
        .then(response => response.json())
        .then(data => {
            const olcumKodlari = [...new Set(data.map(item => item.olcum_kodu).filter(Boolean))].sort();
            const olcumKoduList = document.getElementById('olcumKoduList');
            if (olcumKoduList) {
                olcumKoduList.innerHTML = '<option value="">Tüm Ölçüm Kodları</option>';
                olcumKodlari.forEach(olcumKodu => {
                    olcumKoduList.innerHTML += `<option value="${olcumKodu}">${olcumKodu}</option>`;
                });
            }
        })
        .catch(error => console.error('Ölçüm kodu listesi yüklenirken hata:', error));

    // Bacaları doldur
    fetch('/api/baca_bilgileri')
        .then(response => response.json())
        .then(data => {
            const bacalar = [...new Set(data.map(item => item.baca_adi).filter(Boolean))].sort();
            const bacaList = document.getElementById('bacaList');
            if (bacaList) {
                bacaList.innerHTML = '<option value="">Tüm Bacalar</option>';
                bacalar.forEach(baca => {
                    bacaList.innerHTML += `<option value="${baca}">${baca}</option>`;
                });
            }
        })
        .catch(error => console.error('Baca listesi yüklenirken hata:', error));

    // Parametreleri doldur
    fetch('/api/baca_parametreleri')
        .then(response => response.json())
        .then(data => {
            const parametreler = [...new Set(data.map(item => item.parametre_adi).filter(Boolean))].sort();
            const parametreList = document.getElementById('parametreList');
            if (parametreList) {
                parametreList.innerHTML = '<option value="">Tüm Parametreler</option>';
                parametreler.forEach(parametre => {
                    parametreList.innerHTML += `<option value="${parametre}">${parametre}</option>`;
                });
            }
        })
        .catch(error => console.error('Parametre listesi yüklenirken hata:', error));

    // Personel listesini doldur
    fetch('/api/personel_listesi')
        .then(response => response.json())
        .then(data => {
            const personel = [...new Set(data.map(item => item.personel_adi).filter(Boolean))].sort();
            const personelList = document.getElementById('personelList');
            const personelDropdown = document.getElementById('personelDropdown');
            
            if (personelList) {
                personelList.innerHTML = '<option value="">Tüm Personel</option>';
                personel.forEach(p => {
                    personelList.innerHTML += `<option value="${p}">${p}</option>`;
                });
            }
            
            // Personel dropdown menüsünü doldur
            if (personelDropdown) {
                personelDropdown.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectFromDropdown(\'personelSelect\', \'\')">Tüm Personel</a></li>';
                personel.forEach(p => {
                    personelDropdown.innerHTML += `<li><a class="dropdown-item" href="#" onclick="selectFromDropdown('personelSelect', '${p}')">${p}</a></li>`;
                });
            }
        })
        .catch(error => console.error('Personel listesi yüklenirken hata:', error));
}

// Sayfa yüklendiğinde parametre ölçümlerini de yükle
document.addEventListener('DOMContentLoaded', function() {
    loadSavedBacaBilgileri();
    loadParametreOlcumleri();
    populateTopDropdowns(); // Üst dropdown'ları doldur
    
    // Firma seçimi event listener'ları
    setupFirmaSelectionListeners();
});

// Firma seçimi event listener'larını kur
function setupFirmaSelectionListeners() {
    const firmaSelect = document.getElementById('firmaSelect');
    const olcumKoduSelect = document.getElementById('olcumKoduSelect');
    const bacaSelect = document.getElementById('bacaSelect');
    const parametreSelect = document.getElementById('parametreSelect');
    
    // Firma seçimi değiştiğinde
    if (firmaSelect) {
        firmaSelect.addEventListener('input', function() {
            const selectedFirma = this.value;
            if (selectedFirma) {
                // Ölçüm kodlarını güncelle
                updateOlcumKodlari(selectedFirma);
                // Bacaları temizle
                if (bacaSelect) bacaSelect.value = '';
                if (parametreSelect) parametreSelect.value = '';
            }
        });
    }
    
    // Ölçüm kodu seçimi değiştiğinde
    if (olcumKoduSelect) {
        olcumKoduSelect.addEventListener('input', function() {
            const selectedFirma = firmaSelect ? firmaSelect.value : '';
            const selectedOlcumKodu = this.value;
            if (selectedFirma && selectedOlcumKodu) {
                // Bacaları güncelle
                updateBacalar(selectedFirma, selectedOlcumKodu);
                // Parametreleri temizle
                if (parametreSelect) parametreSelect.value = '';
            }
        });
    }
    
    // Baca seçimi değiştiğinde
    if (bacaSelect) {
        bacaSelect.addEventListener('input', function() {
            const selectedFirma = firmaSelect ? firmaSelect.value : '';
            const selectedOlcumKodu = olcumKoduSelect ? olcumKoduSelect.value : '';
            const selectedBaca = this.value;
            if (selectedFirma && selectedOlcumKodu && selectedBaca) {
                // Parametreleri güncelle
                updateParametreler(selectedFirma, selectedOlcumKodu, selectedBaca);
            }
        });
    }
    
    // Parametre seçimi değiştiğinde
    if (parametreSelect) {
        parametreSelect.addEventListener('input', function() {
            const selectedParametre = this.value;
            if (selectedParametre) {
                // Parametre ölçüm formunu göster
                loadParametreOlcumForm(selectedParametre);
            } else {
                // Parametre seçimi temizlendiyse formu gizle
                document.getElementById('parametreOlcumForm').style.display = 'none';
            }
        });
    }
}

// Dropdown'dan seçim yapma fonksiyonu
function selectFromDropdown(inputId, value) {
    const input = document.getElementById(inputId);
    if (input) {
        input.value = value;
        // Change event'ini tetikle
        const changeEvent = new Event('change', { bubbles: true });
        input.dispatchEvent(changeEvent);
        
        // Input event'ini de tetikle (geriye uyumluluk için)
        const inputEvent = new Event('input', { bubbles: true });
        input.dispatchEvent(inputEvent);
        
        console.log(`${inputId} seçildi:`, value);
    }
}

// Firma seçimine göre ölçüm kodlarını güncelle
function updateOlcumKodlari(firma) {
    console.log('Firma seçildi:', firma);
    fetch(`/api/olcum_kodlari/${encodeURIComponent(firma)}`)
        .then(response => response.json())
        .then(data => {
            console.log('API response:', data);
            const olcumKoduSelect = document.getElementById('olcumKoduSelect');
            const olcumKoduList = document.getElementById('olcumKoduList');
            const olcumKoduDropdown = document.getElementById('olcumKoduDropdown');
            
            if (olcumKoduSelect && olcumKoduList) {
                olcumKoduSelect.value = '';
                olcumKoduList.innerHTML = '<option value="">Ölçüm kodu seçin</option>';
                
                // Dropdown menüsünü güncelle
                if (olcumKoduDropdown) {
                    olcumKoduDropdown.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectFromDropdown(\'olcumKoduSelect\', \'\')">Tüm Ölçüm Kodları</a></li>';
                }
                
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        // API obje döndürüyor, olcum_kodu alanını al
                        const olcumKodu = item.olcum_kodu || item;
                        olcumKoduList.innerHTML += `<option value="${olcumKodu}">${olcumKodu}</option>`;
                        
                        // Dropdown menüsüne ekle
                        if (olcumKoduDropdown) {
                            olcumKoduDropdown.innerHTML += `<li><a class="dropdown-item" href="#" onclick="selectFromDropdown('olcumKoduSelect', '${olcumKodu}')">${olcumKodu}</a></li>`;
                        }
                    });
                }
            }
        })
        .catch(error => console.error('Ölçüm kodları yüklenirken hata:', error));
}

// Firma ve ölçüm kodu seçimine göre bacaları güncelle
function updateBacalar(firma, olcumKodu) {
    fetch(`/api/baca_listesi/${encodeURIComponent(firma)}/${encodeURIComponent(olcumKodu)}`)
        .then(response => response.json())
        .then(data => {
            const bacaSelect = document.getElementById('bacaSelect');
            const bacaList = document.getElementById('bacaList');
            const bacaDropdown = document.getElementById('bacaDropdown');
            
            if (bacaSelect && bacaList) {
                bacaSelect.value = '';
                bacaList.innerHTML = '<option value="">Baca seçin</option>';
                
                // Dropdown menüsünü güncelle
                if (bacaDropdown) {
                    bacaDropdown.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectFromDropdown(\'bacaSelect\', \'\')">Tüm Bacalar</a></li>';
                }
                
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        // API obje döndürüyor, baca_adi alanını al
                        const baca = item.baca_adi || item;
                        bacaList.innerHTML += `<option value="${baca}">${baca}</option>`;
                        
                        // Dropdown menüsüne ekle
                        if (bacaDropdown) {
                            bacaDropdown.innerHTML += `<li><a class="dropdown-item" href="#" onclick="selectFromDropdown('bacaSelect', '${baca}')">${baca}</a></li>`;
                        }
                    });
                }
            }
        })
        .catch(error => console.error('Baca listesi yüklenirken hata:', error));
}

// Firma, ölçüm kodu ve baca seçimine göre parametreleri güncelle
function updateParametreler(firma, olcumKodu, baca) {
    fetch(`/api/parametre_listesi/${encodeURIComponent(firma)}/${encodeURIComponent(olcumKodu)}/${encodeURIComponent(baca)}`)
        .then(response => response.json())
        .then(data => {
            const parametreSelect = document.getElementById('parametreSelect');
            const parametreList = document.getElementById('parametreList');
            const parametreDropdown = document.getElementById('parametreDropdown');
            
            if (parametreSelect && parametreList) {
                parametreSelect.value = '';
                parametreList.innerHTML = '<option value="">Parametre seçin</option>';
                
                // Dropdown menüsünü güncelle
                if (parametreDropdown) {
                    parametreDropdown.innerHTML = '<li><a class="dropdown-item" href="#" onclick="selectFromDropdown(\'parametreSelect\', \'\')">Tüm Parametreler</a></li>';
                }
                
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        // API obje döndürüyor, parametre_adi alanını al
                        const parametre = item.parametre_adi || item;
                        parametreList.innerHTML += `<option value="${parametre}">${parametre}</option>`;
                        
                        // Dropdown menüsüne ekle
                        if (parametreDropdown) {
                            parametreDropdown.innerHTML += `<li><a class="dropdown-item" href="#" onclick="selectFromDropdown('parametreSelect', '${parametre}')">${parametre}</a></li>`;
                        }
                    });
                }
            }
        })
        .catch(error => console.error('Parametre listesi yüklenirken hata:', error));
}

// Baca bilgileri tablosunu yeniden yükle
function loadBacaBilgileri() {
    fetch('/api/baca_bilgileri')
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data)) {
                const bacaBilgileriTableBody = document.getElementById('bacaBilgileriTableBody');
                bacaBilgileriTableBody.innerHTML = ''; // Mevcut verileri temizle
                
                // Sayfalama hesaplamaları
                const totalRecords = data.length;
                const totalPages = Math.ceil(totalRecords / recordsPerPage);
                const startIndex = (currentBacaPage - 1) * recordsPerPage;
                const endIndex = startIndex + recordsPerPage;
                const pageData = data.slice(startIndex, endIndex);
                
                // Sayfa verilerini tabloya ekle
                pageData.forEach(record => {
                    addSavedBacaBilgileriToTable(record);
                });
                
                // Dropdown'ları doldur
                populateBacaDropdowns(data);
                
                // Sayfalama bilgilerini güncelle
                document.getElementById('totalBacaRecords').textContent = totalRecords;
                document.getElementById('currentBacaPage').textContent = currentBacaPage;
                
                // Sayfalama butonlarını oluştur
                createPagination(totalRecords, currentBacaPage, 'bacaPagination', 'changeBacaPage');
                
                console.log(`${pageData.length} adet baca bilgisi yüklendi (Sayfa ${currentBacaPage}/${totalPages}).`);
            }
        })
        .catch(error => {
            console.error('Baca bilgileri yüklenirken hata:', error);
        });
}

// Baca bilgileri dropdown'larını doldur
function populateBacaDropdowns(data) {
    const firmalar = [...new Set(data.map(item => item.firma_adi).filter(Boolean))].sort();
    const olcumKodlari = [...new Set(data.map(item => item.olcum_kodu).filter(Boolean))].sort();
    const bacalar = [...new Set(data.map(item => item.baca_adi).filter(Boolean))].sort();
    
    const firmaList = document.getElementById('bacaFirmaList');
    if (firmaList) {
        firmaList.innerHTML = '<option value="">Tüm Firmalar</option>';
        firmalar.forEach(firma => {
            firmaList.innerHTML += `<option value="${firma}">${firma}</option>`;
        });
    }
    
    const olcumKoduList = document.getElementById('bacaOlcumKoduList');
    if (olcumKoduList) {
        olcumKoduList.innerHTML = '<option value="">Tüm Ölçüm Kodları</option>';
        olcumKodlari.forEach(olcumKodu => {
            olcumKoduList.innerHTML += `<option value="${olcumKodu}">${olcumKodu}</option>`;
        });
    }
    
    const bacaList = document.getElementById('bacaBacaList');
    if (bacaList) {
        bacaList.innerHTML = '<option value="">Tüm Bacalar</option>';
        bacalar.forEach(baca => {
            bacaList.innerHTML += `<option value="${baca}">${baca}</option>`;
        });
    }
}

// Parametre ölçümü görüntüleme fonksiyonu
function viewParametreOlcum(recordId) {
    console.log('Parametre ölçümü görüntüleniyor:', recordId);
    
    // Parametre ölçümlerini yükle
    fetch('/api/parametre_olcumleri')
        .then(response => response.json())
        .then(data => {
            const record = data.find(item => item.id === recordId);
            if (record) {
                showParametreOlcumModal(record);
            } else {
                alert('Parametre ölçümü bulunamadı!');
            }
        })
        .catch(error => {
            console.error('Parametre ölçümü yüklenirken hata:', error);
            alert('Parametre ölçümü yüklenirken hata oluştu!');
        });
}

// Parametre ölçümü modalını göster
function showParametreOlcumModal(record) {
    const parametreVerileri = record.parametre_verileri || {};
    
    let contentHTML = `
        <div class="modal-header">
            <h5 class="modal-title">Parametre Ölçüm Detayları</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Firma:</strong> ${record.firma_adi || '*'}
                </div>
                <div class="col-md-6">
                    <strong>Ölçüm Kodu:</strong> ${record.olcum_kodu || '*'}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Baca:</strong> ${record.baca_adi || '*'}
                </div>
                <div class="col-md-6">
                    <strong>Parametre:</strong> ${record.parametre_adi || '*'}
                </div>
            </div>
            <hr>
            <h6>Ölçüm Verileri:</h6>
            <div class="row">
    `;
    
    // Parametre verilerini göster
    Object.entries(parametreVerileri).forEach(([key, value]) => {
        const displayValue = (value && value.trim() !== '') ? value : '*';
        contentHTML += `
            <div class="col-md-6 mb-2">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">${key}:</span>
                    <span>${displayValue}</span>
                </div>
            </div>
        `;
    });
    
    contentHTML += `
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <strong>Kayıt Tarihi:</strong> ${record.created_at ? new Date(record.created_at).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'}) : '*'}
                </div>
                <div class="col-md-6">
                    <strong>Güncelleme Tarihi:</strong> ${record.updated_at ? new Date(record.updated_at).toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: '2-digit'}) : '*'}
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        </div>
    `;
    
    // Modal oluştur ve göster
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'parametreOlcumModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                ${contentHTML}
            </div>
        </div>
    `;
    
    // Eski modalı kaldır
    const oldModal = document.getElementById('parametreOlcumModal');
    if (oldModal) {
        oldModal.remove();
    }
    
    // Yeni modalı ekle ve göster
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Modal kapandığında DOM'dan kaldır
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

// Parametre ölçümü düzenleme fonksiyonu
function editParametreOlcum(recordId) {
    console.log('Parametre ölçümü düzenleniyor:', recordId);
    
    // Parametre ölçümlerini yükle
    fetch('/api/parametre_olcumleri')
        .then(response => response.json())
        .then(data => {
            console.log('API\'den gelen veriler:', data);
            const record = data.find(item => item.id === recordId);
            console.log('Bulunan kayıt:', record);
            if (record) {
                loadParametreOlcumToForm(record);
            } else {
                alert('Parametre ölçümü bulunamadı!');
            }
        })
        .catch(error => {
            console.error('Parametre ölçümü yüklenirken hata:', error);
            alert('Parametre ölçümü yüklenirken hata oluştu!');
        });
}

// Parametre ölçümünü forma yükle
function loadParametreOlcumToForm(record) {
    console.log('Parametre ölçümü forma yükleniyor:', record);
    
    // Temel bilgileri doldur
    const firmaSelect = document.getElementById('firmaSelect');
    const olcumKoduSelect = document.getElementById('olcumKoduSelect');
    const bacaSelect = document.getElementById('bacaSelect');
    const parametreSelect = document.getElementById('parametreSelect');
    
    if (firmaSelect) firmaSelect.value = record.firma_adi || '';
    if (olcumKoduSelect) olcumKoduSelect.value = record.olcum_kodu || '';
    if (bacaSelect) bacaSelect.value = record.baca_adi || '';
    if (parametreSelect) parametreSelect.value = record.parametre_adi || '';
    
    // Parametre verilerini forma yükle
    const parametreVerileri = record.parametre_verileri || {};
    
    // Parametre tipini belirle
    const parametreAdiUpper = record.parametre_adi.toUpperCase();
    let parametreTipi = '';
    
    if (['TOZ', 'A.MET', 'AMET', 'SÜLF.A', 'HF', 'HCL', 'AMON.', 'FORM.', 'CR6', 'FOSF.A.', 'HCN'].includes(parametreAdiUpper)) {
        parametreTipi = 'genel';
    } else if (parametreAdiUpper === 'NEM') {
        parametreTipi = 'nem';
    } else if (parametreAdiUpper === 'YG') {
        parametreTipi = 'yg';
    } else if (parametreAdiUpper === 'TOC') {
        parametreTipi = 'toc';
    } else if (parametreAdiUpper === 'VOC') {
        parametreTipi = 'voc';
    } else if (parametreAdiUpper === 'PM10') {
        parametreTipi = 'pm10';
    } else if (parametreAdiUpper === 'ÇT') {
        parametreTipi = 'ct';
    }
    
    // Önce parametre formunu oluştur
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    if (parametreOlcumFields) {
        // Form oluşturma işlemini beklet ve sonra verileri doldur
        createParametreOlcumFormFromPARSAHA(record.parametre_adi).then(() => {
            // Form oluşturulduktan sonra verileri doldur
            setTimeout(() => {
                fillParametreFormData(parametreVerileri);
            }, 200); // Form oluşturulması için biraz daha bekleme
        });
    }
    
    // Formu görünür yap
    const parametreForm = document.getElementById('parametreOlcumForm');
    if (parametreForm) {
        parametreForm.style.display = 'block';
        parametreForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Parametre adını göster
        const selectedParametreName = document.getElementById('selectedParametreName');
        if (selectedParametreName) {
            selectedParametreName.textContent = record.parametre_adi || '';
        }
    }
    
    // Kaydet butonunu güncelle
    const saveBtn = document.getElementById('saveParametreBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Parametre Ölçümünü Güncelle';
        saveBtn.onclick = () => updateParametreOlcum(record.id);
    }
    
    console.log('Parametre ölçümü forma yüklendi');
}

// Parametre form verilerini doldur
function fillParametreFormData(parametreVerileri) {
    console.log('Parametre form verileri dolduruluyor:', parametreVerileri);
    
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    if (parametreOlcumFields) {
        // Tüm input alanlarını bul ve doldur
        const inputs = parametreOlcumFields.querySelectorAll('input, select');
        inputs.forEach((input, index) => {
            const fieldName = input.getAttribute('data-alan') || input.name;
            if (fieldName) {
                const value = parametreVerileri[fieldName];
                if (value && value.trim() !== '') {
                    input.value = value;
                    console.log(`Alan ${fieldName} dolduruldu: ${value}`);
                } else {
                    input.value = '*';
                    console.log(`Alan ${fieldName} boş, * koyuldu`);
                }
            }
        });
        
        console.log(`${inputs.length} adet alan dolduruldu`);
    } else {
        console.error('Parametre ölçüm alanları bulunamadı!');
    }
}

// Parametre ölçümünü güncelle
function updateParametreOlcum(recordId) {
    console.log('Parametre ölçümü güncelleniyor:', recordId);
    
    // Form verilerini topla
    const firmaAdi = document.getElementById('firmaSelect').value;
    const olcumKodu = document.getElementById('olcumKoduSelect').value;
    const bacaAdi = document.getElementById('bacaSelect').value;
    const parametreAdi = document.getElementById('parametreSelect').value;
    
    if (!firmaAdi || !olcumKodu || !bacaAdi || !parametreAdi) {
        alert('Lütfen tüm temel bilgileri doldurun!');
        return;
    }
    
    // Parametre verilerini topla
    const parametreVerileri = {};
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    
    if (parametreOlcumFields) {
        const inputs = parametreOlcumFields.querySelectorAll('input, select');
        inputs.forEach((input) => {
            const fieldName = input.getAttribute('data-alan') || input.name;
            if (fieldName) {
                const value = input.value.trim();
                if (value && value !== '*') {
                    parametreVerileri[fieldName] = value;
                } else {
                    parametreVerileri[fieldName] = '';
                }
            }
        });
    }
    
    // Güncelleme verilerini hazırla
    const updateData = {
        firma_adi: firmaAdi,
        olcum_kodu: olcumKodu,
        baca_adi: bacaAdi,
        parametre_adi: parametreAdi,
        parametre_verileri: parametreVerileri,
        record_id: recordId
    };
    
    // API'ye gönder
    fetch('/save_parametre_olcum_saha', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Parametre ölçümü başarıyla güncellendi!');
            // Tabloyu yenile
            loadParametreOlcumleri();
            // Formu temizle
            clearParametreForm();
        } else {
            alert('Güncelleme hatası: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Güncelleme hatası:', error);
        alert('Güncelleme sırasında hata oluştu!');
    });
}

// Parametre formunu temizle
function clearParametreForm() {
    const parametreOlcumFields = document.getElementById('parametreOlcumFields');
    
    if (parametreOlcumFields) {
        const inputs = parametreOlcumFields.querySelectorAll('input, select');
        inputs.forEach((input) => {
            input.value = '';
        });
    }
    
    // Temel alanları temizle
    const firmaSelect = document.getElementById('firmaSelect');
    const olcumKoduSelect = document.getElementById('olcumKoduSelect');
    const bacaSelect = document.getElementById('bacaSelect');
    const parametreSelect = document.getElementById('parametreSelect');
    
    if (firmaSelect) firmaSelect.value = '';
    if (olcumKoduSelect) olcumKoduSelect.value = '';
    if (bacaSelect) bacaSelect.value = '';
    if (parametreSelect) parametreSelect.value = '';
    
    // Kaydet butonunu sıfırla
    const saveBtn = document.getElementById('saveParametreBtn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Parametre Ölçümünü Kaydet';
        saveBtn.onclick = saveParametreOlcum;
    }
}

// Test fonksiyonu - form görünürlüğünü test etmek için
function testFormDisplay() {
    console.log('Test form display çağrıldı');
    const form = document.getElementById('bacaBilgileriForm');
    if (form) {
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        console.log('Form display:', form.style.display);
        alert('Form görünürlüğü değiştirildi: ' + form.style.display);
    } else {
        alert('Form bulunamadı!');
    }
}

// Parametre ölçümleri için checkbox işlemleri
function toggleSelectAllParametre() {
    const selectAllCheckbox = document.getElementById('selectAllParametre');
    
    if (selectAllCheckbox.checked) {
        // Tüm parametre ölçümlerini seç
        allParametreSelected = true;
        selectedParametreIds.clear();
        
        // Tüm parametre ölçümlerini al ve ID'lerini seç
        fetch('/api/parametre_olcumleri')
            .then(response => response.json())
            .then(data => {
                data.forEach(record => {
                    selectedParametreIds.add(record.id);
                });
                
                // Mevcut sayfadaki checkbox'ları işaretle
                const checkboxes = document.querySelectorAll('#parametreOlcumTableBody input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                updateParametreButtonStates();
            })
            .catch(error => {
                console.error('Tüm parametre ölçümleri alınırken hata:', error);
                selectAllCheckbox.checked = false;
            });
    } else {
        // Tüm seçimleri kaldır
        allParametreSelected = false;
        selectedParametreIds.clear();
        
        // Mevcut sayfadaki checkbox'ları temizle
        const checkboxes = document.querySelectorAll('#parametreOlcumTableBody input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateParametreButtonStates();
    }
}

function updateParametreButtonStates() {
    const secilenleriSilBtn = document.getElementById('secilenleriSilParametre');
    
    if (secilenleriSilBtn) {
        const totalSelected = allParametreSelected ? selectedParametreIds.size : selectedParametreIds.size;
        secilenleriSilBtn.disabled = totalSelected === 0;
        
        if (totalSelected > 0) {
            secilenleriSilBtn.innerHTML = `<i class="fas fa-trash me-2"></i>Seçilenleri Sil (${totalSelected})`;
        } else {
            secilenleriSilBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Seçilenleri Sil';
        }
    }
}

// Seçilen parametre ölçümlerini sil
function deleteSelectedParametreOlcumleri() {
    let selectedIds = [];
    
    if (allParametreSelected) {
        // Tüm parametre ölçümleri seçiliyse, tüm ID'leri kullan
        selectedIds = Array.from(selectedParametreIds);
    } else {
        // Sadece mevcut sayfadaki seçili olanları al
        const checkedBoxes = document.querySelectorAll('#parametreOlcumTableBody input[type="checkbox"]:checked');
        selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
    }
    
    if (selectedIds.length === 0) {
        alert('Silinecek kayıt seçilmedi!');
        return;
    }
    
    if (!confirm(`${selectedIds.length} adet parametre ölçümü kaydını silmek istediğinizden emin misiniz?`)) {
        return;
    }
    
    fetch('/api/parametre_olcumleri/bulk_delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${checkedBoxes.length} adet parametre ölçümü kaydı başarıyla silindi!`);
            loadParametreOlcumleri(); // Tabloyu yenile
        } else {
            alert('Silme hatası: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Silme hatası:', error);
        alert('Silme sırasında hata oluştu!');
    });
}

// Parametre ölçümlerini dışa aktar
function exportParametreOlcumleri(format = 'excel') {
    let selectedIds = [];
    
    if (allParametreSelected) {
        // Tüm parametre ölçümleri seçiliyse, tüm ID'leri kullan
        selectedIds = Array.from(selectedParametreIds);
    } else {
        // Sadece mevcut sayfadaki seçili olanları al
        const checkedBoxes = document.querySelectorAll('#parametreOlcumTableBody input[type="checkbox"]:checked');
        selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
    }
    
    if (selectedIds.length === 0) {
        alert('Dışa aktarılacak kayıt seçilmedi!');
        return;
    }
    
    console.log('Parametre ölçümleri export başlatıldı:', format);
    
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-info position-fixed';
    loadingDiv.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; min-width: 300px; text-align: center;';
    loadingDiv.innerHTML = `
        <i class="fas fa-spinner fa-spin me-2"></i>
        ${format.toUpperCase()} dosyası hazırlanıyor...
    `;
    document.body.appendChild(loadingDiv);
    
    // API endpoint'ini belirle
    let apiEndpoint = '/api/parametre_olcumleri_excel_export';
    if (format === 'word') {
        apiEndpoint = '/api/parametre_olcumleri_word_export';
    } else if (format === 'pdf') {
        apiEndpoint = '/api/parametre_olcumleri_pdf_export';
    }
    
    // Export API'sini çağır
    fetch(apiEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            olcum_ids: selectedIds
        })
    })
    .then(response => {
        if (response.ok) {
            // Backend'den gelen dosya adını al
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = '';
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1].replace(/['"]/g, '');
                }
            }
            
            // Eğer backend'den dosya adı gelmezse varsayılan adı kullan
            if (!filename) {
                const now = new Date();
                const timestamp = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + '_' +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0');
                
                let extension = '.xlsx';
                if (format === 'word') {
                    extension = '.docx';
                } else if (format === 'pdf') {
                    extension = '.pdf';
                }
                
                filename = `Parametre_Olcumleri_${selectedIds.length}_kayit_${timestamp}${extension}`;
            }
            
            return response.blob().then(blob => ({ blob, filename }));
        } else {
            throw new Error('Export hatası');
        }
    })
    .then(({ blob, filename }) => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Başarı mesajı
        alert('Dosya başarıyla oluşturuldu!');
    })
    .catch(error => {
        console.error('Export hatası:', error);
        alert('Dosya oluşturulurken hata oluştu!');
    })
    .finally(() => {
        // Loading'i kaldır
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
    });
}

// Sayfalama değişkenleri
let currentBacaPage = 1;
let currentParametrePage = 1;
const recordsPerPage = 5; // Her sayfada 5 kayıt

// Global seçim değişkenleri
let allParametreSelected = false; // Tüm parametre ölçümleri seçili mi?
let selectedParametreIds = new Set(); // Seçili parametre ID'leri

// Sayfalama fonksiyonları
function createPagination(totalRecords, currentPage, paginationId, pageChangeFunction) {
    const totalPages = Math.ceil(totalRecords / recordsPerPage);
    const pagination = document.getElementById(paginationId);
    
    if (!pagination) return;
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Önceki sayfa butonu
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="${pageChangeFunction}(${currentPage - 1})">Önceki</a>`;
    pagination.appendChild(prevLi);
    
    // Sayfa numaraları
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="${pageChangeFunction}(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Sonraki sayfa butonu
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="${pageChangeFunction}(${currentPage + 1})">Sonraki</a>`;
    pagination.appendChild(nextLi);
}

// Baca bilgileri sayfalama
function changeBacaPage(page) {
    if (page < 1) return;
    currentBacaPage = page;
    loadBacaBilgileri();
}

// Parametre ölçümleri sayfalama
function changeParametrePage(page) {
    if (page < 1) return;
    currentParametrePage = page;
    loadParametreOlcumleri();
}

// Event listener'ları ekle
document.addEventListener('DOMContentLoaded', function() {
    // Seçilenleri sil butonu için event listener
    const secilenleriSilBtn = document.getElementById('secilenleriSilParametre');
    if (secilenleriSilBtn) {
        secilenleriSilBtn.addEventListener('click', deleteSelectedParametreOlcumleri);
    }
    
    // Checkbox değişikliklerini dinle
    document.addEventListener('change', function(e) {
        if (e.target.matches('#parametreOlcumTableBody input[type="checkbox"]')) {
            updateParametreButtonStates();
        }
    });
});
</script>
{% endblock %} 