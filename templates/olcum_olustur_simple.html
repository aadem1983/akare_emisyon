{% extends "base.html" %}

{% block title %}ÖLÇÜM OLUŞTUR - Emisyon Saha Programı{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary" id="olcumOlusturBtn">
                <i class="fas fa-plus me-2"></i>Ölçüm Oluştur
            </button>
            <button type="button" class="btn btn-danger" id="secilenleriSilBtn" disabled>
                <i class="fas fa-trash me-2"></i>Seçilenleri Sil
            </button>
        </div>
        <h2 class="mb-0">ÖLÇÜM OLUŞTUR</h2>
    </div>
    
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="olcumTablo">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;" class="no-sort">
                                <input type="checkbox" id="selectAll" class="form-check-input">
                            </th>
                            <th style="width: 60px;" class="no-sort">Sıra</th>
                            <th style="width: 180px;">Firma Adı</th>
                            <th style="width: 150px;">İl-İlçe</th>
                            <th style="width: 150px;">Ölçüm Kodu</th>
                            <th>Baca<br>Say</th>
                            <th style="width: 200px;">Parametre</th>
                            <th>Ölç. Baş.</th>
                            <th>Ölç. Bitiş</th>
                            <th style="width: 225px;">Personel</th>
                            <th style="width: 100px;">Durum</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="firmaFilter" placeholder="Firma ara...">
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="ilIlceFilter" placeholder="İl-İlçe ara..." style="font-size: 0.8rem;">
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="kodFilter" placeholder="Kod ara...">
                            </th>
                            <th></th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="parametreFilter" placeholder="Parametre ara...">
                            </th>
                            <th>
                                <div class="d-flex flex-column gap-1">
                                    <input type="date" class="form-control form-control-sm" id="baslangicFrom" placeholder="Başlangıç...">
                                    <input type="date" class="form-control form-control-sm" id="baslangicTo" placeholder="Bitiş...">
                                </div>
                            </th>
                            <th>
                                <div class="d-flex flex-column gap-1">
                                    <input type="date" class="form-control form-control-sm" id="bitisFrom" placeholder="Başlangıç...">
                                    <input type="date" class="form-control form-control-sm" id="bitisTo" placeholder="Bitiş...">
                                </div>
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="personelFilter" placeholder="Personel ara...">
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm" id="durumFilter" placeholder="Durum ara...">
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if measurements %}
                            {% for measurement in measurements %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input row-checkbox" value="{{ measurement.id }}">
                                </td>
                                <td class="text-center fw-bold text-muted">{{ loop.index }}</td>
                                <td>{{ measurement.firma_adi }}</td>
                                <td style="font-size: 0.85rem;">{{ measurement.il_ilce }}</td>
                                <td>{{ measurement.olcum_kodu }}</td>
                                <td>{{ measurement.baca_sayisi }}</td>
                                <td>{{ measurement.parametre }}</td>
                                <td>{{ measurement.olcum_baslangic_fmt }}</td>
                                <td>{{ measurement.olcum_bitis_fmt }}</td>
                                <td>{{ measurement.olcumPersoneli }}</td>
                                <td>
                                    {% if measurement.durum == 'Aktif' %}
                                        <span class="badge bg-success">{{ measurement.durum }}</span>
                                    {% elif measurement.durum == 'Pasif' %}
                                        <span class="badge bg-secondary">{{ measurement.durum }}</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ measurement.durum or 'Belirsiz' }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted p-4">Henüz ölçüm kaydı bulunmuyor.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Ölçüm Oluştur Modal -->
<div class="modal fade" id="olcumOlusturModal" tabindex="-1" aria-labelledby="olcumOlusturModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="olcumOlusturModalLabel">Ölçüm Oluştur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="olcumOlusturForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="firmaAdi" class="form-label">Firma Adı *</label>
                            <input type="text" class="form-control" id="firmaAdi" name="firmaAdi" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="olcumKodu" class="form-label">Ölçüm Kodu</label>
                            <input type="text" class="form-control" id="olcumKodu" name="olcumKodu">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="olcumBaslangic" class="form-label">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="olcumBaslangic" name="olcumBaslangic">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="olcumBitis" class="form-label">Bitiş Tarihi</label>
                            <input type="date" class="form-control" id="olcumBitis" name="olcumBitis">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="il" class="form-label">İl</label>
                            <select class="form-select" id="il" name="il">
                                <option value="">İl Seçiniz</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="ilce" class="form-label">İlçe</label>
                            <select class="form-select" id="ilce" name="ilce">
                                <option value="">Önce İl Seçiniz</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="yetkili" class="form-label">Yetkili</label>
                            <input type="text" class="form-control" id="yetkili" name="yetkili" placeholder="Yetkili kişi adı">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="telefonNo" class="form-label">Telefon No</label>
                            <input type="tel" class="form-control" id="telefonNo" name="telefonNo" placeholder="0555 123 45 67">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9 mb-3">
                            <label class="form-label">Personel</label>
                            <div class="border rounded p-3" style="max-height: 120px; overflow-y: auto;">
                                <div class="row g-2">
                                    {% for user in users %}
                                    <div class="col-md-1 col-sm-1 col-1 mb-2" style="width: calc(100% / 7);">
                                        <div class="form-check" style="margin-left: -8px;">
                                            <input class="form-check-input personel-checkbox" type="checkbox" value="{{ user }}" id="personel_{{ loop.index }}">
                                            <label class="form-check-label" for="personel_{{ loop.index }}" style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                {{ user }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="durum" class="form-label">Durum</label>
                            <select class="form-select" id="durum" name="durum">
                                <option value="Aktif" selected>Aktif</option>
                                <option value="Pasif">Pasif</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <label for="bacaSayisi" class="form-label me-2 mb-0">Baca Sayısı:</label>
                                <input type="number" class="form-control" id="bacaSayisi" name="bacaSayisi" min="1" placeholder="Sayı" style="width: 100px;">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="kaydetBtn">Kaydet</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
/* Tablo filtreleme stilleri */
.table th input {
    font-size: 0.875rem;
}

/* Responsive tasarım */
@media (max-width: 768px) {
    .btn-toolbar {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
}
</style>

<script>
// Template verilerini JavaScript'e geçir
var CITIES_DATA = JSON.parse('{{ CITIES_DATA | tojson | safe }}');
var USERS_DATA = JSON.parse('{{ users | tojson | safe }}');

$(document).ready(function() {
    // Tablo filtreleme
    function filterTable() {
        var firmaFilter = $('#firmaFilter').val().toLowerCase();
        var ilIlceFilter = $('#ilIlceFilter').val().toLowerCase();
        var kodFilter = $('#kodFilter').val().toLowerCase();
        var parametreFilter = $('#parametreFilter').val().toLowerCase();
        var personelFilter = $('#personelFilter').val().toLowerCase();
        var durumFilter = $('#durumFilter').val().toLowerCase();
        var baslangicFrom = $('#baslangicFrom').val();
        var baslangicTo = $('#baslangicTo').val();
        var bitisFrom = $('#bitisFrom').val();
        var bitisTo = $('#bitisTo').val();

        $('#olcumTablo tbody tr').each(function() {
            var row = $(this);
            var firma = row.find('td:eq(2)').text().toLowerCase();
            var ilIlce = row.find('td:eq(3)').text().toLowerCase();
            var kod = row.find('td:eq(4)').text().toLowerCase();
            var parametre = row.find('td:eq(6)').text().toLowerCase();
            var personel = row.find('td:eq(8)').text().toLowerCase();
            var durum = row.find('td:eq(9)').text().toLowerCase();
            var baslangic = row.find('td:eq(7)').text();
            var bitis = row.find('td:eq(8)').text();

            var show = true;

            if (firmaFilter && !firma.includes(firmaFilter)) show = false;
            if (ilIlceFilter && !ilIlce.includes(ilIlceFilter)) show = false;
            if (kodFilter && !kod.includes(kodFilter)) show = false;
            if (parametreFilter && !parametre.includes(parametreFilter)) show = false;
            if (personelFilter && !personel.includes(personelFilter)) show = false;
            if (durumFilter && !durum.includes(durumFilter)) show = false;

            // Tarih filtreleme
            if (baslangicFrom && baslangic < baslangicFrom) show = false;
            if (baslangicTo && baslangic > baslangicTo) show = false;
            if (bitisFrom && bitis < bitisFrom) show = false;
            if (bitisTo && bitis > bitisTo) show = false;

            if (show) {
                row.show();
            } else {
                row.hide();
            }
        });

        // Satır numaralarını güncelle
        $('#olcumTablo tbody tr:visible').each(function(index) {
            $(this).find('td:eq(1)').text(index + 1);
        });
    }

    // Filtre olay dinleyicileri
    $('#firmaFilter, #ilIlceFilter, #kodFilter, #parametreFilter, #personelFilter, #durumFilter, #baslangicFrom, #baslangicTo, #bitisFrom, #bitisTo').on('input change', function() {
        filterTable();
    });

    // Tekil checkbox işlevselliği
    $(document).on('change', '.row-checkbox', function() {
        var totalCheckboxes = $('.row-checkbox:visible').length;
        var checkedCheckboxes = $('.row-checkbox:visible:checked').length;
        
        if (checkedCheckboxes === 0) {
            $('#selectAll').prop('indeterminate', false).prop('checked', false);
            $('#secilenleriSilBtn').prop('disabled', true);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#selectAll').prop('indeterminate', false).prop('checked', true);
            $('#secilenleriSilBtn').prop('disabled', false);
        } else {
            $('#selectAll').prop('indeterminate', true);
            $('#secilenleriSilBtn').prop('disabled', false);
        }
    });

    // Tümünü Seç checkbox işlevselliği
    $('#selectAll').on('change', function() {
        var isChecked = $(this).is(':checked');
        $('.row-checkbox:visible').prop('checked', isChecked);
        
        // Seçilenleri Sil butonunu güncelle
        var checkedCount = $('.row-checkbox:visible:checked').length;
        $('#secilenleriSilBtn').prop('disabled', checkedCount === 0);
    });

    // Seçilenleri Sil butonu işlevselliği
    $('#secilenleriSilBtn').on('click', function() {
        var selectedIds = $('.row-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
        
        if (selectedIds.length === 0) {
            alert('Silinecek ölçüm seçilmedi!');
            return;
        }
        
        if (confirm('Seçilen ' + selectedIds.length + ' ölçümü silmek istediğinizden emin misiniz?')) {
            deleteSelectedMeasurements(selectedIds);
        }
    });

    // Seçilen ölçümleri silme fonksiyonu
    function deleteSelectedMeasurements(ids) {
        $.ajax({
            url: '/delete_selected_measurements',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Silme işlemi sırasında hata: ' + response.error);
                }
            },
            error: function() {
                alert('Silme işlemi sırasında hata oluştu!');
            }
        });
    }

    // Ölçüm Oluştur Modal işlevselliği
    $('#olcumOlusturBtn').on('click', function() {
        console.log('Ölçüm Oluştur butonuna tıklandı');
        $('#olcumOlusturModal').modal('show');
        loadIller();
    });

    // İlleri yükleme fonksiyonu
    function loadIller() {
        var iller = [];
        CITIES_DATA.forEach(function(city) {
            iller.push(city.il_adi);
        });
        
        // Özel sıralama - belirtilen illeri en üstte göster
        var priorityIller = ['KOCAELİ', 'İSTANBUL', 'SAKARYA', 'DÜZCE', 'BOLU', 'BİLECİK', 'BURSA', 'KÜTAHYA', 'BALIKESİR'];
        var otherIller = iller.filter(function(il) {
            return !priorityIller.includes(il);
        }).sort();
        
        // Önce öncelikli iller, sonra diğerleri
        var sortedIller = priorityIller.concat(otherIller);
        
        $('#il').empty().append('<option value="">İl Seçiniz</option>');
        sortedIller.forEach(function(il) {
            $('#il').append('<option value="' + il + '">' + il + '</option>');
        });
    }

    // İl seçildiğinde ilçeleri yükleme
    $('#il').on('change', function() {
        var selectedIl = $(this).val();
        $('#ilce').empty().append('<option value="">İlçe Seçiniz</option>');
        
        if (selectedIl) {
            // Seçilen ile ait ilçeleri bul
            var selectedCity = CITIES_DATA.find(function(city) {
                return city.il_adi === selectedIl;
            });
            
            if (selectedCity && selectedCity.ilceler) {
                selectedCity.ilceler.forEach(function(ilce) {
                    $('#ilce').append('<option value="' + ilce.ilce_adi + '">' + ilce.ilce_adi + '</option>');
                });
            }
        }
    });

    // Kaydet butonu işlevselliği
    $('#kaydetBtn').on('click', function() {
        // Tüm zorunlu alanları kontrol et
        var firmaAdi = $('#firmaAdi').val().trim();
        var il = $('#il').val();
        var ilce = $('#ilce').val();
        var olcumKodu = $('#olcumKodu').val().trim();
        var olcumBaslangic = $('#olcumBaslangic').val();
        var olcumBitis = $('#olcumBitis').val();
        var durum = $('#durum').val();
        var selectedPersonnel = $('.personel-checkbox:checked').length;
        
        console.log('Seçilen personel sayısı:', selectedPersonnel);
        console.log('Tüm personel checkbox\'ları:', $('.personel-checkbox').length);
        console.log('İşaretli checkbox\'lar:', $('.personel-checkbox:checked').length);
        
        // Hata mesajları dizisi
        var errors = [];
        
        if (!firmaAdi) {
            errors.push('Firma adı zorunludur');
        }
        if (!il) {
            errors.push('İl seçimi zorunludur');
        }
        if (!ilce) {
            errors.push('İlçe seçimi zorunludur');
        }
        if (!olcumKodu) {
            errors.push('Ölçüm kodu zorunludur');
        }
        if (!olcumBaslangic) {
            errors.push('Başlangıç tarihi zorunludur');
        }
        if (!olcumBitis) {
            errors.push('Bitiş tarihi zorunludur');
        }
        if (selectedPersonnel === 0) {
            errors.push('En az bir personel seçmelisiniz');
        }
        if (!durum) {
            errors.push('Durum seçimi zorunludur');
        }
        
        // Hata varsa göster ve işlemi durdur
        if (errors.length > 0) {
            alert('Lütfen aşağıdaki hataları düzeltin:\n\n' + errors.join('\n'));
            return;
        }
        
        // Tüm veriler doğruysa kaydetme işlemini başlat
        var formData = {
            firmaAdi: firmaAdi,
            il: il,
            ilce: ilce,
            olcumKodu: olcumKodu,
            olcumBaslangic: olcumBaslangic,
            olcumBitis: olcumBitis,
            durum: durum,
            yetkili: $('#yetkili').val().trim(),
            telefonNo: $('#telefonNo').val().trim(),
            personel: $('.personel-checkbox:checked').map(function() {
                return $(this).val();
            }).get()
        };
        
        console.log('Form verileri:', formData); // Hata ayıklama için
        console.log('Seçilen personeller:', formData.personel); // Personel hata ayıklama
        console.log('Personel array uzunluğu:', formData.personel.length);
        
        // Ölçümü kaydetme fonksiyonunu çağır
        saveMeasurement(formData);
    });

    // Ölçümü kaydetme fonksiyonu
    function saveMeasurement(data) {
        // FormData nesnesi oluştur
        var formData = new FormData();
        formData.append('firmaAdi', data.firmaAdi);
        formData.append('il', data.il);
        formData.append('ilce', data.ilce);
        formData.append('olcumKodu', data.olcumKodu);
        formData.append('olcumBaslangic', data.olcumBaslangic);
        formData.append('olcumBitis', data.olcumBitis);
        formData.append('durum', data.durum);
        formData.append('yetkili', data.yetkili);
        formData.append('telefonNo', data.telefonNo);
        
        // Personel verilerini ekle
        data.personel.forEach(function(personel) {
            formData.append('olcumPersoneli', personel);
        });
        
        console.log('Gönderilen personel:', data.personel); // Hata ayıklama için
        
        $.ajax({
            url: '/add_measurement',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Modal penceresini kapat
                    $('#olcumOlusturModal').modal('hide');
                    
                    // Başarı mesajı göster
                    alert('Ölçüm başarıyla oluşturuldu!');
                    
                    // Sayfayı yenile
                    location.reload();
                } else {
                    alert('Ölçüm oluşturulurken hata oluştu!');
                }
            },
            error: function() {
                alert('Ölçüm oluşturulurken hata oluştu!');
            }
        });
    }
});
</script>
{% endblock %} 