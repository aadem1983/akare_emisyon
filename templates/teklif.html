{% extends "base.html" %}

{% block title %}TEKLİF{% endblock %}

<style>
    /* Zengin Metin Editörü CSS */
    .rich-text-toolbar {
        border: 1px solid #dee2e6;
        border-bottom: none;
        border-radius: 0.375rem 0.375rem 0 0;
        padding: 0.5rem;
        background-color: #f8f9fa;
    }
    
    .rich-text-editor {
        border: 1px solid #dee2e6;
        border-radius: 0 0 0.375rem 0.375rem;
        padding: 0.75rem;
        background-color: #fff;
        outline: none;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        font-family: "Times New Roman", Times, serif;
        font-size: 10pt;
        line-height: 1.4;
    }
    
    .rich-text-editor:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .rich-text-editor[contenteditable="true"]:empty:before {
        content: attr(placeholder);
        color: #6c757d;
        font-style: italic;
    }
    
    /* Word benzeri paragraf ve liste stilleri */
    .rich-text-editor p {
        margin: 0 0 6pt 0;
        font-family: "Times New Roman", Times, serif;
        font-size: 10pt;
        line-height: 1.4;
    }
    
    .rich-text-editor ul {
        margin: 0 0 6pt 0;
        padding-left: 20pt;
        font-family: "Times New Roman", Times, serif;
        font-size: 10pt;
        line-height: 1.4;
    }
    
    .rich-text-editor li {
        margin: 0 0 3pt 0;
        font-family: "Times New Roman", Times, serif;
        font-size: 10pt;
        line-height: 1.4;
    }
    
    .rich-text-editor strong {
        font-weight: bold;
        font-family: "Times New Roman", Times, serif;
    }
    
    .rich-text-editor em {
        font-style: italic;
        font-family: "Times New Roman", Times, serif;
    }

    .parametre-secim-table {
        table-layout: fixed;
        width: max-content !important;
        min-width: 0 !important;
        display: inline-table;
        border-collapse: separate;
        border-spacing: 0;
    }

    .parametre-secim-table th,
    .parametre-secim-table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
        padding: 4px 6px;
    }

    .parametre-secim-table {
        border: 1px solid rgba(0,0,0,.15);
        background: #fff;
    }

    .parametre-secim-table thead th {
        border-bottom: 1px solid rgba(255,255,255,.25);
    }

    .parametre-secim-table thead th {
        position: relative;
    }

    .parametre-secim-table thead th .col-resizer {
        position: absolute;
        top: 0;
        right: -2px;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
    }

    .parametre-secim-table tbody td,
    .parametre-secim-table tbody th {
        border-top: 1px solid rgba(0,0,0,.08);
    }

    .parametre-secim-table tbody td + td,
    .parametre-secim-table thead th + th {
        border-left: 1px solid rgba(0,0,0,.10);
    }

    .parametre-secim-table tbody tr {
        background: #fff !important;
    }

    .parametre-secim-table tbody tr:hover {
        background: rgba(13, 110, 253, 0.06) !important;
    }

    .parametre-secim-table thead tr.parametre-filter-row th {
        background: #ffffff;
        color: #212529;
        border-top: 0;
        border-bottom: 1px solid rgba(0,0,0,.15);
        padding: 2px 4px;
    }

    .parametre-secim-table thead tr.parametre-filter-row input,
    .parametre-secim-table thead tr.parametre-filter-row select {
        width: 100%;
        font-size: 12px;
        padding: 2px 4px;
        height: 24px;
    }
</style>

{% block content %}
<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="min-height: calc(100vh - 100px);">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-file-contract me-2"></i>
                            Teklif Sistemi
                        </h4>
                                                 <div class="btn-group" role="group">
                             <button class="btn btn-light btn-sm" id="btnYeniTeklif">
                                 <i class="fas fa-plus me-1"></i>
                                 Yeni Teklif
                             </button>
                             <button class="btn btn-danger btn-sm" onclick="deleteSelectedTeklifler()">
                                 <i class="fas fa-trash me-1"></i>
                                 Seçilenleri Sil
                             </button>
                             <button class="btn btn-warning btn-sm" onclick="showParametreYonetimi()">
                                 <i class="fas fa-cog me-1"></i>
                                 Parametre Yönetimi
                             </button>
                             <button class="btn btn-success btn-sm" onclick="exportTeklifler()">
                                 <i class="fas fa-download me-1"></i>
                                 Dışa Aktar
                             </button>
                             <button class="btn btn-info btn-sm" onclick="importTeklifler()">
                                 <i class="fas fa-upload me-1"></i>
                                 İçe Aktar
                             </button>
                         </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                                         <!-- Teklif Listesi -->
                     <div id="teklifListesi" class="p-3">
                         <!-- Filtreleme Bölümü -->
                         <div class="card mb-3">
                             <div class="card-header bg-light">
                                 <h6 class="mb-0">
                                     <i class="fas fa-filter me-2"></i>
                                     Filtreleme
                                 </h6>
                             </div>
                             <div class="card-body">
                                 <div class="row">
                                    <div class="col-md-2">
                                         <div class="mb-3">
                                             <label for="filterTeklifNo" class="form-label">Teklif No</label>
                                             <input type="text" class="form-control" id="filterTeklifNo" placeholder="Teklif no ara...">
                                         </div>
                                     </div>
                                     <div class="col-md-3">
                                         <div class="mb-3">
                                             <label for="filterFirma" class="form-label">Firma</label>
                                             <input type="text" class="form-control" id="filterFirma" placeholder="Firma ara...">
                                         </div>
                                     </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="filterBaslangicTarih" class="form-label">Teklif Tarihi ≥</label>
                                            <input type="date" class="form-control" id="filterBaslangicTarih">
                                        </div>
                                    </div>
                                     <div class="col-md-2">
                                         <div class="mb-3">
                                             <label for="filterTeklifTipi" class="form-label">Teklif Tipi</label>
                                        <select class="form-select" id="filterTeklifTipi">
                                            <option value="">Tümü</option>
                                            <option value="KAPSAM İÇİ">KAPSAM İÇİ</option>
                                            <option value="KAPSAM DIŞI">KAPSAM DIŞI</option>
                                            <option value="İŞ BİRLİĞİ">İŞ BİRLİĞİ</option>
                                        </select>
                                         </div>
                                     </div>
                                     <div class="col-md-2">
                                         <div class="mb-3">
                                             <label for="filterDurum" class="form-label">Teklif Durumu</label>
                                             <select class="form-select" id="filterDurum">
                                                 <option value="">Tümü</option>
                                                 <option value="BEKLEMEDE">BEKLEMEDE</option>
                                                 <option value="KABUL">KABUL</option>
                                                 <option value="RED">RED</option>
                                             </select>
                                         </div>
                                     </div>
                                    <div class="col-md-1">
                                         <div class="mb-3">
                                             <label class="form-label">&nbsp;</label>
                                             <div class="d-grid">
                                                 <button type="button" class="btn btn-primary" onclick="filterTeklifler()">
                                                     <i class="fas fa-search me-1"></i>
                                                     Filtrele
                                                 </button>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="table-responsive">
                             <table class="table table-striped table-hover">
                                 <thead class="table-dark">
                                     <tr>
                                         <th class="text-center" width="50">
                                             <input type="checkbox" id="tumunuSecTeklif" class="form-check-input" onchange="tumunuSecTeklif(this)">
                                         </th>
                                         <th class="text-center">SIRA</th>
                                        <th style="width: 130px;">TEKLİF NO</th>
                                         <th>FİRMA ADI</th>
                                         <th>TEKLİF TİPİ</th>
                                         <th>TEKLİF TARİHİ</th>
                                         <th class="text-end">TOP FİYAT</th>
                                         <th class="text-end">İSKONTO (TL)</th>
                                         <th class="text-end">SON FİYAT</th>
                                         <th>TEKLİF DURUMU</th>
                                         <th>DRM TRH.</th>
                                         <th class="text-center">İŞLEMLER</th>
                                     </tr>
                                 </thead>
                                 <tbody id="teklifTablosu">
                                     {% for teklif in teklifler %}
                                     <tr data-teklif-id="{{ teklif.id }}">
                                         <td class="text-center">
                                             <input type="checkbox" name="selected_teklifler" class="form-check-input teklif-secim-checkbox" value="{{ teklif.id }}">
                                         </td>
                                         <td class="text-center">{{ loop.index }}</td>
                                        <td style="width: 130px; white-space: nowrap;">{{ teklif.teklif_no }}</td>
                                         <td>{{ teklif.firma_adi }}</td>
                                         <td>{{ teklif.teklif_tipi }}</td>
                                         <td>{{ format_tarih_gg_aa_yyyy(teklif.teklif_tarihi) }}</td>
                                         <td class="text-end">{{ "%.2f"|format(teklif.toplam or 0) }} TL</td>
                                         <td class="text-end">{{ "%.2f"|format(teklif.indirim or 0) }} TL</td>
                                         <td class="text-end">{{ "%.2f"|format(teklif.netToplam or 0) }} TL</td>
                                         <td>
                                             <select class="form-select form-select-sm" onchange="updateTeklifDurum('{{ teklif.id }}', this.value)" style="min-width: 140px;">
                                                 <option value="BEKLEMEDE" {{ 'selected' if (teklif.teklif_durumu or 'BEKLEMEDE') == 'BEKLEMEDE' else '' }}>
                                                     BEKLEMEDE
                                                 </option>
                                                 <option value="KABUL" {{ 'selected' if (teklif.teklif_durumu or 'BEKLEMEDE') == 'KABUL' else '' }}>
                                                     KABUL
                                                 </option>
                                                 <option value="RED" {{ 'selected' if (teklif.teklif_durumu or 'BEKLEMEDE') == 'RED' else '' }}>
                                                     RED
                                                 </option>
                                             </select>
                                         </td>
                                         <td>
                                             <input type="date" class="form-control form-control-sm" 
                                                    value="{{ teklif.durum_tarihi or '' }}" 
                                                    onchange="updateDurumTarihi('{{ teklif.id }}', this.value)"
                                                    style="min-width: 130px;">
                                         </td>
                                         <td class="text-center">
                                             <div class="btn-group btn-group-sm">
                                                 <button class="btn btn-outline-info" title="Yazdır" onclick="teklifiYazdir('{{ teklif.id }}')">
                                                     <i class="fas fa-print"></i>
                                                 </button>
                                                 <button class="btn btn-outline-primary" title="Detay" onclick="showTeklifDetail('{{ teklif.id }}')">
                                                     <i class="fas fa-eye"></i>
                                                 </button>
                                                 <button class="btn btn-outline-warning" title="Düzenle" onclick="editTeklif('{{ teklif.id }}')">
                                                     <i class="fas fa-pencil"></i>
                                                 </button>
                                                 <button class="btn btn-outline-danger" title="Sil" onclick="deleteTeklif('{{ teklif.id }}')">
                                                     <i class="fas fa-times"></i>
                                                 </button>
                                             </div>
                                         </td>
                                     </tr>
                                     {% endfor %}
                                 </tbody>
                             </table>
                         </div>
                     </div>

                                         <!-- Yeni Teklif Formu - İlk Aşama -->
                     <div id="yeniTeklifForm" class="p-3 bg-light border-bottom" style="display: none;">
                         <h5 class="mb-3">
                             <i class="fas fa-plus-circle me-2"></i>
                             Yeni Teklif - 1. Aşama
                         </h5>
                         <form id="teklifForm">
                             <div class="row">
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="teklifTipi" class="form-label">Teklif Tipi *</label>
                                        <select class="form-select" id="teklifTipi" name="teklif_tipi" required>
                                            <option value="">Seçiniz</option>
                                            <option value="KAPSAM İÇİ">KAPSAM İÇİ</option>
                                            <option value="KAPSAM DIŞI">KAPSAM DIŞI</option>
                                            <option value="İŞ BİRLİĞİ">İŞ BİRLİĞİ</option>
                                        </select>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="firmaAdi" class="form-label">Firma Adı *</label>
                                         <input class="form-control" id="firmaAdi" name="firma_adi" list="firmaAdiList" placeholder="Firma Seçiniz" autocomplete="off" required>
                                         <datalist id="firmaAdiList">
                                             {% for firma in firma_kayitlar %}
                                             <option value="{{ firma.firmaAdi }}"></option>
                                             {% endfor %}
                                         </datalist>
                                     </div>
                                 </div>
                             </div>
                             <div class="row">
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="teklifTarihi" class="form-label">Teklif Tarihi *</label>
                                         <input type="date" class="form-control" id="teklifTarihi" name="teklif_tarihi" required>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="teklifNo" class="form-label">Teklif No *</label>
                                         <div class="input-group">
                                             <input type="text" class="form-control" id="teklifNo" name="teklif_no" required>
                                             <button class="btn btn-outline-secondary" type="button" onclick="getNextTeklifNo()">
                                                 <i class="fas fa-magic"></i>
                                             </button>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <div class="d-flex justify-content-end gap-2">
                                 <button type="button" class="btn btn-secondary" onclick="cancelTeklif()">
                                     <i class="fas fa-times me-1"></i>
                                     İptal
                                 </button>
                                 <button type="submit" class="btn btn-primary">
                                     <i class="fas fa-arrow-right me-1"></i>
                                     2. Aşamaya Geç
                                 </button>
                             </div>
                         </form>
                     </div>

                     <!-- Yeni Teklif Formu - İkinci Aşama - Parametre Seçimi -->
                     <div id="teklifAsama2" class="p-3 bg-light border-bottom" style="display: none;">
                         <h5 class="mb-3">
                             <i class="fas fa-list me-2"></i>
                             Yeni Teklif - 2. Aşama (Parametre Seçimi)
                         </h5>
                         
                         <!-- Üst Butonlar -->
                         <div class="d-flex justify-content-end mb-3 gap-2">
                             <button type="button" class="btn btn-info" onclick="bacaBilgileriniOkuVeParametreSec()">
                                 <i class="fas fa-search me-1"></i>
                                 Baca Bilgilerini Oku
                             </button>
                             <button type="button" class="btn btn-success" onclick="otomatikFiyatHesapla()">
                                 <i class="fas fa-calculator me-1"></i>
                                 Otomatik Fiyat Hesapla
                             </button>
                             <button type="button" class="btn btn-primary" onclick="secilenParametreleriEkle()">
                                 <i class="fas fa-plus me-1"></i>
                                 Seçilen Parametreleri Ekle
                             </button>
                         </div>
                         
                         <!-- Parametre Seçim Tablosu -->
                         <div class="table-responsive mb-3">
                             <table class="table table-bordered parametre-secim-table">
                                 <colgroup>
                                     <col style="width: 50px;">
                                     <col style="width: 60px;">
                                     <col style="width: 110px;">
                                     <col style="width: 360px;">
                                     <col style="width: 280px;">
                                     <col style="width: 160px;">
                                 </colgroup>
                                 <thead class="table-dark">
                                     <tr>
                                         <th class="text-center" width="50">
                                             <input type="checkbox" id="tumunuSec" class="form-check-input" onchange="tumunuSec(this)">
                                         </th>
                                         <th class="text-center" width="60">SIRA</th>
                                         <th class="text-center" width="110">KAPSAM</th>
                                         <th>PARAMETRE ADI</th>
                                         <th>METOT</th>
                                         <th class="text-end">BİRİM FİYAT (TL)</th>
                                     </tr>
                                     <tr class="parametre-filter-row">
                                         <th></th>
                                         <th></th>
                                         <th>
                                             <select id="teklifFilterKapsam" class="form-select form-select-sm">
                                                 <option value="">Tümü</option>
                                                 <option value="EMİSYON">EMİSYON</option>
                                                 <option value="İMİSYON">İMİSYON</option>
                                                 <option value="İŞBİR">İŞBİR</option>
                                             </select>
                                         </th>
                                         <th>
                                             <input id="teklifFilterParametre" class="form-control form-control-sm" list="teklifFilterParametreList" placeholder="Süz...">
                                             <datalist id="teklifFilterParametreList"></datalist>
                                         </th>
                                         <th>
                                             <input id="teklifFilterMetot" class="form-control form-control-sm" list="teklifFilterMetotList" placeholder="Süz...">
                                             <datalist id="teklifFilterMetotList"></datalist>
                                         </th>
                                         <th>
                                             <input id="teklifFilterFiyat" class="form-control form-control-sm" placeholder="Süz...">
                                         </th>
                                     </tr>
                                 </thead>
                                 <tbody id="parametreSecimTablosu">
                                     <!-- Parametreler JavaScript ile doldurulacak -->
                                 </tbody>
                             </table>
                         </div>

                         <!-- Butonlar -->
                         <div class="d-flex justify-content-between mt-3">
                             <button type="button" class="btn btn-secondary" onclick="geriAsama1()">
                                 <i class="fas fa-arrow-left me-1"></i>
                                 1. Aşamaya Geri Dön
                             </button>
                             <div class="d-flex gap-2">
                                 <button type="button" class="btn btn-info" onclick="bacaBilgileriniOkuVeParametreSec()">
                                     <i class="fas fa-search me-1"></i>
                                     Baca Bilgilerini Oku
                                 </button>
                                 <button type="button" class="btn btn-success" onclick="otomatikFiyatHesapla()">
                                     <i class="fas fa-calculator me-1"></i>
                                     Otomatik Fiyat Hesapla
                                 </button>
                                 <button type="button" class="btn btn-primary" onclick="secilenParametreleriEkle()">
                                     <i class="fas fa-plus me-1"></i>
                                     Seçilen Parametreleri Ekle
                                 </button>
                             </div>
                         </div>
                     </div>

                     <!-- Yeni Teklif Formu - İkinci Aşama - Fiyat Girişi -->
                     <div id="teklifAsama2Fiyat" class="p-3 bg-light border-bottom" style="display: none;">
                         <h5 class="mb-3">
                             <i class="fas fa-calculator me-2"></i>
                             Yeni Teklif - 2. Aşama (Fiyat Girişi)
                         </h5>
                         
                         <!-- Seçilen Parametreler Tablosu -->
                         <div class="table-responsive mb-3">
                             <table class="table table-striped table-hover">
                                 <thead class="table-dark">
                                     <tr>
                                         <th class="text-center" width="50">SIRA</th>
                                         <th>PARAMETRE ADI</th>
                                         <th>METOT</th>
                                         <th class="text-end">BİRİM FİYAT (TL)</th>
                                         <th class="text-center">ADET</th>
                                         <th class="text-end">TOP.FİYAT (TL)</th>
                                         <th class="text-center" width="80">İŞLEM</th>
                                     </tr>
                                 </thead>
                                 <tbody id="secilenParametrelerTablosu">
                                     <!-- Seçilen parametreler buraya eklenecek -->
                                 </tbody>
                             </table>
                         </div>

                         <!-- Özet Bilgiler -->
                         <div class="row">
                             <div class="col-md-4">
                                 <div class="card">
                                     <div class="card-header bg-info text-white">
                                         <h6 class="mb-0">Teklif Özeti</h6>
                                     </div>
                                     <div class="card-body">
                                         <div class="row">
                                             <div class="col-6">
                                                 <strong>Teklif No:</strong><br>
                                                 <span id="ozetTeklifNo">-</span>
                                             </div>
                                             <div class="col-6">
                                                 <strong>Firma:</strong><br>
                                                 <span id="ozetFirmaAdi">-</span>
                                             </div>
                                         </div>
                                         <hr>
                                         <div class="row">
                                             <div class="col-6">
                                                 <strong>Teklif Tipi:</strong><br>
                                                 <span id="ozetTeklifTipi">-</span>
                                             </div>
                                             <div class="col-6">
                                                 <strong>Tarih:</strong><br>
                                                 <span id="ozetTeklifTarihi">-</span>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <div class="col-md-4">
                                 <div class="card">
                                     <div class="card-header bg-warning text-dark">
                                         <h6 class="mb-0">İndirim Ayarları</h6>
                                     </div>
                                     <div class="card-body">
                                         <div class="mb-3">
                                             <label for="indirimOrani" class="form-label">İndirim Oranı</label>
                                             <div class="input-group">
                                                 <input type="number" class="form-control" id="indirimOrani" name="indirim_orani" step="0.01" min="0" value="0">
                                                 <select class="form-select" id="indirimTipi" name="indirim_tipi" style="max-width: 80px;">
                                                     <option value="TL">TL</option>
                                                     <option value="%">%</option>
                                                 </select>
                                             </div>
                                         </div>
                                         <div class="mb-3">
                                             <button type="button" class="btn btn-warning btn-sm w-100" onclick="indirimUygula()">
                                                 <i class="fas fa-calculator me-1"></i>
                                                 İndirimi Uygula
                                             </button>
                                         </div>
                                         <div class="text-center">
                                             <small class="text-muted">Toplam fiyatı gördükten sonra indirim oranını belirleyebilirsiniz</small>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <div class="col-md-4">
                                 <div class="card">
                                     <div class="card-header bg-success text-white">
                                         <h6 class="mb-0">Fiyat Özeti</h6>
                                     </div>
                                     <div class="card-body">
                                         <div class="row">
                                             <div class="col-6">
                                                 <strong>TOPLAM:</strong><br>
                                                 <span id="ozetToplam">0.00 TL</span>
                                             </div>
                                             <div class="col-6">
                                                 <strong>İNDİRİM:</strong><br>
                                                 <span id="ozetIndirim">0.00 TL</span>
                                             </div>
                                         </div>
                                         <hr>
                                         <div class="row">
                                             <div class="col-12">
                                                 <strong>NET TOPLAM:</strong><br>
                                                 <span id="ozetNetToplam" class="h5 text-success">0.00 TL</span>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- Butonlar -->
                         <div class="d-flex justify-content-between mt-3">
                             <button type="button" class="btn btn-secondary" onclick="geriAsama1()">
                                 <i class="fas fa-arrow-left me-1"></i>
                                 Geri Dön
                             </button>
                             <div class="btn-group">
                                 <button type="button" class="btn btn-success" onclick="saveFinalTeklif()">
                                     <i class="fas fa-save me-1"></i>
                                     Teklifi Kaydet
                                 </button>
                                 <button type="button" class="btn btn-primary" onclick="teklifiYazdir()">
                                     <i class="fas fa-print me-1"></i>
                                     Yazdır
                                 </button>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Teklif Detay Modal -->
<div class="modal fade" id="teklifDetayModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Teklif Detayı
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="teklifDetayIcerik">
                    <!-- Teklif detayları buraya yüklenecek -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" onclick="teklifiYazdir()">
                    <i class="fas fa-print me-1"></i>
                    Yazdır
                </button>
            </div>
        </div>
    </div>
</div>

 <!-- Teklif Düzenleme Modal -->
 <div class="modal fade" id="teklifDuzenleModal" tabindex="-1" aria-labelledby="teklifDuzenleModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-xl">
         <div class="modal-content">
             <div class="modal-header bg-warning text-dark">
                 <h5 class="modal-title" id="teklifDuzenleModalLabel">
                     <i class="fas fa-edit me-2"></i>
                     Teklif Düzenle
                 </h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
             </div>
             <div class="modal-body">
                 <form id="teklifDuzenleForm">
                     <input type="hidden" id="duzenleTeklifId">
                     
                     <!-- Genel Bilgiler -->
                     <div class="card mb-3">
                         <div class="card-header bg-info text-white">
                             <h6 class="mb-0">Genel Bilgiler</h6>
                         </div>
                         <div class="card-body">
                             <div class="row">
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="duzenleTeklifTipi" class="form-label">Teklif Tipi *</label>
                                        <select class="form-select" id="duzenleTeklifTipi" required>
                                            <option value="">Seçiniz</option>
                                            <option value="KAPSAM İÇİ">KAPSAM İÇİ</option>
                                            <option value="KAPSAM DIŞI">KAPSAM DIŞI</option>
                                            <option value="İŞ BİRLİĞİ">İŞ BİRLİĞİ</option>
                                        </select>
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <div class="mb-3">
                                         <label for="duzenleFirmaAdi" class="form-label">Firma Adı *</label>
                                         <input type="text" class="form-control" id="duzenleFirmaAdi" required>
                                     </div>
                                 </div>
                             </div>
                             <div class="row">
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="duzenleTeklifTarihi" class="form-label">Teklif Tarihi *</label>
                                         <input type="date" class="form-control" id="duzenleTeklifTarihi" required>
                                     </div>
                                 </div>
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="duzenleTeklifNo" class="form-label">Teklif No *</label>
                                         <input type="text" class="form-control" id="duzenleTeklifNo" required>
                                     </div>
                                 </div>
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="duzenleIndirimOrani" class="form-label">İndirim Oranı</label>
                                         <div class="input-group">
                                             <input type="number" class="form-control" id="duzenleIndirimOrani" step="0.01" min="0">
                                             <select class="form-select" id="duzenleIndirimTipi" style="max-width: 80px;">
                                                 <option value="TL">TL</option>
                                                 <option value="%">%</option>
                                             </select>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <!-- Parametreler -->
                     <div class="card mb-3">
                         <div class="card-header bg-primary text-white">
                             <h6 class="mb-0">Parametreler</h6>
                         </div>
                         <div class="card-body">
                             <div class="table-responsive">
                                 <table class="table table-striped table-hover">
                                     <thead class="table-dark">
                                         <tr>
                                             <th class="text-center" width="50">SIRA</th>
                                             <th>PARAMETRE ADI</th>
                                             <th>METOT</th>
                                             <th>BİRİM FİYAT (TL)</th>
                                             <th>ADET</th>
                                             <th class="text-end">TOP.FİYAT (TL)</th>
                                             <th class="text-center" width="80">İŞLEM</th>
                                         </tr>
                                     </thead>
                                     <tbody id="duzenleParametrelerTablosu">
                                         <!-- Parametreler JavaScript ile doldurulacak -->
                                     </tbody>
                                 </table>
                             </div>
                             <div class="text-center mt-3">
                                 <button type="button" class="btn btn-success" onclick="duzenleParametreEkle()">
                                     <i class="fas fa-plus me-1"></i>
                                     Parametre Ekle
                                 </button>
                             </div>
                         </div>
                     </div>

                     <!-- Özet -->
                     <div class="card">
                         <div class="card-header bg-success text-white">
                             <h6 class="mb-0">Fiyat Özeti</h6>
                         </div>
                         <div class="card-body">
                             <div class="row">
                                 <div class="col-md-4">
                                     <strong>TOPLAM:</strong> <span id="duzenleToplam">0.00 TL</span>
                                 </div>
                                 <div class="col-md-4">
                                     <strong>İNDİRİM:</strong> <span id="duzenleIndirim">0.00 TL</span>
                                 </div>
                                 <div class="col-md-4">
                                     <strong>NET TOPLAM:</strong> <span id="duzenleNetToplam" class="h5 text-success">0.00 TL</span>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </form>
             </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="teklifGuncelle()">
                    <i class="fas fa-save me-1"></i>
                    Güncelle
                </button>
            </div>
         </div>
     </div>
 </div>

 <!-- Parametre Yönetimi Modal -->
 <div class="modal fade" id="parametreYonetimiModal" tabindex="-1">
     <div class="modal-dialog modal-lg">
         <div class="modal-content">
             <div class="modal-header bg-warning text-dark">
                 <h5 class="modal-title">
                     <i class="fas fa-cog me-2"></i>
                     Parametre Yönetimi
                 </h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
             </div>
             <div class="modal-body">
                 <!-- Yeni Parametre Ekleme Formu -->
                 <div class="card mb-3">
                     <div class="card-header">
                         <h6 class="mb-0">Yeni Parametre Ekle</h6>
                     </div>
                     <div class="card-body">
                         <form id="yeniParametreForm">
                             <div class="row">
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="yeniParametreAdi" class="form-label">Parametre Adı *</label>
                                         <input type="text" class="form-control" id="yeniParametreAdi" required>
                                     </div>
                                 </div>
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="yeniParametreMetot" class="form-label">Metot</label>
                                         <input type="text" class="form-control" id="yeniParametreMetot">
                                     </div>
                                 </div>
                                 <div class="col-md-4">
                                     <div class="mb-3">
                                         <label for="yeniParametreFiyat" class="form-label">Birim Fiyat (TL) *</label>
                                         <input type="number" class="form-control" id="yeniParametreFiyat" step="0.01" min="0" required>
                                     </div>
                                 </div>
                             </div>
                             <div class="text-end">
                                 <button type="submit" class="btn btn-primary">
                                     <i class="fas fa-plus me-1"></i>
                                     Parametre Ekle
                                 </button>
                             </div>
                         </form>
                     </div>
                 </div>

                 <!-- Mevcut Parametreler Tablosu -->
                 <div class="card">
                     <div class="card-header">
                         <h6 class="mb-0">Mevcut Parametreler</h6>
                     </div>
                     <div class="card-body">
                         <div class="table-responsive">
                             <table class="table table-striped table-hover">
                                 <thead class="table-dark">
                                     <tr>
                                         <th class="text-center" width="50">SIRA</th>
                                         <th>PARAMETRE ADI</th>
                                         <th>METOT</th>
                                         <th class="text-end">BİRİM FİYAT (TL)</th>
                                         <th class="text-center" width="80">İŞLEM</th>
                                     </tr>
                                 </thead>
                                 <tbody id="parametreYonetimiTablosu">
                                     <!-- Parametreler JavaScript ile doldurulacak -->
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
             </div>
         </div>
     </div>
 </div>
{% endblock %}

{% block scripts %}
<script>
 let editingTeklifId = null;
 let asgariFiyatlar = [];
 let asgariFiyatlarFull = [];
 let secilenParametreler = [];
 let teklifVerileri = {};
 let duzenleParametreler = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Teklif sayfası yüklendi');
    
    // Bugünün tarihini varsayılan olarak ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('teklifTarihi').value = today;
    
    // Otomatik teklif numarası al
    getNextTeklifNo();
    
    // Asgari fiyatları yükle
    loadAsgariFiyatlar();
    
    // Live filtering setup - Anlık süzme
    setupLiveFiltering();

    initTeklifParametreSecimResizable();
    initTeklifParametreSecimFilters();
});

function initTeklifParametreSecimFilters() {
    const table = document.querySelector('#teklifAsama2 .parametre-secim-table');
    if (!table) return;
    const kapsam = document.getElementById('teklifFilterKapsam');
    const param = document.getElementById('teklifFilterParametre');
    const metot = document.getElementById('teklifFilterMetot');
    const fiyat = document.getElementById('teklifFilterFiyat');
    if (!kapsam || !param || !metot || !fiyat) return;

    const onChange = () => applyTeklifParametreSecimFilters();
    kapsam.addEventListener('change', onChange);
    param.addEventListener('input', onChange);
    metot.addEventListener('input', onChange);
    fiyat.addEventListener('input', onChange);

    updateTeklifParametreSecimFilterOptions();
}

function updateTeklifParametreSecimFilterOptions() {
    const tbody = document.getElementById('parametreSecimTablosu');
    if (!tbody) return;
    const listParam = document.getElementById('teklifFilterParametreList');
    const listMetot = document.getElementById('teklifFilterMetotList');
    if (!listParam || !listMetot) return;

    const params = new Set();
    const metots = new Set();
    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (!tds || tds.length < 6) return;
        const p = (tds[3].textContent || '').trim();
        const m = (tds[4].textContent || '').trim();
        if (p) params.add(p);
        if (m) metots.add(m);
    });

    listParam.innerHTML = '';
    Array.from(params).sort((a, b) => a.localeCompare(b, 'tr')).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        listParam.appendChild(opt);
    });

    listMetot.innerHTML = '';
    Array.from(metots).sort((a, b) => a.localeCompare(b, 'tr')).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        listMetot.appendChild(opt);
    });
}

function applyTeklifParametreSecimFilters() {
    const tbody = document.getElementById('parametreSecimTablosu');
    if (!tbody) return;
    const kapsam = (document.getElementById('teklifFilterKapsam')?.value || '').toUpperCase().trim();
    const param = (document.getElementById('teklifFilterParametre')?.value || '').toLowerCase().trim();
    const metot = (document.getElementById('teklifFilterMetot')?.value || '').toLowerCase().trim();
    const fiyat = (document.getElementById('teklifFilterFiyat')?.value || '').toLowerCase().trim();

    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (!tds || tds.length < 6) return;
        const rowKapsam = (tds[2].textContent || '').toUpperCase().trim();
        const rowParam = (tds[3].textContent || '').toLowerCase();
        const rowMetot = (tds[4].textContent || '').toLowerCase();
        const rowFiyat = (tds[5].textContent || '').toLowerCase();

        const okK = !kapsam || rowKapsam === kapsam;
        const okP = !param || rowParam.includes(param);
        const okM = !metot || rowMetot.includes(metot);
        const okF = !fiyat || rowFiyat.includes(fiyat);
        tr.style.display = (okK && okP && okM && okF) ? '' : 'none';
    });
}

function initTeklifParametreSecimResizable() {
    const table = document.querySelector('#teklifAsama2 .parametre-secim-table');
    if (!table) return;
    const colgroup = table.querySelector('colgroup');
    if (!colgroup) return;
    const cols = Array.from(colgroup.querySelectorAll('col'));
    const headerRow = table.tHead ? table.tHead.rows[0] : null;
    if (!headerRow) return;

    const applyWidths = (colWidths) => {
        if (!colWidths || typeof colWidths !== 'object') return;
        cols.forEach((c, idx) => {
            const w = colWidths[String(idx)];
            const px = parseInt(w, 10);
            if (!isNaN(px) && px >= 30) {
                c.style.width = px + 'px';
            }
        });
    };

    const collectWidths = () => {
        const out = {};
        cols.forEach((c, idx) => {
            const w = c.style.width || '';
            const px = parseInt(w, 10);
            if (!isNaN(px) && px > 0) out[String(idx)] = px;
        });
        return out;
    };

    fetch('/api/ui_state/teklif_parametre_secim')
        .then(r => r.json())
        .then(resp => {
            if (resp && resp.success && resp.data && resp.data.col_widths) {
                applyWidths(resp.data.col_widths);
            }
        })
        .catch(() => {});

    const saveWidths = () => {
        const payload = { col_widths: collectWidths() };
        fetch('/api/ui_state/teklif_parametre_secim', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(() => {});
    };

    const addResizer = (th, colIndex) => {
        if (!th) return;
        if (th.querySelector('.col-resizer')) return;
        const grip = document.createElement('div');
        grip.className = 'col-resizer';
        th.appendChild(grip);

        grip.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const startX = e.clientX;
            const startW = cols[colIndex] ? (parseInt(cols[colIndex].style.width, 10) || th.getBoundingClientRect().width) : th.getBoundingClientRect().width;

            const onMove = (ev) => {
                const dx = ev.clientX - startX;
                const next = Math.max(30, Math.round(startW + dx));
                if (cols[colIndex]) cols[colIndex].style.width = next + 'px';
            };

            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
                saveWidths();
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
    };

    Array.from(headerRow.cells).forEach((th, idx) => {
        if (idx === 0) return;
        addResizer(th, idx);
    });
}

// Sayfa kapatıldığında rezerve numarayı serbest bırak
window.addEventListener('beforeunload', function() {
    if (reservedTeklifNo) {
        // Synchronous request kullan (sayfa kapanırken async çalışmayabilir)
        navigator.sendBeacon('/api/teklif/release_number', JSON.stringify({
            teklif_no: reservedTeklifNo
        }));
    }

    // Başlangıç tarihine varsayılan olarak yılın ilk günü ver
    const startDateInput = document.getElementById('filterBaslangicTarih');
    if (startDateInput) {
        const now = new Date();
        const defaultDate = `${now.getFullYear()}-01-01`;
        startDateInput.value = defaultDate; // her açılışta yılın ilk günü
        startDateInput.addEventListener('change', filterTeklifler);
    }
});

// Live filtering fonksiyonları
function setupLiveFiltering() {
    let filterTimeout;
    
    // Input alanları için debounced filtering (300ms gecikme)
    const filterInputs = ['filterTeklifNo', 'filterFirma'];
    filterInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    filterTeklifler();
                }, 300);
            });
        }
    });
    
    // Select alanları için anında filtering
    const filterSelects = ['filterTeklifTipi', 'filterDurum'];
    filterSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', function() {
                filterTeklifler();
            });
        }
    });
}

function parseTrDate(str) {
    if (!str) return null;
    const parts = str.trim().split('.');
    if (parts.length !== 3) return null;
    const [dd, mm, yyyy] = parts;
    const iso = `${yyyy}-${mm}-${dd}`;
    const d = new Date(iso);
    return isNaN(d.getTime()) ? null : d;
}

function getMinDateFilter() {
    const el = document.getElementById('filterBaslangicTarih');
    if (!el || !el.value) return null;
    const d = new Date(el.value);
    return isNaN(d.getTime()) ? null : d;
}

function filterTeklifler() {
    const filterTeklifNo = document.getElementById('filterTeklifNo').value.toLowerCase();
    const filterFirma = document.getElementById('filterFirma').value.toLowerCase();
    const filterTeklifTipi = document.getElementById('filterTeklifTipi').value;
    const filterDurum = document.getElementById('filterDurum').value;
    const minDate = getMinDateFilter();
    
    const rows = document.querySelectorAll('#teklifTablosu tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const teklifNo = row.cells[2]?.textContent.toLowerCase();
        const firmaAdi = row.cells[3]?.textContent.toLowerCase();
        const teklifTipi = row.cells[4]?.textContent;
        const teklifTarihStr = row.cells[5]?.textContent.trim();
        const rowDate = parseTrDate(teklifTarihStr);
        const durum = row.cells[9]?.textContent;
        
        let showRow = true;
        
        if (filterTeklifNo && !(teklifNo || '').includes(filterTeklifNo)) showRow = false;
        if (filterFirma && !(firmaAdi || '').includes(filterFirma)) showRow = false;
        if (filterTeklifTipi && teklifTipi !== filterTeklifTipi) showRow = false;
        if (filterDurum && durum !== filterDurum) showRow = false;
        if (minDate) {
            // Sadece minDate veya sonrası kalsın
            if (!rowDate || rowDate < minDate) showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    console.log(`${visibleCount} teklif gösteriliyor`);
}

// Yeni Teklif butonuna tıklandığında
document.getElementById('btnYeniTeklif').addEventListener('click', function() {
    showYeniTeklifForm();
});

// Teklif formu submit edildiğinde
document.getElementById('teklifForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveAsama1();
});

function showYeniTeklifForm() {
    document.getElementById('teklifListesi').style.display = 'none';
    document.getElementById('yeniTeklifForm').style.display = 'block';
    
    // Formu temizle
    document.getElementById('teklifForm').reset();
    
    // Bugünün tarihini ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('teklifTarihi').value = today;
    
    // Otomatik teklif numarası al
    getNextTeklifNo();
}

function cancelTeklif() {
    // Rezerve edilmiş teklif numarasını serbest bırak
    releaseReservedTeklifNo();
    
    document.getElementById('yeniTeklifForm').style.display = 'none';
    document.getElementById('teklifListesi').style.display = 'block';
    
    // Düzenleme modunu sıfırla
    editingTeklifId = null;
    secilenParametreler = [];
    duzenleParametreler = [];
    
    // Başlığı geri al
    document.querySelector('#yeniTeklifForm h4').innerHTML = '<i class="fas fa-plus me-2"></i>Yeni Teklif';
}

// Rezerve edilmiş teklif numarası
let reservedTeklifNo = null;

function getNextTeklifNo() {
    // Basit sistem - rezervasyon yok, sadece numara al
    getNextTeklifNoOld();
}

function reserveTeklifNo() {
    fetch('/api/teklif/reserve_number')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                reservedTeklifNo = data.reserved_number;
                document.getElementById('teklifNo').value = reservedTeklifNo;
                console.log('Teklif numarası rezerve edildi:', reservedTeklifNo);
            } else {
                console.error('Teklif numarası rezerve edilemedi:', data.message);
                // Fallback olarak eski sistemi dene
                getNextTeklifNoOld();
            }
        })
        .catch(error => {
            console.error('Rezervasyon hatası:', error);
            // Fallback olarak eski sistemi dene
            getNextTeklifNoOld();
        });
}

function getNextTeklifNoOld() {
    fetch('/api/teklif/next_number')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('teklifNo').value = data.teklif_no;
            } else {
                console.error('Teklif numarası alınamadı:', data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
        });
}

function releaseReservedTeklifNo() {
    if (reservedTeklifNo) {
        fetch('/api/teklif/release_number', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                teklif_no: reservedTeklifNo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Rezerve teklif numarası serbest bırakıldı:', reservedTeklifNo);
            } else {
                console.error('Teklif numarası serbest bırakılamadı:', data.message);
            }
        })
        .catch(error => {
            console.error('Serbest bırakma hatası:', error);
        })
        .finally(() => {
            reservedTeklifNo = null;
        });
    }
}

function saveAsama1() {
    const formData = {
        teklif_tipi: document.getElementById('teklifTipi').value,
        firma_adi: document.getElementById('firmaAdi').value,
        teklif_tarihi: document.getElementById('teklifTarihi').value,
        teklif_no: document.getElementById('teklifNo').value,
        indirim_orani: '0', // 2. aşamada belirlenecek
        indirim_tipi: '%'
    };
    
    // Validasyon
    if (!formData.teklif_tipi || !formData.firma_adi || !formData.teklif_tarihi || !formData.teklif_no) {
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Lütfen tüm zorunlu alanları doldurun.'
        });
        return;
    }
    
    // Teklif verilerini sakla
    teklifVerileri = formData;
    
    // Düzenleme modunda mı kontrol et
    if (editingTeklifId) {
        // Düzenleme modunda - mevcut parametreleri koru
        secilenParametreler = [...duzenleParametreler];
    }
    
    // 2. aşamaya geç
    showAsama2();
}

function showAsama2() {
    document.getElementById('yeniTeklifForm').style.display = 'none';
    document.getElementById('teklifAsama2').style.display = 'block';
    
    // Başlığı güncelle
    if (editingTeklifId) {
        document.querySelector('#teklifAsama2 h5').innerHTML = '<i class="fas fa-list me-2"></i>Teklif Düzenle - 2. Aşama (Parametre Seçimi)';
    }
    
    // Parametre seçim tablosunu oluştur
    createParametreSecimTablosu();
    
    // Düzenleme modunda önceden seçili parametreleri işaretle
    if (editingTeklifId && secilenParametreler.length > 0) {
        setTimeout(() => {
            secilenParametreler.forEach(parametre => {
                const checkbox = document.querySelector(`.parametre-secim-checkbox[value="${parametre.parametre}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }, 100);
    }
}

function loadAsgariFiyatlar() {
    return Promise.all([
        fetch('/api/asgari_fiyatlar').then(r => r.json()),
        fetch('/api/asgari_fiyatlar/full').then(r => r.json()).catch(() => ({ success: false }))
    ])
        .then(([simple, full]) => {
            if (simple && simple.success) {
                asgariFiyatlar = simple.asgari_fiyatlar;
            } else {
                console.error('Asgari fiyatlar yüklenemedi:', simple ? simple.message : 'Bilinmeyen hata');
                throw new Error(simple ? simple.message : 'Asgari fiyatlar yüklenemedi');
            }
            if (full && full.success) {
                asgariFiyatlarFull = full.asgari_fiyatlar || [];
            } else {
                asgariFiyatlarFull = [];
            }
            return asgariFiyatlar;
        })
        .catch(error => {
            console.error('Hata:', error);
            throw error;
        });
}

function getTeklifYili() {
    try {
        const t = String(teklifVerileri?.teklif_tarihi || '').trim();
        const m = t.match(/^(\d{4})-/);
        if (m) return parseInt(m[1], 10);
    } catch (e) {}
    return new Date().getFullYear();
}

function getYillikDeger(item, yil) {
    try {
        const y = item?.yillik || {};
        const direct = y[String(yil)];
        if (direct !== undefined && direct !== null && direct !== '') return Number(direct) || 0;
        const keys = Object.keys(y);
        if (keys.length) {
            const latest = keys.sort()[keys.length - 1];
            return Number(y[latest]) || 0;
        }
    } catch (e) {}
    return 0;
}

function inferKapsamFromParametre(paramText) {
    const s = String(paramText || '').trim().toUpperCase();
    if (!s) return 'EMİSYON';
    if (s.includes('(E)') && s.includes('ANALİZ')) return 'İŞBİR';
    if (s.startsWith('(İ)')) return 'İMİSYON';
    if (s.startsWith('(E)')) return 'EMİSYON';
    return 'EMİSYON';
}

function createParametreSecimTablosu() {
    const tbody = document.getElementById('parametreSecimTablosu');
    tbody.innerHTML = '';
    
    asgariFiyatlar.forEach((parametre, index) => {
        const row = document.createElement('tr');
        const kapsamText = (parametre && parametre.kapsam) ? String(parametre.kapsam).toUpperCase().trim() : inferKapsamFromParametre(parametre ? parametre.parametre : '');
        row.innerHTML = `
            <td class="text-center">
                <input type="checkbox" class="form-check-input parametre-secim-checkbox" 
                       value="${parametre.parametre}" data-fiyat="${parametre.fiyat}" data-metot="${parametre.metot}">
            </td>
            <td class="text-center">${index + 1}</td>
            <td class="text-center">${kapsamText}</td>
            <td>${parametre.parametre}</td>
            <td>${parametre.metot}</td>
            <td class="text-end">${parametre.fiyat.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
        `;
        tbody.appendChild(row);
    });
}

function tumunuSec(checkbox) {
    const checkboxes = document.querySelectorAll('.parametre-secim-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

function secilenParametreleriEkle() {
    const secilenCheckboxes = document.querySelectorAll('.parametre-secim-checkbox:checked');
    
    // Validasyonu kaldırdık - hiçbir seçim yapmadan da geçebilir
    
    // Hangi modda olduğumuzu kontrol et
    const isDuzenlemeModu = editingTeklifId !== null;
    
    if (isDuzenlemeModu) {
        // Düzenleme modunda - secilenParametreler'e ekle
        secilenCheckboxes.forEach(checkbox => {
            const parametreAdi = checkbox.value;
            const birimFiyat = parseFloat(checkbox.dataset.fiyat);
            const metot = checkbox.dataset.metot;
            
            // Eğer zaten eklenmemişse ekle
            if (!secilenParametreler.find(p => p.parametre === parametreAdi)) {
                secilenParametreler.push({
                    parametre: parametreAdi,
                    metot: metot,
                    birimFiyat: birimFiyat,
                    adet: 1, // Varsayılan olarak 1 adet
                    topFiyat: birimFiyat
                });
            }
        });
        
        // Fiyat giriş sayfasına geç
        showFiyatGirisSayfasi();
    } else {
        // Yeni teklif modunda - secilenParametreler'e ekle
        secilenCheckboxes.forEach(checkbox => {
            const parametreAdi = checkbox.value;
            const birimFiyat = parseFloat(checkbox.dataset.fiyat);
            const metot = checkbox.dataset.metot;
            
            // Eğer zaten eklenmemişse ekle
            if (!secilenParametreler.find(p => p.parametre === parametreAdi)) {
                secilenParametreler.push({
                    parametre: parametreAdi,
                    metot: metot,
                    birimFiyat: birimFiyat,
                    adet: 1,
                    topFiyat: birimFiyat
                });
            }
        });
        
        // Fiyat giriş sayfasına geç
        showFiyatGirisSayfasi();
    }
}

function showFiyatGirisSayfasi() {
    document.getElementById('teklifAsama2').style.display = 'none';
    document.getElementById('teklifAsama2Fiyat').style.display = 'block';
    
    // Başlığı güncelle
    if (editingTeklifId) {
        document.querySelector('#teklifAsama2Fiyat h5').innerHTML = '<i class="fas fa-calculator me-2"></i>Teklif Düzenle - 2. Aşama (Fiyat Girişi)';
    }
    
    // Özet bilgileri güncelle
    document.getElementById('ozetTeklifNo').textContent = teklifVerileri.teklif_no;
    document.getElementById('ozetFirmaAdi').textContent = teklifVerileri.firma_adi;
    document.getElementById('ozetTeklifTipi').textContent = teklifVerileri.teklif_tipi;
    document.getElementById('ozetTeklifTarihi').textContent = teklifVerileri.teklif_tarihi;
    
    // Düzenleme modunda indirim oranını doldur
    if (editingTeklifId) {
        document.getElementById('indirimOrani').value = document.getElementById('duzenleIndirimOrani').value;
        document.getElementById('indirimTipi').value = document.getElementById('duzenleIndirimTipi').value;
    }
    
    // Seçilen parametreler tablosunu oluştur
    createSecilenParametrelerTablosu();
}

function isTeklifTutarHaricParametreAdi(parametreAdi) {
    const s = String(parametreAdi || '').toUpperCase();
    if (!s) return false;
    if (s.includes('TABAN FİYAT') || s.includes('TABAN FIYAT')) return true;
    if (s === 'YOL' || s.includes('YOL ' ) || s.includes(' YOL')) return true;
    return false;
}

function isRaporlamaUcretiSatiri(parametreAdi) {
    const s = String(parametreAdi || '').toUpperCase();
    return s.includes('RAPORLAMA');
}

function ensureRaporlamaUcretiSatiri() {
    if (!Array.isArray(secilenParametreler)) return;

    const yil = getTeklifYili();

    // Base totals by kapsam (exclude taban/yol and raporlama rows themselves)
    const baseTotals = secilenParametreler.reduce((acc, p) => {
        const adi = p?.parametre;
        if (isRaporlamaUcretiSatiri(adi)) return acc;
        if (isTeklifTutarHaricParametreAdi(adi)) return acc;
        const kapsam = (p && p.kapsam) ? String(p.kapsam).toUpperCase().trim() : inferKapsamFromParametre(adi);
        acc[kapsam] = (acc[kapsam] || 0) + (Number(p?.topFiyat) || 0);
        return acc;
    }, {});

    // Determine raporlama definitions from full list if available
    const rapItems = (Array.isArray(asgariFiyatlarFull) && asgariFiyatlarFull.length)
        ? asgariFiyatlarFull.filter(it => String(it?.parametre || '').toUpperCase().includes('RAPORLAMA'))
        : [];

    // If full list is not available, fallback to a single generic row (legacy behavior)
    if (!rapItems.length) {
        const olcumToplami = Object.values(baseTotals).reduce((s, v) => s + (Number(v) || 0), 0);
        const raporlama = Math.round((olcumToplami * 0.10) * 100) / 100;

        const idx = secilenParametreler.findIndex(p => String(p?.parametre || '').toUpperCase() === 'RAPORLAMA ÜCRETİ' || isRaporlamaUcretiSatiri(p?.parametre));
        const existing = idx >= 0 ? (secilenParametreler[idx] || {}) : {};
        const isManual = Boolean(existing && existing._manual);

        const satir = {
            parametre: existing.parametre || 'RAPORLAMA ÜCRETİ',
            metot: 'Taban fiyat ve yol ücreti hariç toplamın %10',
            adet: 1,
            _locked: true,
            _manual: isManual,
            _autoBirimFiyat: raporlama
        };
        if (!isManual) {
            satir.birimFiyat = raporlama;
            satir.topFiyat = raporlama;
        } else {
            const manualVal = Number(existing.birimFiyat);
            satir.birimFiyat = isNaN(manualVal) ? raporlama : manualVal;
            satir.topFiyat = satir.birimFiyat;
        }
        if (idx >= 0) secilenParametreler[idx] = { ...existing, ...satir };
        else secilenParametreler.push(satir);
        return;
    }

    // Keep a set of raporlama parametre names we manage (case-insensitive)
    const managedNames = new Set();
    rapItems.forEach(ri => managedNames.add(String(ri?.parametre || '').toUpperCase().trim()));

    // Remove stale auto raporlama rows for managed names when base total for its kapsam is zero
    secilenParametreler = secilenParametreler.filter(p => {
        const nameU = String(p?.parametre || '').toUpperCase().trim();
        if (!managedNames.has(nameU)) return true;
        const isManual = Boolean(p && p._manual);
        if (isManual) return true;
        const kapsam = (p && p.kapsam) ? String(p.kapsam).toUpperCase().trim() : inferKapsamFromParametre(p?.parametre);
        return (Number(baseTotals[kapsam] || 0) > 0);
    });

    // Upsert each raporlama item
    rapItems.forEach(ri => {
        const rapName = String(ri?.parametre || '').trim();
        const rapNameU = rapName.toUpperCase();
        const kapsam = (ri && ri.kapsam) ? String(ri.kapsam).toUpperCase().trim() : inferKapsamFromParametre(rapName);
        const baseSum = Number(baseTotals[kapsam] || 0);
        if (!(baseSum > 0)) return;

        const oran = Number(getYillikDeger(ri, yil) || 0);
        const raporlama = Math.round((baseSum * oran / 100) * 100) / 100;

        const idx = secilenParametreler.findIndex(p => String(p?.parametre || '').toUpperCase().trim() === rapNameU);
        const existing = idx >= 0 ? (secilenParametreler[idx] || {}) : {};
        const isManual = Boolean(existing && existing._manual);

        const satir = {
            parametre: rapName,
            metot: `Taban fiyat ve yol ücreti hariç toplamın %${oran}`,
            kapsam: kapsam,
            adet: 1,
            _locked: true,
            _manual: isManual,
            _autoBirimFiyat: raporlama
        };

        if (!isManual) {
            satir.birimFiyat = raporlama;
            satir.topFiyat = raporlama;
        } else {
            const manualVal = Number(existing.birimFiyat);
            satir.birimFiyat = isNaN(manualVal) ? raporlama : manualVal;
            satir.topFiyat = satir.birimFiyat;
        }

        if (idx >= 0) {
            secilenParametreler[idx] = { ...existing, ...satir };
        } else {
            secilenParametreler.push(satir);
        }
    });
}

function createSecilenParametrelerTablosu() {
    const tbody = document.getElementById('secilenParametrelerTablosu');
    tbody.innerHTML = '';

    ensureRaporlamaUcretiSatiri();
    
    secilenParametreler.forEach((parametre, index) => {
        const row = document.createElement('tr');
        const isRaporlama = Boolean(parametre && isRaporlamaUcretiSatiri(parametre.parametre));
        const locked = Boolean(parametre && parametre._locked && !isRaporlama);
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td>${parametre.parametre}</td>
            <td>${parametre.metot}</td>
            <td class="text-end">
                <input type="number" class="form-control form-control-sm" 
                       value="${parametre.birimFiyat || 0}" step="0.01" min="0"
                       onchange="birimFiyatDegisti(this, ${index})" ${locked ? 'disabled' : ''}>
            </td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm" 
                       value="${parametre.adet || 1}" min="1" step="1"
                       onchange="adetDegisti(this, ${index})" ${locked ? 'disabled' : ''}>
            </td>
            <td class="text-end">
                <span class="fw-bold text-success top-fiyat">${(parametre.topFiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> TL
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="parametreyiKaldir('${parametre.parametre}')" ${isRaporlama ? 'disabled' : ''}>
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Toplam fiyatları güncelle
    updateOzet();
}

function parametreyiKaldir(parametreAdi) {
    if (isRaporlamaUcretiSatiri(parametreAdi)) {
        return;
    }
    secilenParametreler = secilenParametreler.filter(p => p.parametre !== parametreAdi);
    createSecilenParametrelerTablosu();
}

function adetDegisti(input, index) {
    const adet = parseInt(input.value) || 1;
    const birimFiyat = secilenParametreler[index].birimFiyat || 0;
    
    secilenParametreler[index].adet = adet;
    secilenParametreler[index].topFiyat = birimFiyat * adet;
    
    // Toplam fiyatı güncelle
    const row = input.closest('tr');
    const topFiyatSpan = row.querySelector('.top-fiyat');
    topFiyatSpan.textContent = (birimFiyat * adet).toLocaleString('tr-TR', {minimumFractionDigits: 2});

    ensureRaporlamaUcretiSatiri();
    createSecilenParametrelerTablosu();
}

function birimFiyatDegisti(input, index) {
    const yeniFiyat = parseFloat(input.value) || 0;
    const adet = secilenParametreler[index].adet || 1;

    if (isRaporlamaUcretiSatiri(secilenParametreler[index].parametre)) {
        secilenParametreler[index]._manual = true;
    }
    
    secilenParametreler[index].birimFiyat = yeniFiyat;
    secilenParametreler[index].topFiyat = yeniFiyat * adet;
    
    // Toplam fiyatı güncelle
    const row = input.closest('tr');
    const topFiyatSpan = row.querySelector('.top-fiyat');
    topFiyatSpan.textContent = (yeniFiyat * adet).toLocaleString('tr-TR', {minimumFractionDigits: 2});

    ensureRaporlamaUcretiSatiri();
    createSecilenParametrelerTablosu();
}

function geriAsama1() {
    // Hangi modda olduğumuzu kontrol et
    const isDuzenlemeModu = editingTeklifId !== null;
    
    if (isDuzenlemeModu) {
        // Düzenleme modunda - 1. aşamaya geri dön
        if (document.getElementById('teklifAsama2Fiyat').style.display !== 'none') {
            // Fiyat giriş sayfasından parametre seçim sayfasına dön
            document.getElementById('teklifAsama2Fiyat').style.display = 'none';
            document.getElementById('teklifAsama2').style.display = 'block';
        } else {
            // Parametre seçim sayfasından 1. aşamaya dön
            document.getElementById('teklifAsama2').style.display = 'none';
            document.getElementById('yeniTeklifForm').style.display = 'block';
        }
    } else {
        // Yeni teklif modunda
        if (document.getElementById('teklifAsama2Fiyat').style.display !== 'none') {
            // Fiyat giriş sayfasından parametre seçim sayfasına dön
            document.getElementById('teklifAsama2Fiyat').style.display = 'none';
            document.getElementById('teklifAsama2').style.display = 'block';
        } else {
            // Parametre seçim sayfasından 1. aşamaya dön
            document.getElementById('teklifAsama2').style.display = 'none';
            document.getElementById('yeniTeklifForm').style.display = 'block';
        }
    }
}

// Manuel fiyat değiştirme fonksiyonları kaldırıldı - artık otomatik hesaplama kullanılıyor

function indirimUygula() {
    // İndirim oranını teklifVerileri'ne kaydet
    teklifVerileri.indirim_orani = document.getElementById('indirimOrani').value;
    teklifVerileri.indirim_tipi = document.getElementById('indirimTipi').value;
    
    // Özeti güncelle
    updateOzet();
    
    // Başarı mesajı göster
    Swal.fire({
        icon: 'success',
        title: 'Başarılı!',
        text: 'İndirim uygulandı ve fiyat özeti güncellendi.',
        timer: 1500,
        showConfirmButton: false
    });
}

// Baca bilgilerini okuyup otomatik parametre seçimi yapan fonksiyon
async function bacaBilgileriniOkuVeParametreSec() {
    try {
        // Firma adını al
        const firmaAdi = document.getElementById('firmaAdi').value;
        if (!firmaAdi) {
            alert('Lütfen firma adını girin!');
            return;
        }
        
        // Baca bilgilerini API'den al
        const response = await fetch(`/api/baca-bilgileri/${encodeURIComponent(firmaAdi)}`);
        const data = await response.json();
        
        if (data.success && data.bacalar.length > 0) {
            // Her baca için parametreleri topla
            const tumParametreler = new Set();
            
            data.bacalar.forEach(baca => {
                if (baca.parametreler && Array.isArray(baca.parametreler)) {
                    baca.parametreler.forEach(parametre => {
                        tumParametreler.add(parametre);
                    });
                }
            });
            
            // Seçilen parametreleri checkbox'lara işaretle
            const checkboxes = document.querySelectorAll('.parametre-secim-checkbox');
            checkboxes.forEach(checkbox => {
                if (tumParametreler.has(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            // Başarı mesajı
            Swal.fire({
                icon: 'success',
                title: 'Parametreler Otomatik Seçildi!',
                text: `${tumParametreler.size} farklı parametre bulundu ve seçildi.`,
                timer: 3000
            });
            
        } else {
            Swal.fire({
                icon: 'info',
                title: 'Bilgi',
                text: 'Bu firma için baca bilgisi bulunamadı. Manuel parametre seçimi yapabilirsiniz.'
            });
        }
        
    } catch (error) {
        console.error('Baca bilgileri okuma hatası:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Baca bilgileri okunurken bir hata oluştu.'
        });
    }
}

// Otomatik fiyat hesaplama fonksiyonu
async function otomatikFiyatHesapla() {
    try {
        // Seçilen parametreleri hazırla
        const secilenParametreler = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => ({
            parametre: checkbox.value,
            metot: checkbox.dataset.metot || '',
            adet: 1 // Varsayılan olarak 1 adet
        }));
        
        if (secilenParametreler.length === 0) {
            alert('Lütfen en az bir parametre seçin!');
            return;
        }
        
        // API'ye gönder
        const response = await fetch('/api/otomatik-fiyat-hesapla', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                parametreler: secilenParametreler,
                yil: getTeklifYili()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Hesaplanan fiyatları secilenParametreler dizisine aktar
            secilenParametreler.length = 0; // Diziyi temizle
            secilenParametreler.push(...data.parametreler);

            ensureRaporlamaUcretiSatiri();
            
            // Tabloyu güncelle
            createSecilenParametrelerTablosu();
            updateOzet();
            
            // Başarı mesajı
            Swal.fire({
                icon: 'success',
                title: 'Otomatik Fiyat Hesaplandı!',
                text: data.message,
                timer: 3000
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: data.message
            });
        }
        
    } catch (error) {
        console.error('Otomatik fiyat hesaplama hatası:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Fiyat hesaplanırken bir hata oluştu.'
        });
    }
}

function updateOzet() {
    ensureRaporlamaUcretiSatiri();
    // Toplam hesapla
    const toplam = secilenParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
    
    // İndirim hesapla
    let indirim = 0;
    if (teklifVerileri.indirim_orani && teklifVerileri.indirim_tipi) {
        if (teklifVerileri.indirim_tipi === 'TL') {
            indirim = parseFloat(teklifVerileri.indirim_orani) || 0;
        } else if (teklifVerileri.indirim_tipi === '%') {
            indirim = toplam * (parseFloat(teklifVerileri.indirim_orani) / 100) || 0;
        }
    }
    
    // Net toplam
    const netToplam = toplam - indirim;
    
    // Özet güncelle
    document.getElementById('ozetToplam').textContent = toplam.toFixed(2) + ' TL';
    document.getElementById('ozetIndirim').textContent = indirim.toFixed(2) + ' TL';
    document.getElementById('ozetNetToplam').textContent = netToplam.toFixed(2) + ' TL';
}

function geriAsama1() {
    document.getElementById('teklifAsama2').style.display = 'none';
    document.getElementById('yeniTeklifForm').style.display = 'block';
}

 function teklifiKaydet() {
     // Hangi modda olduğumuzu kontrol et
     const isDuzenlemeModu = editingTeklifId !== null;
     
     if (isDuzenlemeModu) {
         // Düzenleme modunda - güncelle
         const toplam = secilenParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
         
         // İndirim hesapla
         let indirim = 0;
         if (teklifVerileri.indirim_orani && teklifVerileri.indirim_tipi) {
             if (teklifVerileri.indirim_tipi === 'TL') {
                 indirim = parseFloat(teklifVerileri.indirim_orani) || 0;
             } else if (teklifVerileri.indirim_tipi === '%') {
                 indirim = toplam * (parseFloat(teklifVerileri.indirim_orani) / 100) || 0;
             }
         }
         
         const netToplam = toplam - indirim;
         
         const tamTeklif = {
             id: editingTeklifId,
             ...teklifVerileri,
             parametreler: secilenParametreler,
             toplam: toplam,
             indirim: indirim,
             netToplam: netToplam,
             teklif_durumu: 'BEKLEMEDE'
         };
         
         console.log('Güncellenecek teklif:', tamTeklif);
         
         // API'ye gönder
         fetch('/api/teklif/update', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify(tamTeklif)
         })
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 Swal.fire({
                     icon: 'success',
                     title: 'Başarılı!',
                     text: 'Teklif başarıyla güncellendi.'
                 }).then(() => {
                     location.reload();
                 });
             } else {
                 Swal.fire({
                     icon: 'error',
                     title: 'Hata!',
                     text: data.message
                 });
             }
         })
         .catch(error => {
             console.error('Hata:', error);
             Swal.fire({
                 icon: 'error',
                 title: 'Hata!',
                 text: 'Teklif güncellenirken bir hata oluştu.'
             });
         });
     } else {
         // Yeni teklif modunda - ekle
         const toplam = secilenParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
         
         // İndirim hesapla
         let indirim = 0;
         if (teklifVerileri.indirim_orani && teklifVerileri.indirim_tipi) {
             if (teklifVerileri.indirim_tipi === 'TL') {
                 indirim = parseFloat(teklifVerileri.indirim_orani) || 0;
             } else if (teklifVerileri.indirim_tipi === '%') {
                 indirim = toplam * (parseFloat(teklifVerileri.indirim_orani) / 100) || 0;
             }
         }
         
         const netToplam = toplam - indirim;
         
         const tamTeklif = {
             ...teklifVerileri,
             parametreler: secilenParametreler,
             toplam: toplam,
             indirim: indirim,
             netToplam: netToplam,
             teklif_durumu: 'BEKLEMEDE'
         };
         
         console.log('Yeni teklif:', tamTeklif);
         
         // API'ye gönder
         fetch('/api/teklif/add', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify(tamTeklif)
         })
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 Swal.fire({
                     icon: 'success',
                     title: 'Başarılı!',
                     text: 'Teklif başarıyla kaydedildi.'
                 }).then(() => {
                     location.reload();
                 });
             } else {
                 Swal.fire({
                     icon: 'error',
                     title: 'Hata!',
                     text: data.message
                 });
             }
         })
         .catch(error => {
             console.error('Hata:', error);
             Swal.fire({
                 icon: 'error',
                 title: 'Hata!',
                 text: 'Teklif kaydedilirken bir hata oluştu.'
             });
         });
     }
 }

function teklifiYazdir(teklifId) {
     // Teklif ID yoksa düzenleme modundaki ID'yi kullan
     if (!teklifId && editingTeklifId) {
         teklifId = editingTeklifId;
     }
 
     // Hâlâ teklif ID yoksa önce kaydetmesi gerekir
     if (!teklifId) {
         Swal.fire({
             icon: 'warning',
             title: 'Teklif Kaydedilmedi',
             text: 'Yazdırmadan önce teklifi kaydetmelisiniz.'
         });
         return;
     }
 
     // Format seçim modalını göster
     Swal.fire({
         title: 'Yazdırma Formatı Seçin',
         html: `
             <div class="text-center">
                 <div class="mb-3">
                     <button class="btn btn-primary btn-lg" onclick="yazdirFormatSec('word', '${teklifId}')">
                         <i class="fas fa-file-word me-2"></i>Word (.docx)
                     </button>
                 </div>
                 <div class="mb-3">
                     <button class="btn btn-danger btn-lg" onclick="yazdirFormatSec('pdf', '${teklifId}')">
                         <i class="fas fa-file-pdf me-2"></i>PDF (.pdf)
                     </button>
                 </div>
             </div>
         `,
         showConfirmButton: false,
         showCloseButton: true,
         width: '500px'
     });
 }

function yazdirFormatSec(format, teklifId) {
    // Modal'ı kapat
    Swal.close();
    
    // Loading göster
    Swal.fire({
        title: 'Dosya oluşturuluyor...',
        text: 'Lütfen bekleyin',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // API'ye istek gönder
    fetch(`/api/teklif/yazdir/${teklifId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            format: format
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Dosya oluşturma hatası');
        }
        
        // Dosya adını response header'dan al
        let filename = '';
        
        const contentDisposition = response.headers.get('Content-Disposition');
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // Eğer header'dan alamadıysak, backend'den gelen dosya adını kullan
        if (!filename) {
            // Backend'den teklif bilgilerini al ve dosya adını oluştur
            return fetch(`/api/teklif/detail/${teklifId}`)
                .then(detailResponse => detailResponse.json())
                .then(detailData => {
                    if (detailData.success) {
                        const teklif = detailData.teklif;
                        const firma = detailData.firma;
                        
                        // Backend'deki aynı dosya adı oluşturma mantığını kullan
                        let firma_adi = firma ? firma.firmaAdi || '' : '';
                        if (!firma_adi) {
                            // Eğer firma objesinden alamazsak, teklif verisinden al
                            firma_adi = teklif.firma_adi || '';
                        }
                        
                        // Firma adını temizle ve ilk 2 kelimeyi al
                        const firma_adi_temiz = firma_adi.trim();
                        console.log('DEBUG - Firma adı:', firma_adi);
                        console.log('DEBUG - Firma adı temiz:', firma_adi_temiz);
                        
                        const firma_kelimeler = firma_adi_temiz.split(/\s+/).slice(0, 2);
                        console.log('DEBUG - Firma kelimeler:', firma_kelimeler);
                        
                        const firma_kisa = firma_kelimeler.length > 0 ? firma_kelimeler.join('_') : 'Firma';
                        console.log('DEBUG - Firma kısa:', firma_kisa);
                        
                        const teklif_tarihi = teklif.teklif_tarihi || '';
                        let tarih_format = '';
                        if (teklif_tarihi) {
                            try {
                                const tarih_obj = new Date(teklif_tarihi);
                                const gun = tarih_obj.getDate().toString().padStart(2, '0');
                                const ay = (tarih_obj.getMonth() + 1).toString().padStart(2, '0');
                                const yil = tarih_obj.getFullYear().toString().slice(-2);
                                tarih_format = gun + ay + yil;
                            } catch {
                                const now = new Date();
                                tarih_format = now.getDate().toString().padStart(2, '0') + 
                                             (now.getMonth() + 1).toString().padStart(2, '0') + 
                                             now.getFullYear().toString().slice(-2);
                            }
                        } else {
                            const now = new Date();
                            tarih_format = now.getDate().toString().padStart(2, '0') + 
                                         (now.getMonth() + 1).toString().padStart(2, '0') + 
                                         now.getFullYear().toString().slice(-2);
                        }
                        
                        const tutar_kdv_haric = teklif.netToplam || 0;
                        filename = `${firma_kisa}_${teklif.teklif_no || ''}_${tarih_format}_${Math.round(tutar_kdv_haric)}TL.${format === 'pdf' ? 'pdf' : 'docx'}`;
                    } else {
                        // Fallback
                        filename = `teklif_${teklifId}_${new Date().toISOString().slice(0,10)}.${format === 'pdf' ? 'pdf' : 'docx'}`;
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                });
        }
        
        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        // Dosyayı indir
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        Swal.fire({
            icon: 'success',
            title: 'Başarılı!',
            text: format.toUpperCase() + ' dosyası başarıyla indirildi.'
        });
    })
    .catch(error => {
        console.error('Yazdırma hatası:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Dosya oluşturulurken bir hata oluştu: ' + error.message
        });
    });
}

 function showTeklifDetail(teklifId) {
     // Teklif detayını API'den al
     fetch(`/api/teklif/detail/${teklifId}`)
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 const teklif = data.teklif;
                 
                 // Modal içeriğini oluştur
                 const detayHTML = `
                     <div class="row">
                         <div class="col-md-6">
                             <div class="card">
                                 <div class="card-header bg-info text-white">
                                     <h6 class="mb-0">Teklif Bilgileri</h6>
                                 </div>
                                 <div class="card-body">
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Teklif No:</strong></div>
                                         <div class="col-6">${teklif.teklif_no}</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Firma:</strong></div>
                                         <div class="col-6">${teklif.firma_adi}</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Teklif Tipi:</strong></div>
                                         <div class="col-6">${teklif.teklif_tipi}</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Tarih:</strong></div>
                                         <div class="col-6">${teklif.teklif_tarihi}</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>İndirim:</strong></div>
                                         <div class="col-6">${teklif.indirim_orani || 0} ${teklif.indirim_tipi || 'TL'}</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Durum:</strong></div>
                                         <div class="col-6">
                                             <span class="badge bg-${getBadgeColor(teklif.teklif_durumu || 'BEKLEMEDE')}">
${teklif.teklif_durumu || 'BEKLEMEDE'}
                                             </span>
                                         </div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Durum Tarihi:</strong></div>
                                         <div class="col-6">${teklif.durum_tarihi || '-'}</div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         <div class="col-md-6">
                             <div class="card">
                                 <div class="card-header bg-success text-white">
                                     <h6 class="mb-0">Fiyat Özeti</h6>
                                 </div>
                                 <div class="card-body">
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Toplam:</strong></div>
                                         <div class="col-6">${(teklif.toplam || 0).toFixed(2)} TL</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>İndirim:</strong></div>
                                         <div class="col-6">${(teklif.indirim || 0).toFixed(2)} TL</div>
                                     </div>
                                     <div class="row mb-2">
                                         <div class="col-6"><strong>Net Toplam:</strong></div>
                                         <div class="col-6 h5 text-success">${(teklif.netToplam || 0).toFixed(2)} TL</div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <div class="row mt-3">
                         <div class="col-12">
                             <div class="card">
                                 <div class="card-header bg-primary text-white">
                                     <h6 class="mb-0">Parametreler (${(teklif.parametreler || []).length} adet)</h6>
                                 </div>
                                 <div class="card-body">
                                     ${(teklif.parametreler || []).length > 0 ? `
                                         <div class="table-responsive">
                                             <table class="table table-striped">
                                                 <thead class="table-dark">
                                                     <tr>
                                                         <th>SIRA</th>
                                                         <th>PARAMETRE ADI</th>
                                                         <th>METOT</th>
                                                         <th>BİRİM FİYAT (TL)</th>
                                                         <th>ADET</th>
                                                         <th class="text-end">TOP.FİYAT (TL)</th>
                                                     </tr>
                                                 </thead>
                                                 <tbody>
                                                     ${(teklif.parametreler || []).map((param, index) => `
                                                         <tr>
                                                             <td>${index + 1}</td>
                                                             <td>${param.parametre || 'N/A'}</td>
                                                             <td>${param.metot || 'N/A'}</td>
                                                             <td>${(param.birimFiyat || 0).toFixed(2)}</td>
                                                             <td>${param.adet || 0}</td>
                                                             <td class="text-end">${(param.topFiyat || 0).toFixed(2)}</td>
                                                         </tr>
                                                     `).join('')}
                                                 </tbody>
                                             </table>
                                         </div>
                                     ` : `
                                         <div class="alert alert-info">
                                             <i class="fas fa-info-circle me-2"></i>
                                             Bu teklif için henüz parametre eklenmemiş.
                                         </div>
                                     `}
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 document.getElementById('teklifDetayIcerik').innerHTML = detayHTML;
                 
                 // Modal'ı aç
                 const modal = new bootstrap.Modal(document.getElementById('teklifDetayModal'));
                 modal.show();
             } else {
                 Swal.fire({
                     icon: 'error',
                     title: 'Hata!',
                     text: data.message
                 });
             }
         })
         .catch(error => {
             console.error('Hata:', error);
             Swal.fire({
                 icon: 'error',
                 title: 'Hata!',
                 text: 'Teklif detayı yüklenirken bir hata oluştu.'
             });
         });
 }

function editTeklif(teklifId) {
    // Teklif verilerini al ve düzenleme modalını aç
    fetch(`/api/teklif/detail/${teklifId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const teklif = data.teklif;
                
                // Modal alanlarını doldur
                document.getElementById('duzenleTeklifId').value = teklif.id;
                document.getElementById('duzenleTeklifTipi').value = teklif.teklif_tipi;
                document.getElementById('duzenleFirmaAdi').value = teklif.firma_adi;
                document.getElementById('duzenleTeklifTarihi').value = teklif.teklif_tarihi;
                document.getElementById('duzenleTeklifNo').value = teklif.teklif_no;
                document.getElementById('duzenleIndirimOrani').value = teklif.indirim_orani || '';
                document.getElementById('duzenleIndirimTipi').value = teklif.indirim_tipi || 'TL';
                
                                 // Parametreleri yükle
                 duzenleParametreler = teklif.parametreler || [];
                 createDuzenleParametrelerTablosu();
                 updateDuzenleOzet();
                 
                 // İndirim oranı değişikliklerini dinle
                 document.getElementById('duzenleIndirimOrani').addEventListener('input', updateDuzenleOzet);
                 document.getElementById('duzenleIndirimTipi').addEventListener('change', updateDuzenleOzet);
                
                // Modal'ı aç
                const modal = new bootstrap.Modal(document.getElementById('teklifDuzenleModal'));
                modal.show();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Teklif bilgileri yüklenirken bir hata oluştu.'
            });
        });
}

function deleteTeklif(teklifId) {
    Swal.fire({
        title: 'Emin misiniz?',
        text: "Bu teklifi silmek istediğinizden emin misiniz?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Evet, sil!',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            // API'ye silme isteği gönder
            fetch('/api/teklif/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    teklif_id: teklifId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'Teklif başarıyla silindi.'
                    }).then(() => {
                        // Sayfayı yenile
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Teklif silinirken bir hata oluştu.'
                });
            });
        }
    });
}

function deleteSelectedTeklifler() {
    const checkboxes = document.querySelectorAll('.teklif-secim-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);

    if (selectedIds.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Uyarı!',
            text: 'Lütfen silmek istediğiniz teklifleri seçin.'
        });
        return;
    }

    Swal.fire({
        title: 'Seçilenleri Sil',
        text: `${selectedIds.length} teklif silinecek. Emin misiniz?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Evet, sil!',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (!result.isConfirmed) {
            return;
        }

        Swal.fire({
            title: 'Siliniyor...',
            text: 'Seçilen teklifler siliniyor...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/api/teklif/delete_bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                teklif_ids: selectedIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: data.message || 'Seçilen teklifler silindi.'
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: data.message || 'Seçilen teklifler silinirken hata oluştu.'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Seçilen teklifler silinirken bir hata oluştu.'
            });
        });
    });
}

function exportTeklifler() {
    // Ekranda görünen (filtrelenmiş) teklifleri al
    const visibleRows = Array.from(document.querySelectorAll('#teklifTablosu tr'))
        .filter(row => row.style.display !== 'none');
    const visibleIds = visibleRows
        .map(row => row.getAttribute('data-teklif-id'))
        .filter(Boolean);
    
    if (visibleIds.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Uyarı!',
            text: 'Dışa aktarılacak görünür teklif bulunamadı.'
        });
        return;
    }
    
    // Kullanıcıya onay sor
    Swal.fire({
        title: 'Teklifleri Dışa Aktar',
        text: `${visibleIds.length} teklif Excel (XLSX) olarak dışa aktarılacak. Devam etmek istiyor musunuz?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Evet, Dışa Aktar',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            exportVisibleTeklifler(visibleIds);
        }
    });
}

function exportVisibleTeklifler(teklifIds) {
    // Loading göster
    Swal.fire({
        title: 'Dışa Aktarılıyor...',
        text: 'Teklifler Excel (XLSX) formatında hazırlanıyor...',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/api/teklif/export_excel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            teklif_ids: teklifIds
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Export hatası');
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'teklif_listesi.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        Swal.fire({
            icon: 'success',
            title: 'Başarılı!',
            text: 'Görünen teklifler Excel (XLSX) olarak indirildi.'
        });
    })
    .catch(error => {
        console.error('Export hatası:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Teklif dışa aktarılırken bir hata oluştu.'
        });
    });
}

function importTeklifler() {
    // İçe aktarma fonksiyonu
    console.log('Teklifler içe aktarılacak');
}

// Parametre Yönetimi Fonksiyonları
function showParametreYonetimi() {
    // Önce asgari fiyatları yükle, sonra modal'ı aç
    fetch('/api/asgari_fiyatlar')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                asgariFiyatlar = data.asgari_fiyatlar;
                console.log('Parametre yönetimi için asgari fiyatlar yüklendi:', asgariFiyatlar);
                
                // Modal'ı aç
                const modal = new bootstrap.Modal(document.getElementById('parametreYonetimiModal'));
                modal.show();
                
                // Parametre tablosunu doldur
                createParametreYonetimiTablosu();
            } else {
                console.error('Asgari fiyatlar yüklenemedi:', data.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Parametreler yüklenirken hata oluştu.'
                });
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Parametreler yüklenirken hata oluştu.'
            });
        });
}

function createParametreYonetimiTablosu() {
    const tbody = document.getElementById('parametreYonetimiTablosu');
    if (!tbody) {
        console.error('Parametre yönetimi tablosu bulunamadı!');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!asgariFiyatlar || asgariFiyatlar.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <br>Henüz parametre bulunmuyor
                </td>
            </tr>
        `;
        return;
    }
    
    asgariFiyatlar.forEach((parametre, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td>${parametre.parametre || 'N/A'}</td>
            <td>${parametre.metot || 'N/A'}</td>
            <td class="text-end">${(parametre.fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="parametreyiSil('${parametre.parametre}')" 
                        ${parametre.parametre === 'TABAN FİYAT' || parametre.parametre === 'YOL' ? 'disabled' : ''}>
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    console.log(`${asgariFiyatlar.length} parametre tabloya eklendi`);
}

function parametreyiSil(parametreAdi) {
    Swal.fire({
        title: 'Parametre Sil',
        text: `"${parametreAdi}" parametresini silmek istediğinizden emin misiniz?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Evet, sil!',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/api/asgari_fiyatlar/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    parametre: parametreAdi
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'Parametre başarıyla silindi.'
                    }).then(() => {
                        // Asgari fiyatları yeniden yükle
                        loadAsgariFiyatlar();
                        
                        // Tabloyu güncelle
                        createParametreYonetimiTablosu();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Parametre silinirken bir hata oluştu.'
                });
            });
        }
    });
}

// Yeni parametre ekleme formu
document.addEventListener('DOMContentLoaded', function() {
    const yeniParametreForm = document.getElementById('yeniParametreForm');
    if (yeniParametreForm) {
        yeniParametreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            yeniParametreEkle();
        });
    }
});

function yeniParametreEkle() {
    const parametreAdi = document.getElementById('yeniParametreAdi').value.trim();
    const metot = document.getElementById('yeniParametreMetot').value.trim();
    const fiyat = parseFloat(document.getElementById('yeniParametreFiyat').value) || 0;
    
    if (!parametreAdi) {
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Parametre adı gerekli.'
        });
        return;
    }
    
    // API'ye gönder
    fetch('/api/asgari_fiyatlar/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            parametre: parametreAdi,
            metot: metot,
            fiyat: fiyat
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: 'Parametre başarıyla eklendi.'
            }).then(() => {
                // Formu temizle
                document.getElementById('yeniParametreForm').reset();
                
                // Asgari fiyatları yeniden yükle
                loadAsgariFiyatlar();
                
                // Tabloyu güncelle
                createParametreYonetimiTablosu();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Parametre eklenirken bir hata oluştu.'
        });
    });
}

 function parametreyiSil(parametreAdi) {
     Swal.fire({
         title: 'Emin misiniz?',
         text: `"${parametreAdi}" parametresini silmek istediğinizden emin misiniz?`,
         icon: 'warning',
         showCancelButton: true,
         confirmButtonColor: '#d33',
         cancelButtonColor: '#3085d6',
         confirmButtonText: 'Evet, sil!',
         cancelButtonText: 'İptal'
     }).then((result) => {
         if (result.isConfirmed) {
             // API'ye gönder
             fetch('/api/asgari_fiyatlar/delete', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                 },
                 body: JSON.stringify({
                     parametre: parametreAdi
                 })
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     Swal.fire({
                         icon: 'success',
                         title: 'Başarılı!',
                         text: 'Parametre başarıyla silindi.'
                     }).then(() => {
                         // Asgari fiyatları yeniden yükle
                         loadAsgariFiyatlar();
                         
                         // Tabloyu güncelle
                         createParametreYonetimiTablosu();
                     });
                 } else {
                     Swal.fire({
                         icon: 'error',
                         title: 'Hata!',
                         text: data.message
                     });
                 }
             })
             .catch(error => {
                 console.error('Hata:', error);
                 Swal.fire({
                     icon: 'error',
                     title: 'Hata!',
                     text: 'Parametre silinirken bir hata oluştu.'
                 });
             });
         }
     });
 }

// Teklif Listesi Filtreleme Fonksiyonları
function tumunuSecTeklif(checkbox) {
    const checkboxes = document.querySelectorAll('.teklif-secim-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

 function filterTeklifler() {
     const teklifNo = document.getElementById('filterTeklifNo').value.toLowerCase();
     const firma = document.getElementById('filterFirma').value.toLowerCase();
     const teklifTipi = document.getElementById('filterTeklifTipi').value;
     const durum = document.getElementById('filterDurum').value;
     const minDate = getMinDateFilter();
     
     const rows = document.querySelectorAll('#teklifTablosu tr');
     
     rows.forEach((row, index) => {
         const teklifNoCell = row.cells[2].textContent.toLowerCase();
         const firmaCell = row.cells[3].textContent.toLowerCase();
         const teklifTipiCell = row.cells[4].textContent;
         const tarihCell = row.cells[5].textContent.trim();
         const rowDate = parseTrDate(tarihCell);
         const durumSelect = row.cells[9].querySelector('select');
         const durumCell = durumSelect ? durumSelect.value : row.cells[9].textContent.trim();
         
         const teklifNoMatch = teklifNo === '' || teklifNoCell.includes(teklifNo);
         const firmaMatch = firma === '' || firmaCell.includes(firma);
         const teklifTipiMatch = teklifTipi === '' || teklifTipiCell === teklifTipi;
         const durumMatch = durum === '' || durumCell === durum;
         const tarihMatch = !minDate || (rowDate && rowDate >= minDate);
         
         if (teklifNoMatch && firmaMatch && teklifTipiMatch && durumMatch && tarihMatch) {
             row.style.display = '';
             // Sıra numarasını güncelle
             row.cells[1].textContent = index + 1;
         } else {
             row.style.display = 'none';
         }
     });
     
     // Filtreleme sonrası sıra numaralarını yeniden düzenle
     let visibleIndex = 1;
     rows.forEach(row => {
         if (row.style.display !== 'none') {
             row.cells[1].textContent = visibleIndex++;
         }
     });
 }

 // Badge renklerini belirleyen fonksiyon
function getBadgeColor(durum) {
    switch(durum) {
        case 'BEKLEMEDE':
            return 'warning';
        case 'KABUL':
            return 'success';
        case 'RED':
            return 'danger';
        default:
            return 'secondary';
    }
}

// Durum tarihini güncelleyen fonksiyon
function updateDurumTarihi(teklifId, yeniTarih) {
    Swal.fire({
        title: 'Tarih Güncelle',
        text: `Durum tarihini "${yeniTarih}" olarak değiştirmek istediğinizden emin misiniz?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Evet, güncelle!',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/api/teklif/update_durum_tarihi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    teklif_id: teklifId,
                    durum_tarihi: yeniTarih
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'Durum tarihi başarıyla güncellendi.'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Durum tarihi güncellenirken bir hata oluştu.'
                });
            });
        }
    });
}

function updateTeklifDurum(teklifId, yeniDurum) {
    Swal.fire({
        title: 'Durum Güncelle',
        text: `Teklif durumunu "${yeniDurum}" olarak değiştirmek istediğinizden emin misiniz?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Evet, güncelle!',
        cancelButtonText: 'İptal'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/api/teklif/update_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    teklif_id: teklifId,
                    teklif_durumu: yeniDurum,
                    durum_tarihi: new Date().toISOString().split('T')[0]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'Teklif durumu başarıyla güncellendi.'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: data.message
                    });
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: 'Teklif durumu güncellenirken bir hata oluştu.'
                });
            });
        }
    });
}

// Teklif Düzenleme Fonksiyonları
function createDuzenleParametrelerTablosu() {
    const tbody = document.getElementById('duzenleParametrelerTablosu');
    tbody.innerHTML = '';
    
    duzenleParametreler.forEach((parametre, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td>${parametre.parametre}</td>
            <td>${parametre.metot}</td>
            <td>
                <input type="number" class="form-control form-control-sm duzenle-birim-fiyat" 
                       value="${parametre.birimFiyat}" step="0.01" min="0"
                       onchange="duzenleBirimFiyatDegisti(this, ${index})">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm duzenle-adet-input" 
                       value="${parametre.adet}" min="0" step="1"
                       onchange="duzenleAdetDegisti(this, ${index})">
            </td>
            <td class="text-end">
                <span class="duzenle-top-fiyat">${parametre.topFiyat.toFixed(2)}</span> TL
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" 
                        onclick="duzenleParametreyiKaldir(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function duzenleBirimFiyatDegisti(input, index) {
    const yeniFiyat = parseFloat(input.value) || 0;
    const adet = duzenleParametreler[index].adet || 0;
    
    duzenleParametreler[index].birimFiyat = yeniFiyat;
    duzenleParametreler[index].topFiyat = yeniFiyat * adet;
    
    // Tablodaki toplam fiyatı güncelle
    const row = input.closest('tr');
    const topFiyatSpan = row.querySelector('.duzenle-top-fiyat');
    topFiyatSpan.textContent = (yeniFiyat * adet).toFixed(2);
    
    updateDuzenleOzet();
}

function duzenleAdetDegisti(input, index) {
    const adet = parseInt(input.value) || 0;
    const birimFiyat = duzenleParametreler[index].birimFiyat || 0;
    
    duzenleParametreler[index].adet = adet;
    duzenleParametreler[index].topFiyat = birimFiyat * adet;
    
    // Tablodaki toplam fiyatı güncelle
    const row = input.closest('tr');
    const topFiyatSpan = row.querySelector('.duzenle-top-fiyat');
    topFiyatSpan.textContent = (birimFiyat * adet).toFixed(2);
    
    updateDuzenleOzet();
}

function duzenleParametreyiKaldir(index) {
    duzenleParametreler.splice(index, 1);
    createDuzenleParametrelerTablosu();
    updateDuzenleOzet();
}

function duzenleParametreEkle() {
    // Teklif düzenleme modalını kapat ve 1. aşamaya geç
    const modal = bootstrap.Modal.getInstance(document.getElementById('teklifDuzenleModal'));
    modal.hide();
    
    // 1. aşamayı göster ve mevcut verileri doldur
    showDuzenleAsama1();
}

function showDuzenleAsama1() {
    // Teklif listesini gizle
    document.getElementById('teklifListesi').style.display = 'none';
    
    // Yeni teklif formunu göster
    document.getElementById('yeniTeklifForm').style.display = 'block';
    
    // Mevcut teklif verilerini forma doldur
    document.getElementById('teklifTipi').value = document.getElementById('duzenleTeklifTipi').value;
    document.getElementById('firmaAdi').value = document.getElementById('duzenleFirmaAdi').value;
    document.getElementById('teklifTarihi').value = document.getElementById('duzenleTeklifTarihi').value;
    document.getElementById('teklifNo').value = document.getElementById('duzenleTeklifNo').value;
    // İndirim oranı 2. aşamada doldurulacak
    
    // Düzenleme modunda olduğumuzu işaretle
    editingTeklifId = document.getElementById('duzenleTeklifId').value;
    
    // Seçilen parametreleri düzenleme parametrelerine kopyala
    secilenParametreler = [...duzenleParametreler];
    
    // Başlığı güncelle
    document.querySelector('#yeniTeklifForm h4').innerHTML = '<i class="fas fa-edit me-2"></i>Teklif Düzenle - 1. Aşama';
}

function showDuzenleParametreSecimAsamasi() {
    // duzenleParametreler'i sıfırla
    duzenleParametreler = [];
    
    // Önce parametreleri yükle, sonra 2. aşamayı göster
    loadAsgariFiyatlar()
        .then(() => {
            // Teklif düzenleme modalını gizle
            const modal = bootstrap.Modal.getInstance(document.getElementById('teklifDuzenleModal'));
            modal.hide();
            
            // 2. aşamayı göster
            document.getElementById('teklifAsama2').style.display = 'block';
            
            // Parametre tablosunu doldur
            createParametreSecimTablosu();
            
            // Arama fonksiyonunu ekle
            const aramaInput = document.getElementById('parametreArama');
            if (aramaInput) {
                aramaInput.addEventListener('input', function() {
                    filterParametreSecim(this.value);
                });
            }
        })
        .catch(error => {
            console.error('Parametreler yüklenirken hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Parametreler yüklenirken hata oluştu.'
            });
        });
}

function showParametreSecimModal() {
    // duzenleParametreler'i sıfırla
    duzenleParametreler = [];
    
    // Önce parametreleri yükle, sonra modal'ı aç
    loadAsgariFiyatlar()
        .then(() => {
            // Parametre seçim modalını oluştur
            const modalHTML = `
                <div class="modal fade" id="parametreSecimModal" tabindex="-1" aria-labelledby="parametreSecimModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="parametreSecimModalLabel">
                                    <i class="fas fa-list me-2"></i>
                                    Parametre Seç
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                            </div>
                            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                                <div class="mb-3">
                                    <label for="parametreArama" class="form-label">Parametre Ara:</label>
                                    <input type="text" class="form-control" id="parametreArama" placeholder="Parametre adı yazın...">
                                </div>
                                <div style="max-height: 600px; min-height: 400px; overflow-y: auto;">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th class="text-center" width="50">
                                                    <input type="checkbox" id="tumunuSecParametre" class="form-check-input" onchange="tumunuSecParametre(this)">
                                                </th>
                                                <th class="text-center" width="50">SIRA</th>
                                                <th class="text-center" width="110">KAPSAM</th>
                                                <th>PARAMETRE ADI</th>
                                                <th>METOT</th>
                                                <th class="text-end">BİRİM FİYAT (TL)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="parametreSecimTablosu">
                                            <!-- Parametreler JavaScript ile doldurulacak -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-success" onclick="secilenParametreleriDuzeltmeyeEkle()">
                                    <i class="fas fa-plus me-1"></i>
                                    Seçilenleri Ekle
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal'ı body'ye ekle
            if (!document.getElementById('parametreSecimModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }
            
            // Parametre tablosunu doldur
            createParametreSecimTablosu();
            
            // Arama fonksiyonunu ekle
            const aramaInput = document.getElementById('parametreArama');
            if (aramaInput) {
                aramaInput.addEventListener('input', function() {
                    filterParametreSecim(this.value);
                });
            }
            
            // Modal'ı aç
            const modal = new bootstrap.Modal(document.getElementById('parametreSecimModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Parametreler yüklenirken hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Parametreler yüklenirken hata oluştu.'
            });
        });
}

function createParametreSecimTablosu() {
    const tbody = document.getElementById('parametreSecimTablosu');
    if (!tbody) {
        console.error('Parametre seçim tablosu bulunamadı!');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!asgariFiyatlar || asgariFiyatlar.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <br>Parametreler yükleniyor...
                </td>
            </tr>
        `;
        
        // Parametreleri yeniden yükle
        loadAsgariFiyatlar().then(() => {
            createParametreSecimTablosu();
        });
        return;
    }
    
    let filteredParametreler = asgariFiyatlar.filter(parametre => {
        // Eğer bu parametre zaten düzenleme listesinde varsa gösterme
        return !duzenleParametreler.find(p => p.parametre === parametre.parametre);
    });
    
    if (filteredParametreler.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <br>Eklenebilecek parametre kalmadı
                </td>
            </tr>
        `;
        return;
    }
    
    filteredParametreler.forEach((parametre, index) => {
        const row = document.createElement('tr');
        const kapsamText = (parametre && parametre.kapsam) ? String(parametre.kapsam).toUpperCase().trim() : inferKapsamFromParametre(parametre ? parametre.parametre : '');
        row.innerHTML = `
            <td class="text-center">
                <input type="checkbox" class="form-check-input parametre-secim-checkbox" 
                       value="${parametre.parametre}" data-fiyat="${parametre.fiyat}" data-metot="${parametre.metot}">
            </td>
            <td class="text-center">${index + 1}</td>
            <td class="text-center">${kapsamText}</td>
            <td>${parametre.parametre}</td>
            <td>${parametre.metot}</td>
            <td class="text-end">${(parametre.fiyat || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
        `;
        tbody.appendChild(row);
    });
}

function filterParametreSecim(aramaMetni) {
    const rows = document.querySelectorAll('#parametreSecimTablosu tr');
    const arama = aramaMetni.toLowerCase();
    
    rows.forEach(row => {
        const parametreAdi = (row.cells[3] ? row.cells[3].textContent : '').toLowerCase();
        const metot = (row.cells[4] ? row.cells[4].textContent : '').toLowerCase();
        
        if (parametreAdi.includes(arama) || metot.includes(arama)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function secilenParametreleriDuzeltmeyeEkle() {
    const secilenCheckboxes = document.querySelectorAll('.parametre-secim-checkbox:checked');
    
    if (secilenCheckboxes.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Uyarı!',
            text: 'Lütfen en az bir parametre seçin.'
        });
        return;
    }
    
    // Seçilen parametreleri düzenleme listesine ekle
    secilenCheckboxes.forEach(checkbox => {
        const parametreAdi = checkbox.value;
        const birimFiyat = parseFloat(checkbox.dataset.fiyat);
        const metot = checkbox.dataset.metot;
        
        // Yeni parametreyi düzenleme listesine ekle
        const yeniParametre = {
            parametre: parametreAdi,
            metot: metot,
            birimFiyat: birimFiyat,
            adet: 1, // Varsayılan olarak 1 adet
            topFiyat: birimFiyat
        };
        
        duzenleParametreler.push(yeniParametre);
    });
    
    createDuzenleParametrelerTablosu();
    updateDuzenleOzet();
    
    // Modal'ı kapat
    const modal = bootstrap.Modal.getInstance(document.getElementById('parametreSecimModal'));
    modal.hide();
    
    // Başarı mesajı göster
    Swal.fire({
        icon: 'success',
        title: 'Başarılı!',
        text: `${secilenCheckboxes.length} parametre eklendi.`,
        timer: 1500,
        showConfirmButton: false
    });
}

function tumunuSecParametre(checkbox) {
    const checkboxes = document.querySelectorAll('.parametre-secim-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

function updateDuzenleOzet() {
    const toplam = duzenleParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
    const indirimOrani = parseFloat(document.getElementById('duzenleIndirimOrani').value) || 0;
    const indirimTipi = document.getElementById('duzenleIndirimTipi').value;
    
    let indirim = 0;
    if (indirimOrani > 0) {
        if (indirimTipi === 'TL') {
            indirim = indirimOrani;
        } else if (indirimTipi === '%') {
            indirim = toplam * (indirimOrani / 100);
        }
    }
    
    const netToplam = toplam - indirim;
    
    document.getElementById('duzenleToplam').textContent = toplam.toFixed(2) + ' TL';
    document.getElementById('duzenleIndirim').textContent = indirim.toFixed(2) + ' TL';
    document.getElementById('duzenleNetToplam').textContent = netToplam.toFixed(2) + ' TL';
}

function teklifGuncelle() {
    const teklifId = document.getElementById('duzenleTeklifId').value;
    const teklifTipi = document.getElementById('duzenleTeklifTipi').value;
    const firmaAdi = document.getElementById('duzenleFirmaAdi').value;
    const teklifTarihi = document.getElementById('duzenleTeklifTarihi').value;
    const teklifNo = document.getElementById('duzenleTeklifNo').value;
    const indirimOrani = document.getElementById('duzenleIndirimOrani').value;
    const indirimTipi = document.getElementById('duzenleIndirimTipi').value;
    
    // Validasyon
    if (!teklifTipi || !firmaAdi || !teklifTarihi || !teklifNo) {
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Lütfen tüm zorunlu alanları doldurun.'
        });
        return;
    }
    
    const toplam = duzenleParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
    let indirim = 0;
    if (indirimOrani && indirimTipi) {
        if (indirimTipi === 'TL') {
            indirim = parseFloat(indirimOrani) || 0;
        } else if (indirimTipi === '%') {
            indirim = toplam * (parseFloat(indirimOrani) / 100) || 0;
        }
    }
    const netToplam = toplam - indirim;
    
    const guncelTeklif = {
        id: teklifId,
        teklif_tipi: teklifTipi,
        firma_adi: firmaAdi,
        teklif_tarihi: teklifTarihi,
        teklif_no: teklifNo,
        indirim_orani: indirimOrani,
        indirim_tipi: indirimTipi,
        parametreler: duzenleParametreler,
        toplam: toplam,
        indirim: indirim,
        netToplam: netToplam
    };
    
    fetch('/api/teklif/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(guncelTeklif)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Başarılı!',
                text: 'Teklif başarıyla güncellendi.'
            }).then(() => {
                // Modal'ı kapat
                const modal = bootstrap.Modal.getInstance(document.getElementById('teklifDuzenleModal'));
                modal.hide();
                // Sayfayı yenile
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        Swal.fire({
            icon: 'error',
            title: 'Hata!',
            text: 'Teklif güncellenirken bir hata oluştu.'
        });
    });
}

// Teklif kaydetme fonksiyonunu güncelle - 3. aşama verilerini dahil et
function saveFinalTeklif() {
    // Hangi modda olduğumuzu kontrol et
    const isDuzenlemeModu = editingTeklifId !== null;
    
    if (isDuzenlemeModu) {
        // Düzenleme modunda - güncelle
        const toplam = secilenParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
        
        // İndirim hesapla
        let indirim = 0;
        if (teklifVerileri.indirim_orani && teklifVerileri.indirim_tipi) {
            if (teklifVerileri.indirim_tipi === 'TL') {
                indirim = parseFloat(teklifVerileri.indirim_orani) || 0;
            } else if (teklifVerileri.indirim_tipi === '%') {
                indirim = toplam * (parseFloat(teklifVerileri.indirim_orani) / 100) || 0;
            }
        }
        
        const netToplam = toplam - indirim;
        
        const tamTeklif = {
            id: editingTeklifId,
            ...teklifVerileri,
            parametreler: secilenParametreler,
            toplam: toplam,
            indirim: indirim,
            netToplam: netToplam,
            teklif_durumu: 'BEKLEMEDE'
        };
        
        console.log('Güncellenecek teklif:', tamTeklif);
        
        // API'ye gönder
        fetch('/api/teklif/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tamTeklif)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Rezerve numarayı temizle (düzenleme modunda)
                reservedTeklifNo = null;
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Teklif başarıyla güncellendi.'
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Teklif güncellenirken bir hata oluştu.'
            });
        });
    } else {
        // Yeni teklif modunda - ekle
        const toplam = secilenParametreler.reduce((sum, p) => sum + p.topFiyat, 0);
        
        // İndirim hesapla
        let indirim = 0;
        if (teklifVerileri.indirim_orani && teklifVerileri.indirim_tipi) {
            if (teklifVerileri.indirim_tipi === 'TL') {
                indirim = parseFloat(teklifVerileri.indirim_orani) || 0;
            } else if (teklifVerileri.indirim_tipi === '%') {
                indirim = toplam * (parseFloat(teklifVerileri.indirim_orani) / 100) || 0;
            }
        }
        
        const netToplam = toplam - indirim;
        
        const tamTeklif = {
            ...teklifVerileri,
            parametreler: secilenParametreler,
            toplam: toplam,
            indirim: indirim,
            netToplam: netToplam,
            teklif_durumu: 'BEKLEMEDE'
        };
        
        console.log('Yeni teklif:', tamTeklif);
        
        // API'ye gönder
        fetch('/api/teklif/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tamTeklif)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Rezerve numarayı temizle (yeni teklif modunda)
                reservedTeklifNo = null;
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Teklif başarıyla kaydedildi.'
                }).then(() => {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            Swal.fire({
                icon: 'error',
                title: 'Hata!',
                text: 'Teklif kaydedilirken bir hata oluştu.'
            });
        });
    }
}
</script>
{% endblock %}
