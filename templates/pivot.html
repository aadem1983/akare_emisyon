{% extends 'base.html' %}
{% block title %}PIVOT{% endblock %}
{% block content %}
<div class="py-1">

  <!-- Yıl Seçim Alanı -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label">Yıl 1</label>
          <select id="pvYear1" class="form-select form-select-sm" aria-label="Yıl 1"></select>
        </div>
        <div class="col-auto">
          <label class="form-label">Yıl 2</label>
          <select id="pvYear2" class="form-select form-select-sm" aria-label="Yıl 2"></select>
        </div>
        <div class="col-auto">
          <label class="form-label">Yıl 3</label>
          <select id="pvYear3" class="form-select form-select-sm" aria-label="Yıl 3"></select>
        </div>
        <div class="col-auto">
          <label class="form-label">Yıl 4</label>
          <select id="pvYear4" class="form-select form-select-sm" aria-label="Yıl 4"></select>
        </div>
        <div class="col-auto">
          <label class="form-label">Yıl 5</label>
          <select id="pvYear5" class="form-select form-select-sm" aria-label="Yıl 5"></select>
        </div>
        <div class="col-auto">
          <button id="pvRun" class="btn btn-primary btn-sm"><i class="fas fa-sync me-1"></i>Getir</button>
        </div>
        <div class="col-auto">
          <button id="pvExportXlsx" class="btn btn-success btn-sm"><i class="fas fa-file-excel me-1"></i>Excel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- İçerik alanı -->
  <div id="contentArea">
    <!-- Yıllara Göre Karşılaştırma Tablosu -->
    <div class="card mt-3" id="pvCompareCard">
      <div class="card-body p-0">
      <style>
        #pvYilKiyas {
          font-size: 16px;
        }
        #pvYilKiyas th, #pvYilKiyas td {
          padding: 15px 30px;
          font-size: 16px;
        }
        #pvYilKiyas th:first-child, #pvYilKiyas td:first-child {
          padding-right: 50px;
          min-width: 300px;
        }
        #pvYilKiyas th:nth-child(n+2), #pvYilKiyas td:nth-child(n+2) {
          padding-left: 75px;
          min-width: 120px;
        }
        
        /* Sticky header - TEKLİF TAKİP bölümü sabit kalacak */
        .table-responsive {
          max-height: 70vh;
          overflow-y: auto;
        }
        
        /* Sadece tablo başlığı sticky kalacak */
        #pvYilKiyas thead th {
          position: sticky;
          top: 0;
          background-color: #f8f9fa;
          z-index: 10;
          border-bottom: 2px solid #dee2e6;
        }
        
        /* TEKLİF TAKİP satırını normal scroll yap - sticky kaldırıldı */
        .teklif-takip-header {
          background-color: #e9ecef;
          font-weight: bold;
        }
        
        /* TL sütunları için sağa yaslama */
        #pvYilKiyas td.tl-column {
          text-align: right !important;
        }
        
        /* Adet sütunları için sağa yaslama */
        #pvYilKiyas td.adet-column {
          text-align: right !important;
        }
      </style>
      <div class="table-responsive">
        <table class="table table-sm mb-0 w-auto" id="pvYilKiyas" style="width:auto; white-space:nowrap;">
          <thead><tr id="pvYilHead"><th class="text-start">METRİK</th></tr></thead>
          <tbody id="pvYilBody"></tbody>
        </table>
      </div>
      </div>
    </div>
  </div>
</div>

<script>
  function renderYearSelects(){
    const now = new Date();
    const selects = ['pvYear1','pvYear2','pvYear3','pvYear4','pvYear5'].map(id=>document.getElementById(id));
    const startYear = 2024;
    const endYear = 2040;
    selects.forEach((sel, idx)=>{
      if(!sel) return;
      sel.innerHTML = '';
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = 'Seçiniz';
      sel.appendChild(empty);
      // 2024 en üstte olacak şekilde artan sırada doldur
      for(let y=startYear; y<=endYear; y++){
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if(idx===0 && y===now.getFullYear()) opt.selected = true; // varsayılan: ilk selectte mevcut yıl
        sel.appendChild(opt);
      }
    });
  }

  function tl(v){
    return new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY', maximumFractionDigits:0}).format(v||0);
  }

  async function runCompare(){
    const years = ['pvYear1','pvYear2','pvYear3','pvYear4','pvYear5']
      .map(id=>document.getElementById(id)?.value)
      .filter(y=>y && y.trim() !== '');
    
    if(!years.length) return;
    
    try {
      // 1) Pivot verisini çek
      const res = await fetch('/api/pivot/compare?years='+years.join(','));
      if(!res.ok) return;
      const data = await res.json();
      
      // 2) Asgari fiyatları seçilen her yıl için backend'den çek
      const asgariFiyatlarByYear = {};
      await Promise.all(years.map(async (y)=>{
        try{
          const fr = await fetch(`/api/asgari-fiyatlar/${y}`);
          if(fr.ok){
            const fj = await fr.json();
            // gerçek yanıt: { success, yil, fiyatlar: { PARAM: fiyat, ... } }
            const map = fj && fj.fiyatlar ? fj.fiyatlar : null;
            if(map){
              // Anahtarları normalize et (büyük harf ve trim)
              const norm = {};
              Object.keys(map).forEach(k=>{
                norm[k.toUpperCase().trim()] = Number(map[k]||0);
              });
              asgariFiyatlarByYear[y] = norm;
            }
          }
        }catch(e){
          console.warn('Asgari fiyat çekilemedi:', y, e);
        }
      }));
      

      // Yıllar tablosunu oluştur - önce adet sütunları, sonra TL sütunları
      const head = document.getElementById('pvYilHead');
      const body = document.getElementById('pvYilBody');
      
      // Adet sütunları
      const adetHeaders = years.map(y=>`<th class="text-end">${y} Adet</th>`).join('');
      // TL sütunları  
      const tlHeaders = years.map(y=>`<th class="text-end">${y} TL</th>`).join('');
      
      head.innerHTML = '<th class="text-start">METRİK</th>' + adetHeaders + tlHeaders;
      
      const rows = [];
      function row2(title, adetGetter, tlGetter){
        const adetCols = years.map(y=>{
          const v = adetGetter ? adetGetter(data.data[y]||{}) : '-';
          return `<td class="text-end adet-column">${v ?? '-'}</td>`;
        }).join('');
        const tlCols = years.map(y=>{
          const v = tlGetter ? tlGetter(data.data[y]||{}) : '-';
          if (v === null || v === undefined || v === '-') {
            return `<td class="text-end tl-column">-</td>`;
          }
          return `<td class="text-end tl-column">${Number(v).toFixed(2)}</td>`;
        }).join('');
        rows.push(`<tr><td>${title}</td>${adetCols}${tlCols}</tr>`);
      }
      
      // TEKLİF TAKİP
      rows.push('<tr class="table-light teklif-takip-header"><td colspan="'+(years.length*2+1)+'"><strong>TEKLİF TAKİP</strong></td></tr>');
      // TOP. TEKLİF - adet sütununda sayı, TL sütununda tüm tekliflerin toplam tutarı
      function topTeklifRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.toplam_teklif_adedi || '-'}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const toplamTutari = yearData?.summary?.toplam_teklif_tutari || 0;
          return `<td class="text-end tl-column">${toplamTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>TOP. TEKLİF</td>${adetCols}${tlCols}</tr>`);
      }
      
      topTeklifRow();
      // TOP KABUL OLAN TEK. - adet sütununda sayı, TL sütununda kabul olan tekliflerin toplam tutarı
      function kabulOlanTeklifRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.kabul_adet || '-'}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const kabulTutari = yearData?.summary?.kabul_tutari || 0;
          return `<td class="text-end tl-column">${kabulTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>TOP KABUL OLAN TEK.</td>${adetCols}${tlCols}</tr>`);
      }
      
      kabulOlanTeklifRow();
      
      // KAPSAM İÇİ TEKLİF - adet sütununda sayı, TL sütununda kabul olan kapsam içi tekliflerin tutarı
      function kapsamIciTeklifRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.kapsam_ici_adet || '-'}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const kapsamIciTutari = yearData?.summary?.kapsam_ici_tutar || 0;
          return `<td class="text-end tl-column">${kapsamIciTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>KAPSAM İÇİ TEKLİF</td>${adetCols}${tlCols}</tr>`);
      }
      
      // KAPSAM DIŞI TEKLİF - adet sütununda sayı, TL sütununda kabul olan kapsam dışı tekliflerin tutarı
      function kapsamDisiTeklifRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.kapsam_disi_adet || '-'}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const kapsamDisiTutari = yearData?.summary?.kapsam_disi_tutar || 0;
          return `<td class="text-end tl-column">${kapsamDisiTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>KAPSAM DIŞI TEKLİF</td>${adetCols}${tlCols}</tr>`);
      }
      
      // İŞ BİRLİĞİ TEKLİF - adet sütununda sayı, TL sütununda kabul olan iş birliği tekliflerin tutarı
      function isBirligiTeklifRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.is_birligi_adet || '-'}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const isBirligiTutari = yearData?.summary?.is_birligi_tutar || 0;
          return `<td class="text-end tl-column">${isBirligiTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>İŞ BİRLİĞİ TEKLİF</td>${adetCols}${tlCols}</tr>`);
      }
      
      kapsamIciTeklifRow();
      kapsamDisiTeklifRow();
      isBirligiTeklifRow();
      
      // PARAMETRE
    rows.push('<tr class="table-light"><td colspan="'+(years.length*2+1)+'"><strong>PARAMETRE</strong></td></tr>');
    
    // TOP. BACA SAYISI - TL sütununu 0 bırak
    row2('TOP. BACA SAYISI', d=>d.summary?.toplam_baca_adedi, _=>0);
    row2('TOP. PARAMETRE SAYISI', d=>d.summary?.toplam_parametre_adedi, d=>d.summary?.toplam_parametre_tutari || 0);
    
    // Dinamik parametre sayıları - kabul olan tekliflerden hesapla
    const all_params = new Set();
    years.forEach(year => {
      const yearData = data.data[year];
      if (yearData && yearData.summary && yearData.summary.parametre_sayilari) {
        Object.keys(yearData.summary.parametre_sayilari).forEach(param => {
          all_params.add(param);
        });
      }
    });
    
    // Parametreleri sayıya göre azalan sıraya koy ve göster
    const sorted_params = Array.from(all_params).sort((a, b) => {
      // İlk yıldaki sayılara göre sırala
      const year1Data = data.data[years[0]];
      const countA = year1Data?.summary?.parametre_sayilari?.[a] || 0;
      const countB = year1Data?.summary?.parametre_sayilari?.[b] || 0;
      return countB - countA; // Azalan sıralama
    });
    
    // Yerel fallback asgari fiyat tablosu (örnek: 2025). API başarısız olursa kullanılır.
    const asgariFiyatlarFallback = {
      'TOZ': 6655,
      'YG': 3855,
      'YANMA GAZI': 3855,
      'AMET': 19000,
      'AĞIR METAL': 19000,
      'SÜLF.A': 6290,
      'SÜLFÜRİK ASİT': 6290,
      'VOC': 13170,
      'TOC': 13170,
      'HIZ': 1430,
      'NEM': 1430,
      'HF': 7505,
      'HCL': 7505,
      'AMONYAK': 6645,
      'FORMALDEHİT': 6685,
      'CR+6': 6290,
      'FOSFORİK ASİT': 6290,
      'HCN': 6810,
      'DİOKSİN FURAN': 83950,
      'PAH': 42220,
      'PM10': 7370,
      'ÇÖKEN TOZ': 6640,
      'MODELLEME': 10560
    };

    function normKey(s){
      return String(s||'').toUpperCase().trim();
    }
    
    sorted_params.forEach(param => {
      // Tüm parametreler için özel hesaplama (TL sütununda parametre asgari fiyatı × parametre sayısı)
      function parametreSayisiRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          return `<td class="text-end adet-column">${yearData?.summary?.parametre_sayilari?.[param] || 0}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const paramAdet = yearData?.summary?.parametre_sayilari?.[param] || 0;
          // Prefer backend computed TL (adet × asgari fiyat) if available
          const tlFromBackend = yearData?.parametre_tl?.[param];
          if (tlFromBackend !== undefined && tlFromBackend !== null) {
            return `<td class="text-end tl-column">${Number(tlFromBackend || 0).toFixed(2)}</td>`;
          }
          // Otherwise compute from per-year asgari fiyat map
          const map = asgariFiyatlarByYear?.[String(y)] || {};
          const pkey = normKey(param);
          const paramAsgariFiyat = (map[pkey] !== undefined) ? map[pkey] : (asgariFiyatlarFallback[pkey] || asgariFiyatlarFallback[param] || 0);
          const tl = paramAdet * Number(paramAsgariFiyat || 0);
          return `<td class="text-end tl-column">${tl.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>TOP. ${param} SAYISI</td>${adetCols}${tlCols}</tr>`);
      }
      parametreSayisiRow();
    });
    
    // PERSONEL PERFORMANS
    rows.push('<tr class="table-light"><td colspan="'+(years.length*2+1)+'"><strong>PERSONEL PERFORMANS</strong></td></tr>');
    
    // Dinamik personel performansı - baca bilgileri kayıtlarından gelen personeller
    const all_personel = new Set();
    years.forEach(year => {
      const yearData = data.data[year];
      if (yearData && yearData.summary && yearData.summary.personel_performans) {
        Object.keys(yearData.summary.personel_performans).forEach(personel => {
          all_personel.add(personel);
        });
      }
    });
    
    // Personel performansını göster (Adet sütununda sayı, TL sütununda 0)
    // Personelleri adet sayısına göre azalan sıraya koy
    const sorted_personel = Array.from(all_personel).sort((a, b) => {
      // İlk yıldaki sayılara göre sırala
      const year1Data = data.data[years[0]];
      const countA = year1Data?.summary?.personel_performans?.[a] || 0;
      const countB = year1Data?.summary?.personel_performans?.[b] || 0;
      return countB - countA; // Azalan sıralama
    });
    
    sorted_personel.forEach(personel => {
      function personelPerformansRow() {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          const personelAdet = yearData?.summary?.personel_performans?.[personel] || 0;
          return `<td class="text-end adet-column">${personelAdet}</td>`;
        }).join('');
        
        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const personelTutari = yearData?.summary?.personel_tutarlar?.[personel] || 0;
          return `<td class="text-end tl-column">${personelTutari.toFixed(2)}</td>`;
        }).join('');
        
        rows.push(`<tr><td>${personel} BACA SAYISI</td>${adetCols}${tlCols}</tr>`);
      }
      personelPerformansRow();
    });
    
    // PERSONEL PARAMETRE PERFORMANS
    rows.push('<tr class="table-light"><td colspan="'+(years.length*2+1)+'"><strong>PERSONEL PARAMETRE PERFORMANS</strong></td></tr>');
    
    // Personel parametre kombinasyonlarını topla
    const all_combinations = new Set();
    years.forEach(year => {
      const yearData = data.data[year];
      if (yearData && yearData.summary && yearData.summary.personel_parametre_performans) {
        Object.keys(yearData.summary.personel_parametre_performans).forEach(combination => {
          all_combinations.add(combination);
        });
      }
    });
    
    // Kombinasyonları parametre adına göre grupla
    const parametreGroups = {};
    Array.from(all_combinations).forEach(combination => {
      const [parametre, personel] = combination.split('-');
      if (!parametreGroups[parametre]) {
        parametreGroups[parametre] = [];
      }
      parametreGroups[parametre].push(combination);
    });
    
    // Parametre adlarına göre sırala
    const sortedParametreler = Object.keys(parametreGroups).sort();
    
    // Parametre fiyatlarını almak için yardımcı fonksiyon
    function getParametreFiyati(parametre, year) {
      // Parametre adını eşleştir
      const parametreMap = {
        'TOZ': 'TOZ',
        'YANMA GAZI': 'YANMA GAZI',
        'YG': 'YANMA GAZI',
        'VOC': 'VOC',
        'AĞIR METAL': 'AĞIR METAL',
        'AMET': 'AĞIR METAL',
        'NEM': 'NEM',
        'SÜLFÜRİK ASİT': 'SÜLFÜRİK ASİT',
        'SÜLF.A': 'SÜLFÜRİK ASİT',
        'PM10': 'PM10',
        'ÇT': 'ÇÖKEN TOZ',
        'Çt': 'ÇÖKEN TOZ',
        'CR6': 'CR+6',
        'Cr6': 'CR+6',
        'TOC': 'TOC',
        'HF': 'HF',
        'HCL': 'HCL',
        'AMONYAK': 'AMONYAK',
        'FORMALDEHİT': 'FORMALDEHİT',
        'FOSFORİK ASİT': 'FOSFORİK ASİT',
        'HCN': 'HCN',
        'PAH': 'PAH',
        'DİOKSİN FURAN': 'DİOKSİN FURAN'
      };
      const mapped = (parametreMap[parametre] || parametre || '').toUpperCase().trim();
      // Önce API'den gelen yıla özel haritadan oku
      const apiMap = asgariFiyatlarByYear[year] || {};
      const apiFiyat = apiMap[mapped];
      if(typeof apiFiyat === 'number' && !isNaN(apiFiyat) && apiFiyat > 0){
        return apiFiyat;
      }
      // Fallback yerel tablo
      return asgariFiyatlarFallback[mapped] || 0;
    }

    // Her personel-parametre kombinasyonu için satırları oluştur
    sortedParametreler.forEach(parametre => {
      const combinations = parametreGroups[parametre] || [];
      combinations.forEach(combination => {
        const adetCols = years.map(y=>{
          const yearData = data.data[y];
          const adet = yearData?.summary?.personel_parametre_performans?.[combination] || 0;
          return `<td class="text-end adet-column">${adet}</td>`;
        }).join('');

        const tlCols = years.map(y=>{
          const yearData = data.data[y];
          const adet = yearData?.summary?.personel_parametre_performans?.[combination] || 0;
          const [pname] = String(combination || '').split('-');
          const fiyat = getParametreFiyati(pname, y);
          const toplamFiyat = adet * fiyat;
          return `<td class="text-end tl-column">${toplamFiyat.toFixed(2)}</td>`;
        }).join('');

        rows.push(`<tr><td>${combination}</td>${adetCols}${tlCols}</tr>`);
      });
    });
      
      body.innerHTML = rows.join('');
      
    } catch(e) {
      console.error('Veri yüklenirken hata:', e);
    }
  }

  async function exportToExcel(){
    const years = ['pvYear1','pvYear2','pvYear3','pvYear4','pvYear5']
      .map(id=>document.getElementById(id)?.value)
      .filter(y=>y && y.trim() !== '');
    
    if(years.length === 0) {
      alert('Önce yıl seçin ve veri getirin!');
      return;
    }
    
    // Loading göster
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'excelLoadingOverlay';
    loadingDiv.innerHTML = `
      <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" 
           style="background: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="text-center text-white">
          <div class="spinner-border mb-3" role="status"></div>
          <div>Excel dosyası oluşturuluyor...</div>
        </div>
      </div>
    `;
    document.body.appendChild(loadingDiv);
    
    try {
      // Backend'den XLSX dosyasını al
      const response = await fetch(`/api/pivot/export-xlsx?years=${years.join(',')}`);
      
      if (!response.ok) {
        throw new Error('Excel dosyası oluşturulamadı');
      }
      
      // Dosyayı blob olarak al
      const blob = await response.blob();
      
      // Dosyayı indir
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `PIVOT_Karsilastirma_${years.join('_')}.xlsx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
    } catch (error) {
      console.error('Excel export hatası:', error);
      alert('Excel dosyası oluşturulurken bir hata oluştu!');
    } finally {
      // Loading'i kaldır
      const loadingElement = document.getElementById('excelLoadingOverlay');
      if (loadingElement) {
        document.body.removeChild(loadingElement);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    renderYearSelects();
    document.getElementById('pvRun').addEventListener('click', runCompare);
    document.getElementById('pvExportXlsx').addEventListener('click', exportToExcel);
    ['pvYear1','pvYear2','pvYear3','pvYear4','pvYear5'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.addEventListener('change', runCompare); }
    });
  });
</script>
{% endblock %}